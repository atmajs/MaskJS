(function(t,e){"use strict";var n="undefined"==typeof document?null:document,i=function(){return e(n)};"object"==typeof exports?module.exports=i():"function"==typeof define&&define.amd?define(i):t.mask=i()})(this,function(document){"use strict";function util_extend(t,e){null==t&&(t={});for(var n in e)hasOwnProp.call(e,n)&&(t[n]=e[n]);return t}function util_getProperty(t,e){if("."===e)return t;for(var n=t,i=e.split("."),r=-1,o=i.length;null!=n&&o>++r;)n=n[i[r]];return n}function util_interpolate(t,e,n,i,r,o){var l,s,a,u,c,d=t.length,h=Array(d),f=!0;for(c=0,d=t.length;d>c;c++)f?h[c]=t[c]:(u=t[c],s=null,a=u.indexOf(":"),~a?(l=a>0?u.substring(0,a).replace(regexpWhitespace,""):"",""===l&&(l="condition"),u=u.substring(a+1),"function"==typeof ModelUtils[l]&&(s=ModelUtils[l](u,e,n,i,r,o))):s=util_getProperty(e,u),h[c]=null==s?"":s),f=!f;return h}function util_createInterpolateFunction(t){for(var e="#{",n="}",i=2,r=[],o=0,l=0,s=0,a=0;(o=t.indexOf(e,o))>-1;)a=t.indexOf(n,o+i),-1!==a?(o>l&&(r[s]=t.substring(l,o),s++),o===l&&(r[s]="",s++),r[s]=t.substring(o+i,a),s++,l=o=a+1):o+=i;return t.length>l&&(r[s]=t.substring(l)),t=null,function(t,e,n,i,o){return util_interpolate(r,t,e,n,i,o)}}function Template(t){this.template=t,this.index=0,this.length=t.length}function Node(t,e){this.tagName=t,this.parent=e,this.attr={},this.__single=null,this.type=1}function TextNode(t,e){this.content=t,this.parent=e,this.next=null,this.type=1}function Fragment(){this.type=3}function Component(){}function builder_build(t,e,n,i,r){if(null==t)return n;null==n&&(n=create_container()),null==r&&(r=new Component);for(var o=null,l=n,s=[t],a=0;null!=t;)if(1===t.type&&(l=create_node(t,e,l,i,r)),null==l||null==t.first){for(;null!=o;){if(null!=o.current){t=o.current,o.current=o.current.next,a--;break}t.current=null,t=o=o.parent}l=s[a]}else o=t,t=t.current=t.first,o.current=t.next,s[++a]=l;return n}function create_container(){return document.createDocumentFragment()}function create_node(t,e,n,i,r){var o,l,s,a=t.tagName,u=t.attr,c=t.first;if(null!=CustomTags[a]){var d=CustomTags[a],h="function"==typeof d?new d(e):d;if(h.compoName=a,h.first=c,h.attr=util_extend(h.attr,u),h.parent=r,h.render(e,n,i),r.append(h),null!=listeners){var f=listeners.compoCreated;if(null!=f)for(o=0,l=f.length;l>o;o++)f[o](child,e,n)}return null}if(null!=t.content){var p=t.content;if("function"!=typeof p)return n.appendChild(document.createTextNode(p)),null;var g=p(e,"node",i,n),m="";for(o=0,l=g.length;l>o;o++)s=g[o],"object"==typeof s&&(""!==m&&(n.appendChild(document.createTextNode(m)),m=""),n.appendChild(s)),m+=s;return""!==m&&n.appendChild(document.createTextNode(m)),null}var v,b,C=document.createElement(a);for(v in u)hasOwnProp.call(u,v)!==!1&&(b="function"==typeof u[v]?u[v](e,"attr",i,C,v).join(""):u[v],b&&(hasOwnProp.call(CustomAttributes,v)===!0?CustomAttributes[v](t,e,b,C,i):C.setAttribute(v,b)));return n.appendChild(C),C}function create_elementsContainer(){return{elements:[],appendChild:function(t){this.elements.push(t)}}}var regexpWhitespace=/\s/g,regexpEscapedChar={"'":/\\'/g,'"':/\\"/g,"{":/\\\{/g,">":/\\>/g,";":/\\>/g},regexpTabsAndNL=/[\t\n\r]{1,}/g,regexpMultipleSpaces=/ {2,}/g,hasOwnProp={}.hasOwnProperty,listeners=null;Template.prototype={skipWhitespace:function(){for(var t=this.template,e=this.index,n=this.length;n>e&&!(t.charCodeAt(e)>32);e++);return this.index=e,this},skipToAttributeBreak:function(){var t,e=this.template,n=this.index,i=this.length;do if(t=e.charCodeAt(++n),35===t&&123===e.charCodeAt(n+1))return this.index=n,this.sliceToChar("}"),this.index++,void 0;while(46!==t&&35!==t&&62!==t&&123!==t&&32!==t&&59!==t&&i>n);this.index=n},sliceToChar:function(t){for(var e,n,i=this.template,r=this.index,o=r,l=!1;(n=i.indexOf(t,r))>-1&&(r=n,92===i.charCodeAt(r-1));)l=!0,r++;return e=i.substring(o,r),this.index=r,l?e.replace(regexpEscapedChar[t],t):e}};var ConditionUtil=function(){function t(t,e){var n,i=e,r=t.index;if(null==i&&(t.skipWhitespace(),r=t.index,e=i=t.template.charCodeAt(t.index)),34===i||39===i)return t.index++,n=t.sliceToChar(39===i?"'":'"'),t.index++,n;do i=t.template.charCodeAt(++t.index);while(t.index<t.length&&32!==i&&33!==i&&60!==i&&61!==i&&62!==i&&40!==i&&41!==i&&38!==i&&124!==i);return n=t.template.substring(r,t.index),i=e,45===i||i>47&&58>i?n-0:116===i&&"true"===n?!0:102===i&&"false"===n?!1:{value:n}}function e(n,i){var r,o={assertions:null,join:null,left:null,right:null};for(null==i&&(i=[]),"string"==typeof n&&(n=new Template(n));;){if(n.skipWhitespace(),n.index>=n.length)break;switch(r=n.template.charCodeAt(n.index)){case 61:case 60:case 62:case 33:var l=n.index;do r=n.template.charCodeAt(++n.index);while(n.index<n.length&&(60===r||61===r||62===r));o.sign=n.template.substring(l,n.index);continue;case 38:case 124:n.template.charCodeAt(++n.index)!==r&&console.error("Unary operation not valid"),o.join=38===r?"&&":"||",i.push(o),o={assertions:null,join:null,left:null,right:null},++n.index;continue;case 40:n.index++,e(n,o.assertions=[]);break;case 41:n.index++;break;default:o[null==o.left?"left":"right"]=t(n,r);continue}}return(o.left||o.assertions)&&i.push(o),i}function n(n){if(null!=r[n])return r[n];var i=n.length,o={},l=n.indexOf("?"),s=new Template(n);return l>-1&&(s.length=l),o.assertions=e(s),s.length=i,s.index=l+1,o.case1=t(s),s.skipWhitespace(),58===s.template.charCodeAt(s.index)&&(s.index++,o.case2=t(s)),r[n]=o}function i(t,e){"string"==typeof t&&(t=n(t).assertions),null!=t.assertions&&(t=t.assertions);var r,o,l,s,a,u=!1;for(s=0,a=t.length;a>s;s++){if(r=t[s],r.assertions)u=i(r.assertions,e);else if(o="object"==typeof r.left?util_getProperty(e,r.left.value):r.left,null==r.right)u=!!o,"!"===r.sign&&(u=!u);else switch(l="object"==typeof r.right?util_getProperty(e,r.right.value):r.right,r.sign){case"<":u=l>o;break;case"<=":u=l>=o;break;case">":u=o>l;break;case">=":u=o>=l;break;case"!=":u=o!==l;break;case"==":u=o===l}if(u===!0){if("&&"===r.join)continue;break}if("||"!==r.join)break}return u}var r=[];return{condition:function(t,e){var r=n(t),o=i(r.assertions,e)?r.case1:r.case2;return null==o?"":"object"==typeof o&&o.value?util_getProperty(e,o.value):o},isCondition:i,parse:n,out:{isCondition:i,parse:n}}}(),ModelUtils={condition:ConditionUtil.condition},CustomAttributes={},CustomTags={};Node.prototype={first:null,last:null,next:null,previous:null,current:null,append:function(t){null==this.first&&(this.first=t),null!=this.last&&(this.last.next=t,t.previuos=this.last),this.last=t}},Fragment.prototype=Node.prototype,Component.defineCompo=function(t,e){e.prototype.__proto__=ComponentProto};var ComponentProto=Component.prototype={constructor:Component,compoName:null,attr:null,model:null,elements:null,first:null,last:null,next:null,parent:null,firstCompo:null,lastCompo:null,previousCompo:null,nextCompo:null,type:4,process:function(t,e,n){var i;i=null!=this.tagName&&this.tagName!==this.compoName?this:this.first,this.elements=[],builder_build(i,t,e,n,this)},append:function(t){null==this.firstCompo&&(this.firstCompo=t),null!=this.lastCompo&&(this.lastCompo.nextCompo=t,node.previuosCompo=this.lastCompo),this.lastCompo=t}},Parser=function(t,e,n){function i(t,e){null==t.first&&(t.first=e),null!=t.last&&(t.last.next=e,e.previuos=t.last),t.last=e}function r(t){return-1===t.indexOf("#{")?t:_serialize!==!0?util_createInterpolateFunction(t):{template:t}}return{parse:function(o){for(var l,s=new n,a=s,u=2,c=3,d=null,h=null,f=null,p=null,g=0,m=o.length,v=2,b=3,C=5,y=8,x=9;;)if(m>g&&33>(l=o.charCodeAt(g)))g++;else{if(c===C&&null!=d&&(s.attr["class"]=r(d),d=null),null!=h){if(u===C)null==f?f=h:p=h,null!=f&&null!=p&&("class"!==f?s.attr[f]=p:d=null==d?p:d+" "+p,f=null,p=null);else if(c===b)i(s,s=new t(h,s)),u=C;else if(c===y){if(i(s,new e(h,s)),s.__single===!0)for(;null!=(s=s.parent)&&null!=s.__single;);u=v}h=null}if(g>=m){u===C&&null!=d&&(s.attr["class"]=r(d));break}if(u===x){for(s=s.parent;null!=s&&null!=s.__single;)s=s.parent;u=v}if(123!==l)if(62!==l)if(59!==l||null==s.nodes)if(59!==l&&125!==l)if(39!==l&&34!==l)if(u!==v||(c=b,u=b,46!==l&&35!==l))if(u!==C||(46===l&&(g++,f="class"),35===l&&(g++,f="id"),61!==l)){for(var _=g,w=null;m>g;){if(l=o.charCodeAt(g),35===l&&123===o.charCodeAt(g+1)){w=!0,++g;do l=o.charCodeAt(++g);while(125!==l&&m>g)}if(46===l||35===l||62===l||123===l||33>l||59===l||61===l)break;g++}h=o.substring(_,g),w===!0&&(u===C&&"class"===f)==!1&&(h=util_createInterpolateFunction(h))}else g++;else h="div";else{u!==C&&(c=u=y),g++;for(var p,k,_=g,A=!1,P=39===l?"'":'"';(k=o.indexOf(P,g))>-1&&(g=k,92===o.charCodeAt(k-1));)A=!0,g++;h=o.substring(_,g),A===!0&&(h=h.replace(regexpEscapedChar[P],P)),-1!==h.indexOf("#{")&&(h=util_createInterpolateFunction(h)),g++}else g++,c=u,u=x;else g++;else c=u,u=v,g++,s.__single=!0;else c=u,u=v,g++}return a},cleanObject:function(t){if(t instanceof Array){for(var e=0;t.length>e;e++)this.cleanObject(t[e]);return t}return delete t.parent,delete t.__single,null!=t.nodes&&this.cleanObject(t.nodes),t}}}(Node,TextNode,Fragment),cache={},Mask={render:function(t,e,n,i,r){return"string"==typeof t&&(t=this.compile(t)),builder_build(t,e,n,i,r)},compile:function(t){return hasOwnProp.call(cache,t)?cache[t]:cache[t]=Parser.parse(t)},registerHandler:function(t,e){CustomTags[t]=e},getHandler:function(t){return null!=t?CustomTags[t]:CustomTags},registerAttrHandler:function(t,e){CustomAttributes[t]=e},registerUtility:function(t,e){ModelUtils[t]=e},serialize:function(t){return Parser.cleanObject(this.compile(t,!0))},deserialize:function(t){var e,n,i;if(t instanceof Array){for(e=0;t.length>e;e++)this.deserialize(t[e]);return t}if(null!=t.content)return null!=t.content.template&&(t.content=Parser.toFunction(t.content.template)),t;if(null!=t.attr){i=t.attr;for(n in i)if(hasOwnProp.call(i,n)===!0){if(null==i[n].template)continue;i[n]=Parser.toFunction(i[n].template)}}return null!=t.nodes&&this.deserialize(t.nodes),t},clearCache:function(t){"string"==typeof t?delete cache[t]:cache={}},ValueUtils:{condition:ConditionUtil.condition,out:ConditionUtil},Utils:{Condition:ConditionUtil,getProperty:util_getProperty},plugin:function(source){eval(source)},on:function(t,e){null==listeners&&(listeners={}),(listeners[t]||(listeners[t]=[])).push(e)},delegateReload:function(){}};return Mask.renderDom=Mask.render,function(t){function e(){}function n(t,e,n,i){var r,o,l,s=t.attr,a=s.template,u=util_getProperty(e,s.foreach);if(!(u instanceof Array))return n;if(null!=a&&(r=document.querySelector(a).innerHTML,t.firstNode=Mask.compile(r)),null==t.first)return n;for(o=0,l=u.length;l>o;o++)builder_build(t.first,u[o],n,i,t);return n}t.registerHandler("%",e),e.prototype={constructor:e,render:function(t,e,i){var r=this.attr;if(null!=r["if"]){var o=r["if"];return this.state=ConditionUtil.isCondition(o,t),this.state&&builder_build(this.nodes,t,e,i,this),void 0}if(null!=r["else"]){var l=this.parent.components,s=l&&l[l.length-2];return null!=s&&"%"==s.compoName&&null!=s.attr["if"]?(s.state===!1&&builder_build(this.nodes,t,e,i,this),void 0):(console.error("Previous Node should be \"% if='condition'\""),void 0)}if(null!=r.use)return builder_build(this.nodes,util_getProperty(t,r.use),e,i,this),void 0;if(null==r["debugger"]){if(null!=r.log){var a=r.log,u=util_getProperty(t,a);return console.log("Key: %s, Value: %s",a,u),void 0}r.foreach&&n(this,t,e,i)}}},Component.defineCompo("%",e)}(Mask),function(t){function e(){}function n(){}var i={};t.templates=i,t.registerHandler(":template",e),e.prototype.render=function(){return null!=this.attr.id?(console.warn("Template Should be defined with ID attribute for future lookup"),void 0):(i[this.attr.id]=this,void 0)},t.registerHandler(":html",n),n.prototype.render=function(t,e){var n=null;null!=this.attr.source&&(n=document.getElementById(this.attr.source).innerHTML),this.firstChild&&(n=this.firstChild.content),null==n&&console.warn("No HTML for node",this);var i=document.createElement("div");i.innerHTML=n;for(var r in this.attr)i.setAttribute(r,this.attr[r]);e.appendChild(i)}}(Mask),function(t){function e(t,e){for(var n=0,i=e.length-1;i>n;n++){var r=e.shift();null==t[r]&&(t[r]={}),t=t[r]}return t}function n(t,e){if(null==e)return t;null==t&&(t={});for(var n in e)t[n]=e[n];return t}function i(t,e){for(var n=e.split("."),i=n.length,r=0;i>r;r++){if(null==t)return null;t=t[n[r]]}return t}function r(t,e,n){for(var i=e.split("."),r=i.length,o=0,l=null;r-1>o;o++)l=i[o],null==t[l]&&(t[l]={}),t=t[l];t[i[o]]=n}function o(t,n,i){null==t.__observers&&Object.defineProperty(t,"__observers",{value:{},enumerable:!1});var r=t.__observers[n]||(t.__observers[n]=[]),o=n.split("."),l=o.length>1?e(t,o):t,s=o[0],a=l[s];r.push(i),Object.defineProperty(l,s,{get:function(){return a},set:function(t){a=t;for(var e=0,n=r.length;n>e;e++)r[e](t)}})}function l(t,e){function n(n){t[n]=function(){Array.prototype[n].apply(this,arguments),e(this,n,arguments)}}Object.defineProperty(t,"hasObserver",{value:!0,enumerable:!1,writable:!1});for(var i=0,r=["push","unshift","splice","pop","shift","reverse","sort"],o=r.length;o>i;i++)n(r[i])}function s(t,e,n){return"function"==typeof g?(g(t).on(e,n),void 0):null!=t.addEventListener?(t.addEventListener(e,n,!1),void 0):(t.attachEvent&&t.attachEvent("on"+e,n),void 0)}function a(){}function u(){}function c(t,e,i,r){if(this.constructor==c){var l=i.attr.bindingProvider||e.tagName.toLowerCase();if(m[l]instanceof Function)return new m[l](t,e,i);n(this,m[l])}return null==r&&(r=":bind"===i.compoName?"single":"dual"),this.node=i,this.model=t,this.element=e,this.property=i.attr.property||("single"===r?"element.innerHTML":"element.value"),this.setter=i.attr.setter,this.getter=i.attr.getter,this.dismiss=0,o(t,i.attr.value,this.objectChanged.bind(this)),"single"!==r&&s(e,i.attr.changeEvent||"change",this.domChanged.bind(this)),this.objectChanged(),this}function d(){}function h(){}function f(t,e){if(null==e&&(e=[]),null==t.components)return e;for(var n,i=t.components,r=0,o=i.length;o>r;r++)n=i[r],"validate"!==n.compoName?f(n):e.push(n);return e}function p(t,e){return null==t?null:"function"==typeof t[e]?t[e].bind(t):p(t.parent,e)}var g=window.jQuery||window.Zepto||window.$;null==g&&console.warn("Without jQuery/Zepto etc. binder is limited (mouse dom event bindings)"),t.registerHandler(":visible",a),a.prototype={constructor:a,refresh:function(e,n){n.style.display=t.Util.Condition.isCondition(this.attr.check,e)?"":"none"},render:function(e,n,i){this.refresh(e,n),this.attr.bind&&o(e,this.attr.bind,this.refresh.bind(this,e,n)),this.firstChild&&t.render(this.firstChild,e,n,i)}},t.registerHandler(":bind",u),u.prototype.render=function(e,n,i){null!=this.firstChild&&t.render(this.firstChild,e,n,i),new c(e,n,this,"single")},t.registerUtility("bind",function(t,e,n,r,l,s){var a=i(e,t);switch(n){case"node":var u=document.createTextNode(a);return o(e,t,function(t){u.textContent=t}),u;case"attr":return o(e,t,function(t){var e=l.getAttribute(s);l.setAttribute(s,e.replace(a,t)),a=t}),a}return console.error("Unknown binding type",arguments),"Unknown"});var m={};t.registerBinding=function(t,e){m[t]=e},t.BindingProvider=c,c.prototype={constructor:c,objectChanged:function(t){this.dismiss-->0||(null==t&&(t=this.objectWay.get(this.model,this.node.attr.value)),this.domWay.set(this,t),t instanceof Array&&t.hasObserver!==!0&&l(t,this.objectChanged.bind(this)))},domChanged:function(){var t=this.domWay.get(this);if(this.node.validations)for(var e,n=0,i=this.node.validations.length;i>n;n++)if(e=this.node.validations[n],e.validate(t,this.element,this.objectChanged.bind(this))===!1)return;this.dismiss=1,this.objectWay.set(this.model,this.node.attr.value,t),this.dismiss=0},objectWay:{get:function(e,n){return":"===n[0]?t.Util.ConditionUtil.condition(n.substring(1)):i(e,n)},set:function(t,e,n){r(t,e,n)}},domWay:{get:function(t){return t.getter?t.node.parent[t.getter]():i(t,t.property)},set:function(t,e){t.setter?t.node.parent[t.setter](e):r(t,t.property,e)}}},t.registerHandler(":dualbind",d),d.prototype.render=function(e,n,i){if(this.firstChild&&t.render(this.firstChild,e,n,i),i.components)for(var r,o=0,l=i.components.length;l>o;o++)r=i.components[o],":validate"==r.compoName&&(this.validations||(this.validations=[])).push(r);new c(e,n,this)},function(){function e(){}function n(t,e,n){console.warn("Validate Notification:",t,e);var i=g(t).next(".-validate-invalid");0===i.length&&(i=g("<div>").addClass("-validate-invalid").html("<span></span><button>cancel</button>").insertAfter(t)),i.children("button").off().on("click",function(){i.hide(),n&&n()}).end().children("span").text(e).end().show()}function r(t){g(t).next(".-validate-invalid").hide()}t.registerValidator=function(t,e){o[t]=e},t.registerHandler(":validate",e),e.prototype={constructor:e,render:function(t,e){this.element=e,this.model=t},validate:function(t,e,o){null==e&&(e=this.element),this.attr.getter&&(t=i({node:this,element:e},this.attr.getter)),null==this.validators&&this.initValidators();for(var l,s=0,a=this.validators.length;a>s;s++)if(l=this.validators[s],l.validate(this,t)===!1)return n(e,this.message,o),!1;return r(e),!0},initValidators:function(){this.validators=[],this.message=this.attr.message,delete this.attr.message;for(var t in this.attr)if(t in o!=!1){var e=o[t];"function"==typeof e&&(e=new e(this)),this.validators.push(e)}else console.error("Unknown Validator:",t,this)}};var o={match:{validate:function(t,e){return RegExp(t.attr.match).test(e)}},unmatch:{validate:function(t,e){return!RegExp(t.attr.unmatch).test(e)}},minLength:{validate:function(t,e){return e.length>=parseInt(t.attr.minLength,10)}},maxLength:{validate:function(t,e){return e.length<=parseInt(t.attr.maxLength,10)}},check:{validate:function(){}}}}(),t.registerHandler(":validate:group",h),h.prototype={constructor:h,render:function(e,n,i){this.firstChild&&t.render(this.firstChild,e,n,i)},validate:function(){for(var t,e=f(this),n=0,i=e.length;i>n;n++)if(t=e[n],!t.validate())return!1;return!0}},t.registerAttrHandler("x-on",function(t,e,n,i,r){for(var o,l=n.split(";"),a=0,u=l.length;u>a;a++){o=l[a];var c=o.substring(0,o.indexOf(":")),d=o.substring(o.indexOf(":")+1).trim(),h=p(r,d);h&&s(i,c,h)}})}(Mask),Mask});