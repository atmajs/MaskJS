(function(e,t){"use strict";var n="undefined"==typeof document?null:document,i=function(){return t(n)};"object"==typeof exports?module.exports=i():"function"==typeof define&&define.amd?define(i):e.mask=i()})(this,function(document){"use strict";function util_extend(e,t){null==e&&(e={});for(var n in t)hasOwnProp.call(t,n)&&(e[n]=t[n]);return e}function util_getProperty(e,t){if("."===t)return e;for(var n=e,i=t.split("."),r=-1,l=i.length;null!=n&&l>++r;)n=n[i[r]];return n}function util_interpolate(e,t,n,i,r,l){var o,s,a,u,c,d=e.length,p=Array(d),f=!0;for(c=0,d=e.length;d>c;c++)f?p[c]=e[c]:(u=e[c],s=null,a=u.indexOf(":"),~a?(o=a>0?u.substring(0,a).replace(regexpWhitespace,""):"",""===o&&(o="condition"),u=u.substring(a+1),s="function"==typeof ModelUtils[o]?ModelUtils[o](u,t,n,i,r,l):null):s=util_getProperty(t,u),p[c]=null==s?"":s),f=!f;return p}function Template(e){this.template=e,this.index=0,this.length=e.length}function ICustomTag(){this.attr={}}function builder_build(e,t,n,i){if(null==e)return n;null==n&&(n=document.createDocumentFragment()),null==i&&(i={});do{var r=createNode(e,t,n,i);null!=e.firstChild&&this.build(e.firstChild,t,r,i)}while(null!=(e=e.nextNode));return n}function createNode(e,t,n,i){var r,l;if(null!=CustomTags.all[e.tagName]){var o=CustomTags.all[e.tagName],s=o instanceof Function?new o(t):o;if(s.compoName=e.tagName,s.nodes=e.nodes,s.attr=util_extend(s.attr,e.attr),(i.components||(i.components=[])).push(s),s.parent=i,null!=listeners){var a=listeners.customCreated;if(null!=a)for(r=0,l=a.length;l>r;r++)a[r](s,t,n)}return s.render(t,n,s),null}if(null!=e.content){if("function"==typeof e.content){var u=e.content(t,"node",i,n),c="";for(r=0,l=u.length;l>r;r++)"object"!=typeof u[r]?c+=u[r]:(""!==c&&(n.appendChild(document.createTextNode(c)),c=""),n.appendChild(u[r]));""!==c&&n.appendChild(document.createTextNode(c))}else n.appendChild(document.createTextNode(e.content));return null}var d=document.createElement(e.tagName),p=e.attr;for(var f in p)if(hasOwnProp.call(p,f)===!0){var h;h="function"==typeof p[f]?p[f](t,"attr",i,d,f).join(""):p[f],h&&(null!=CustomAttributes[f]?CustomAttributes[f](e,t,h,d,i):d.setAttribute(f,h))}return n.appendChild(d),d}var regexpWhitespace=/\s/g,regexpEscapedChar={"'":/\\'/g,'"':/\\"/g,"{":/\\\{/g,">":/\\>/g,";":/\\>/g},regexpTabsAndNL=/[\t\n\r]{1,}/g,regexpMultipleSpaces=/ {2,}/g,hasOwnProp={}.hasOwnProperty,listeners=null;Template.prototype={next:function(){return this.index++,this},skipWhitespace:function(){for(var e=this.template,t=this.index,n=this.length;n>t&&32===e.charCodeAt(t);t++);return this.index=t,this},skipToChar:function(e){var t,n=this.template;do t=n.indexOf(e,this.index);while(~t&&92!==n.charCodeAt(t-1));return this.index=t,this},skipToAttributeBreak:function(){var e,t=this.template,n=this.index,i=this.length;do if(e=t.charCodeAt(++n),35===e&&123===t.charCodeAt(n+1))return this.index=n,this.sliceToChar("}"),this.index++,void 0;while(46!==e&&35!==e&&62!==e&&123!==e&&32!==e&&59!==e&&i>n);return this.index=n,this},sliceToChar:function(e){for(var t,n,i=this.template,r=this.index,l=r,o=!1;(n=i.indexOf(e,r))>-1&&(r=n,92===i.charCodeAt(r-1));)o=!0,r++;return t=i.substring(l,r),this.index=r,o?t.replace(regexpEscapedChar[e],e):t}},ICustomTag.prototype.render=function(e,t){return builder_build(this.firstChild,e,t)};var CustomTags=function(){function e(){this.attr={}}function t(){this.attr={}}function n(){this.attr={}}var i=ICustomTag.prototype.render;return e.prototype.render=function(e,t,n){var i,r,l,o,s=this.attr,a=s.template,u=util_getProperty(e,s.value);if(!(u instanceof Array))return t;if(null!=a&&(r=document.querySelector(a).innerHTML,this.nodes=i=Mask.compile(r)),null==this.firstChild)return t;for(l=0,o=u.length;o>l;l++)builder_build(this.firstChild,u[l],t,n);return t},t.prototype.render=function(e,t,n){return ConditionUtil.isCondition(this.attr.check,e)?i.call(this,e,t,n):t},n.prototype.render=function(){var e,t,i=Object.defineProperty,r=!1;if(i)try{r=Object.defineProperty({},"x",{get:function(){return!0}}).x}catch(l){r=!1}else Object.prototype.__defineGetter__&&(i=function(e,t,n){hasOwnProp.call(n,"get")&&e.__defineGetter__(t,n.get),hasOwnProp.call(n,"set")&&e.__defineSetter__(t,n.set)},r=!0);return r||(e=[],i=function(t,n,i){var r,l,o,s=!1;for(l=0,o=e.length;o>l;l++)if(r=e[l],r.obj===t){s=!0;break}s||(r=e[l]={obj:t,props:{}}),r.props[n]={value:t[n],set:i.set}},t=function(){var n,i,r,l,o,s,a;for(i=0,r=e.length;r>i;i++){n=e[i],l=n.props;for(o in l)hasOwnProp.call(l,o)&&(s=l[o],a=n.obj[o],a!==s.value&&s.set.call(null,a))}setTimeout(t,16)},t()),(n.prototype.render=function(e,t){var n=this.attr.value,r=e[n];return i.call(Object,e,n,{get:function(){return r},set:function(e){t.innerHTML=r=e}}),t.innerHTML=r,t}).apply(this,arguments)},{all:{list:e,visible:t,bind:n}}}(),CustomAttributes={},ConditionUtil=function(){function e(e,t){var n,i=t,r=e.index;if(null==i&&(e.skipWhitespace(),r=e.index,t=i=e.template.charCodeAt(e.index)),34===i||39===i)return e.index++,n=e.sliceToChar(39===i?"'":'"'),e.index++,n;do i=e.template.charCodeAt(++e.index);while(e.index<e.length&&32!==i&&33!==i&&60!==i&&61!==i&&62!==i&&40!==i&&41!==i&&38!==i&&124!==i);return n=e.template.substring(r,e.index),i=t,45===i||i>47&&58>i?n-0:116===i&&"true"===n?!0:102===i&&"false"===n?!1:{value:n}}function t(n,i){var r,l={};for(null==i&&(i=[]),"string"==typeof n&&(n=new Template(n));;){if(n.skipWhitespace(),n.index>=n.length)break;switch(r=n.template.charCodeAt(n.index)){case 61:case 60:case 62:case 33:var o=n.index;do r=n.template.charCodeAt(++n.index);while(n.index<n.length&&(60===r||61===r||62===r));l.sign=n.template.substring(o,n.index);continue;case 38:case 124:n.template.charCodeAt(++n.index)!==r&&console.error("Unary operation not valid"),l.join=38===r?"&&":"||",i.push(l),l={},++n.index;continue;case 40:n.index++,t(n,l.assertions=[]);break;case 41:n.index++;break;default:l[null==l.left?"left":"right"]=e(n,r);continue}}return(l.left||l.assertions)&&i.push(l),i}function n(n){if(null!=r[n])return r[n];var i=n.length,l={},o=n.indexOf("?"),s=new Template(n);return o>-1&&(s.length=o),l.assertions=t(s),s.length=i,s.index=o+1,l.case1=e(s),s.skipWhitespace(),58===s.template.charCodeAt(s.index)&&(s.index++,l.case2=e(s)),r[n]=l}function i(e,t){"string"==typeof e&&(e=n(e).assertions),null!=e.assertions&&(e=e.assertions);var r,l,o,s,a,u=!1;for(s=0,a=e.length;a>s;s++){if(r=e[s],r.assertions)u=i(r.assertions,t);else if(l="object"==typeof r.left?util_getProperty(t,r.left.value):r.left,null==r.right)u=!!l,"!"===r.sign&&(u=!u);else switch(o="object"==typeof r.right?util_getProperty(t,r.right.value):r.right,r.sign){case"<":u=o>l;break;case"<=":u=o>=l;break;case">":u=l>o;break;case">=":u=l>=o;break;case"!=":u=l!==o;break;case"==":u=l===o}if(u===!0){if("&&"===r.join)continue;break}if("||"!==r.join)break}return u}var r=[];return{condition:function(e,t){var r=n(e),l=i(r.assertions,t)?r.case1:r.case2;return null==l?"":"object"==typeof l&&l.value?util_getProperty(t,l.value):l},isCondition:i,parse:n,out:{isCondition:i,parse:n}}}(),ModelUtils={condition:ConditionUtil.condition},Parser={toFunction:function(e){for(var t="#{",n="}",i=2,r=[],l=0,o=0,s=0,a=0;(l=e.indexOf(t,l))>-1;)a=e.indexOf(n,l+i),-1!==a?(l>o&&(r[s]=e.substring(o,l),s++),l===o&&(r[s]="",s++),r[s]=e.substring(l+i,a),s++,o=l=a+1):l+=i;return e.length>o&&(r[s]=e.substring(o)),e=null,function(e,t,n,i,l){return util_interpolate(r,e,t,n,i,l)}},parseAttributes:function(e,t){var n,i,r,l,o,s=e.template;null==t.attr&&(t.attr={});e:for(;e.index<e.length;){switch(n=null,i=null,l=s.charCodeAt(e.index)){case 32:e.index++;continue;case 123:case 59:case 62:break e;case 46:o=e.index+1,e.skipToAttributeBreak(),i=s.substring(o,e.index),r=null!=r?r+" "+i:i;break;case 35:n="id",o=e.index+1,e.skipToAttributeBreak(),i=s.substring(o,e.index);break;default:n=this.parseAttributeValue(e),61!==s.charCodeAt(e.index)?i=n:(e.index++,e.skipWhitespace(),i=this.parseAttributeValue(e))}null!=n&&(i.indexOf("#{")>-1&&(i=e.serialize!==!0?this.toFunction(i):{template:i}),t.attr[n]=i)}null!=r&&(t.attr["class"]=r.indexOf("#{")>-1?e.serialize!==!0?this.toFunction(r):{template:r}:r)},parseAttributeValue:function(e){var t,n=e.template.charCodeAt(e.index);if(34===n||39===n)return e.index++,t=e.sliceToChar(34===n?'"':"'"),e.index++,t;var i=e.index;do n=e.template.charCodeAt(++e.index);while(61!==n&&32!==n&&123!==n&&62!==n&&59!==n&&e.index<e.length);return t=e.template.substring(i,e.index),32===n&&e.skipWhitespace(),t},parse:function(e){for(var t=e;e.index<e.length;e.index++){var n=e.template.charCodeAt(e.index);switch(n){case 32:continue;case 39:case 34:e.index++;var i=e.sliceToChar(39===n?"'":'"');i.indexOf("#{")>-1&&(i=e.serialize!==!0?this.toFunction(i):{template:i});var r={content:i};if(null==t.nodes?t.nodes=r:null==t.nodes.push?t.nodes=[t.nodes,r]:t.nodes.push(r),t.__single){if(null==t)continue;for(t=t.parent;null!=t&&null!=t.__single;)t=t.parent}continue;case 62:t.__single=!0;continue;case 123:continue;case 59:if(null!=t.nodes)continue;case 125:if(null==t)continue;do t=t.parent;while(null!=t&&null!=t.__single);continue}var l=null;if(46===n||35===n)l="div";else{var o=e.index;do n=e.template.charCodeAt(++e.index);while(32!==n&&35!==n&&46!==n&&59!==n&&123!==n&&62!==n&&e.index<=e.length);l=e.template.substring(o,e.index)}""===l&&console.error("Parse Error: Undefined tag Name %d/%d %s",e.index,e.length,e.template.substring(e.index,e.index+10));var s={tagName:l,parent:t};null==t&&console.log("T",e,"rest",e.template.substring(e.index)),null==t.nodes?t.nodes=s:null==t.nodes.push?t.nodes=[t.nodes,s]:t.nodes.push(s),t=s,this.parseAttributes(e,t),e.index--}return e.nodes},cleanObject:function(e){if(e instanceof Array){for(var t=0;e.length>t;t++)this.cleanObject(e[t]);return e}return delete e.parent,delete e.__single,null!=e.nodes&&this.cleanObject(e.nodes),e}},cache={},Mask={render:function(e,t,n,i){return"string"==typeof e&&(e=this.compile(e)),builder_build(e,t,n,i)},compile:function(e,t){if(hasOwnProp.call(cache,e))return cache[e];var n=new Template(e.replace(regexpTabsAndNL,"").replace(regexpMultipleSpaces," "));return t===!0&&(n.serialize=!0),cache[e]=Parser.parse(n)},registerHandler:function(e,t){CustomTags.all[e]=t},getHandler:function(e){return null!=e?CustomTags.all[e]:CustomTags.all},registerAttrHandler:function(e,t){CustomAttributes[e]=t},registerUtility:function(e,t){ModelUtils[e]=t},serialize:function(e){return Parser.cleanObject(this.compile(e,!0))},deserialize:function(e){var t,n,i;if(e instanceof Array){for(t=0;e.length>t;t++)this.deserialize(e[t]);return e}if(null!=e.content)return null!=e.content.template&&(e.content=Parser.toFunction(e.content.template)),e;if(null!=e.attr){i=e.attr;for(n in i)if(hasOwnProp.call(i,n)===!0){if(null==i[n].template)continue;i[n]=Parser.toFunction(i[n].template)}}return null!=e.nodes&&this.deserialize(e.nodes),e},clearCache:function(e){"string"==typeof e?delete cache[e]:cache={}},ICustomTag:ICustomTag,ValueUtils:{condition:ConditionUtil.condition,out:ConditionUtil},Utils:{Condition:ConditionUtil,getProperty:util_getProperty},plugin:function(source){eval(source)},on:function(e,t){null==listeners&&(listeners={}),(listeners[e]||(listeners[e]=[])).push(t)},delegateReload:function(){}};return Mask.renderDom=Mask.render,Mask});