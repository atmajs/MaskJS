(function(e,t){"use strict";var n="undefined"==typeof document?null:document,i=function(){return t(n)};"object"==typeof exports?module.exports=i():"function"==typeof define&&define.amd?define(i):e.mask=i()})(this,function(document){"use strict";function Template(e){this.template=e,this.index=0,this.length=e.length}function ICustomTag(){this.attr={}}var regexpWhitespace=/\s/g,regexpEscapedChar={"'":/\\'/g,'"':/\\"/g,"{":/\\\{/g,">":/\\>/g,";":/\\>/g},regexpTabsAndNL=/[\t\n\r]{1,}/g,regexpMultipleSpaces=/ {2,}/g,hasOwnProp={}.hasOwnProperty,listeners=null,Helper={extend:function(e,t){null==e&&(e={});for(var n in t)hasOwnProp.call(t,n)&&(e[n]=t[n]);return e},getProperty:function(e,t){if("."===t)return e;for(var n=e,i=t.split("."),r=-1,o=i.length;null!=n&&o>++r;)n=n[i[r]];return n},interpolate:function(e,t,n,i,r,o){var s,l,a,u,c,d=e.length,p=Array(d),f=!0;for(c=0,d=e.length;d>c;c++)f?p[c]=e[c]:(u=e[c],l=null,a=u.indexOf(":"),~a?(s=a>0?u.substring(0,a).replace(regexpWhitespace,""):"",""===s&&(s="condition"),u=u.substring(a+1),l="function"==typeof ModelUtils[s]?ModelUtils[s](u,t,n,i,r,o):null):l=Helper.getProperty(t,u),p[c]=null==l?"":l),f=!f;return p},templateFunction:function(e,t){var n,i,r,o,s,l,a="",u=!0;for(s=0,l=e.length;l>s;s++)u?a+=e[s]:(o=e[s],i=null,r=o.indexOf(":"),~r?(n=r>0?o.substring(0,r).replace(regexpWhitespace,""):"",""===n&&(n="condition"),o=o.substring(r+1),i="function"==typeof ModelUtils[n]?ModelUtils[n](o,t):null):i=Helper.getProperty(t,o),a+=null==i?"":i),u=!u;return a}};Template.prototype={next:function(){return this.index++,this},skipWhitespace:function(){for(var e=this.template,t=this.index,n=this.length;n>t&&32===e.charCodeAt(t);t++);return this.index=t,this},skipToChar:function(e){var t,n=this.template;do t=n.indexOf(e,this.index);while(~t&&92!==n.charCodeAt(t-1));return this.index=t,this},skipToAttributeBreak:function(){var e,t=this.template,n=this.index,i=this.length;do if(e=t.charCodeAt(++n),35===e&&123===t.charCodeAt(n+1))return this.index=n,this.sliceToChar("}"),this.index++,void 0;while(46!==e&&35!==e&&62!==e&&123!==e&&32!==e&&59!==e&&i>n);return this.index=n,this},sliceToChar:function(e){for(var t,n,i=this.template,r=this.index,o=r,s=!1;(n=i.indexOf(e,r))>-1&&(r=n,92===i.charCodeAt(r-1));)s=!0,r++;return t=i.substring(o,r),this.index=r,s?t.replace(regexpEscapedChar[e],e):t}},ICustomTag.prototype.render=function(e,t){return Builder.build(this.nodes,e,t)};var CustomTags=function(){function e(){this.attr={}}function t(){this.attr={}}function n(){this.attr={}}var i=ICustomTag.prototype.render;return e.prototype.render=function(e,t,n){var i,r,o,s,l=this.attr,a=l.template,u=Helper.getProperty(e,l.value);if(!(u instanceof Array))return t;if(null!=a&&(r=document.querySelector(a).innerHTML,this.nodes=i=Mask.compile(r)),null==this.nodes)return t;for(o=0,s=u.length;s>o;o++)Builder.build(this.nodes,u[o],t,n);return t},t.prototype.render=function(e,t,n){return ConditionUtil.isCondition(this.attr.check,e)?i.call(this,e,t,n):t},n.prototype.render=function(){var e,t,i=Object.defineProperty,r=!1;if(i)try{r=Object.defineProperty({},"x",{get:function(){return!0}}).x}catch(o){r=!1}else Object.prototype.__defineGetter__&&(i=function(e,t,n){hasOwnProp.call(n,"get")&&e.__defineGetter__(t,n.get),hasOwnProp.call(n,"set")&&e.__defineSetter__(t,n.set)},r=!0);return r||(e=[],i=function(t,n,i){var r,o,s,l=!1;for(o=0,s=e.length;s>o;o++)if(r=e[o],r.obj===t){l=!0;break}l||(r=e[o]={obj:t,props:{}}),r.props[n]={value:t[n],set:i.set}},t=function(){var n,i,r,o,s,l,a;for(i=0,r=e.length;r>i;i++){n=e[i],o=n.props;for(s in o)hasOwnProp.call(o,s)&&(l=o[s],a=n.obj[s],a!==l.value&&l.set.call(null,a))}setTimeout(t,16)},t()),(n.prototype.render=function(e,t){var n=this.attr.value,r=e[n];return i.call(Object,e,n,{get:function(){return r},set:function(e){t.innerHTML=r=e}}),t.innerHTML=r,t}).apply(this,arguments)},{all:{list:e,visible:t,bind:n}}}(),CustomAttributes={},ConditionUtil=function(){function e(e,t){var n,i=t,r=e.index;if(null==i&&(e.skipWhitespace(),r=e.index,t=i=e.template.charCodeAt(e.index)),34===i||39===i)return e.index++,n=e.sliceToChar(39===i?"'":'"'),e.index++,n;do i=e.template.charCodeAt(++e.index);while(e.index<e.length&&32!==i&&33!==i&&60!==i&&61!==i&&62!==i&&40!==i&&41!==i&&38!==i&&124!==i);return n=e.template.substring(r,e.index),i=t,45===i||i>47&&58>i?n-0:116===i&&"true"===n?!0:102===i&&"false"===n?!1:{value:n}}function t(n,i){var r,o={};for(null==i&&(i=[]),"string"==typeof n&&(n=new Template(n));;){if(n.skipWhitespace(),n.index>=n.length)break;switch(r=n.template.charCodeAt(n.index)){case 61:case 60:case 62:case 33:var s=n.index;do r=n.template.charCodeAt(++n.index);while(n.index<n.length&&(60===r||61===r||62===r));o.sign=n.template.substring(s,n.index);continue;case 38:case 124:n.template.charCodeAt(++n.index)!==r&&console.error("Unary operation not valid"),o.join=38===r?"&&":"||",i.push(o),o={},++n.index;continue;case 40:n.index++,t(n,o.assertions=[]);break;case 41:n.index++;break;default:o[null==o.left?"left":"right"]=e(n,r);continue}}return(o.left||o.assertions)&&i.push(o),i}function n(n){if(null!=r[n])return r[n];var i=n.length,o={},s=n.indexOf("?"),l=new Template(n);return s>-1&&(l.length=s),o.assertions=t(l),l.length=i,l.index=s+1,o.case1=e(l),l.skipWhitespace(),58===l.template.charCodeAt(l.index)&&(l.index++,o.case2=e(l)),r[n]=o}function i(e,t){"string"==typeof e&&(e=n(e).assertions),null!=e.assertions&&(e=e.assertions);var r,o,s,l,a,u=!1;for(l=0,a=e.length;a>l;l++){if(r=e[l],r.assertions)u=i(r.assertions,t);else if(o="object"==typeof r.left?Helper.getProperty(t,r.left.value):r.left,null==r.right)u=!!o,"!"===r.sign&&(u=!u);else switch(s="object"==typeof r.right?Helper.getProperty(t,r.right.value):r.right,r.sign){case"<":u=s>o;break;case"<=":u=s>=o;break;case">":u=o>s;break;case">=":u=o>=s;break;case"!=":u=o!==s;break;case"==":u=o===s}if(u===!0){if("&&"===r.join)continue;break}if("||"!==r.join)break}return u}var r=[];return{condition:function(e,t){var r=n(e),o=i(r.assertions,t)?r.case1:r.case2;return null==o?"":"object"==typeof o&&o.value?Helper.getProperty(t,o.value):o},isCondition:i,parse:n,out:{isCondition:i,parse:n}}}(),ModelUtils={condition:ConditionUtil.condition},Parser={toFunction:function(e){for(var t="#{",n="}",i=2,r=[],o=0,s=0,l=0,a=0;(o=e.indexOf(t,o))>-1;)a=e.indexOf(n,o+i),-1!==a?(o>s&&(r[l]=e.substring(s,o),l++),o===s&&(r[l]="",l++),r[l]=e.substring(o+i,a),l++,s=o=a+1):o+=i;return e.length>s&&(r[l]=e.substring(s)),e=null,function(e,t,n,i,o){return Helper.interpolate(r,e,t,n,i,o)}},parseAttributes:function(e,t){var n,i,r,o,s,l=e.template;null==t.attr&&(t.attr={});e:for(;e.index<e.length;){switch(n=null,i=null,o=l.charCodeAt(e.index)){case 32:e.index++;continue;case 123:case 59:case 62:break e;case 46:s=e.index+1,e.skipToAttributeBreak(),i=l.substring(s,e.index),r=null!=r?r+" "+i:i;break;case 35:n="id",s=e.index+1,e.skipToAttributeBreak(),i=l.substring(s,e.index);break;default:n=this.parseAttributeValue(e),61!==l.charCodeAt(e.index)?i=n:(e.index++,e.skipWhitespace(),i=this.parseAttributeValue(e))}null!=n&&(i.indexOf("#{")>-1&&(i=e.serialize!==!0?this.toFunction(i):{template:i}),t.attr[n]=i)}null!=r&&(t.attr["class"]=r.indexOf("#{")>-1?e.serialize!==!0?this.toFunction(r):{template:r}:r)},parseAttributeValue:function(e){var t,n=e.template.charCodeAt(e.index);if(34===n||39===n)return e.index++,t=e.sliceToChar(34===n?'"':"'"),e.index++,t;var i=e.index;do n=e.template.charCodeAt(++e.index);while(61!==n&&32!==n&&123!==n&&62!==n&&59!==n&&e.index<e.length);return t=e.template.substring(i,e.index),32===n&&e.skipWhitespace(),t},parse:function(e){for(var t=e;e.index<e.length;e.index++){var n=e.template.charCodeAt(e.index);switch(n){case 32:continue;case 39:case 34:e.index++;var i=e.sliceToChar(39===n?"'":'"');i.indexOf("#{")>-1&&(i=e.serialize!==!0?this.toFunction(i):{template:i});var r={content:i};if(null==t.nodes?t.nodes=r:null==t.nodes.push?t.nodes=[t.nodes,r]:t.nodes.push(r),t.__single){if(null==t)continue;for(t=t.parent;null!=t&&null!=t.__single;)t=t.parent}continue;case 62:t.__single=!0;continue;case 123:continue;case 59:if(null!=t.nodes)continue;case 125:if(null==t)continue;do t=t.parent;while(null!=t&&null!=t.__single);continue}var o=null;if(46===n||35===n)o="div";else{var s=e.index;do n=e.template.charCodeAt(++e.index);while(32!==n&&35!==n&&46!==n&&59!==n&&123!==n&&62!==n&&e.index<=e.length);o=e.template.substring(s,e.index)}""===o&&console.error("Parse Error: Undefined tag Name %d/%d %s",e.index,e.length,e.template.substring(e.index,e.index+10));var l={tagName:o,parent:t};null==t&&console.log("T",e,"rest",e.template.substring(e.index)),null==t.nodes?t.nodes=l:null==t.nodes.push?t.nodes=[t.nodes,l]:t.nodes.push(l),t=l,this.parseAttributes(e,t),e.index--}return e.nodes},cleanObject:function(e){if(e instanceof Array){for(var t=0;e.length>t;t++)this.cleanObject(e[t]);return e}return delete e.parent,delete e.__single,null!=e.nodes&&this.cleanObject(e.nodes),e}},Builder={build:function(e,t,n,i){if(null==e)return n;null==n&&(n=document.createDocumentFragment()),null==i&&(i={});var r,o,s,l,a=e instanceof Array,u=a===!0?e.length:1;for(r=0;u>r;r++)if(o=a===!0?e[r]:e,null==CustomTags.all[o.tagName])if(null==o.content){var c=document.createElement(o.tagName),d=o.attr;for(var p in d)if(hasOwnProp.call(d,p)===!0){var f;f="function"==typeof d[p]?d[p](t,"attr",i,c,p).join(""):d[p],f&&(null!=CustomAttributes[p]?CustomAttributes[p](o,t,f,c,i):c.setAttribute(p,f))}null!=o.nodes&&this.build(o.nodes,t,c,i),n.appendChild(c)}else if("function"==typeof o.content){var h=o.content(t,"node",i,n),g="";for(s=0,l=h.length;l>s;s++)"object"!=typeof h[s]?g+=h[s]:(""!==g&&(n.appendChild(document.createTextNode(g)),g=""),n.appendChild(h[s]));""!==g&&n.appendChild(document.createTextNode(g))}else n.appendChild(document.createTextNode(o.content));else{var x=CustomTags.all[o.tagName],m=x instanceof Function?new x(t):x;if(m.compoName=o.tagName,m.nodes=o.nodes,m.attr=Helper.extend(m.attr,o.attr),(i.components||(i.components=[])).push(m),m.parent=i,null!=listeners){var b=listeners.customCreated;if(null!=b)for(s=0,l=b.length;l>s;s++)b[s](m,t,n)}m.render(t,n,m)}return n}},cache={},Mask={render:function(e,t,n,i){return"string"==typeof e&&(e=this.compile(e)),Builder.build(e,t,n,i)},compile:function(e,t){if(hasOwnProp.call(cache,e))return cache[e];var n=new Template(e.replace(regexpTabsAndNL,"").replace(regexpMultipleSpaces," "));return t===!0&&(n.serialize=!0),cache[e]=Parser.parse(n)},registerHandler:function(e,t){CustomTags.all[e]=t},getHandler:function(e){return null!=e?CustomTags.all[e]:CustomTags.all},registerAttrHandler:function(e,t){CustomAttributes[e]=t},registerUtility:function(e,t){ModelUtils[e]=t},serialize:function(e){return Parser.cleanObject(this.compile(e,!0))},deserialize:function(e){var t,n,i;if(e instanceof Array){for(t=0;e.length>t;t++)this.deserialize(e[t]);return e}if(null!=e.content)return null!=e.content.template&&(e.content=Parser.toFunction(e.content.template)),e;if(null!=e.attr){i=e.attr;for(n in i)if(hasOwnProp.call(i,n)===!0){if(null==i[n].template)continue;i[n]=Parser.toFunction(i[n].template)}}return null!=e.nodes&&this.deserialize(e.nodes),e},clearCache:function(e){"string"==typeof e?delete cache[e]:cache={}},ICustomTag:ICustomTag,ValueUtils:{condition:ConditionUtil.condition,out:ConditionUtil},Utils:{Condition:ConditionUtil,getProperty:Helper.getProperty},plugin:function(source){eval(source)},on:function(e,t){null==listeners&&(listeners={}),(listeners[e]||(listeners[e]=[])).push(t)},delegateReload:function(){}};return Mask.renderDom=Mask.render,Mask});