(function(e,t){"use strict";var n="undefined"==typeof document?null:document,i=function(){return t(n)};"object"==typeof exports?module.exports=i():"function"==typeof define&&define.amd?define(i):e.mask=i()})(this,function(document){"use strict";function util_extend(e,t){null==e&&(e={});for(var n in t)hasOwnProp.call(t,n)&&(e[n]=t[n]);return e}function util_getProperty(e,t){if("."===t)return e;for(var n=e,i=t.split("."),r=-1,l=i.length;null!=n&&l>++r;)n=n[i[r]];return n}function util_interpolate(e,t,n,i,r,l){var a,o,s,u,c,d=e.length,f=Array(d),p=!0;for(c=0,d=e.length;d>c;c++)p?f[c]=e[c]:(u=e[c],o=null,s=u.indexOf(":"),~s?(a=s>0?u.substring(0,s).replace(regexpWhitespace,""):"",""===a&&(a="condition"),u=u.substring(s+1),"function"==typeof ModelUtils[a]&&(o=ModelUtils[a](u,t,n,i,r,l))):o=util_getProperty(t,u),f[c]=null==o?"":o),p=!p;return f}function Template(e){this.template=e,this.index=0,this.length=e.length}function ICustomTag(){this.attr={}}function builder_build(e,t,n,i){if(null==e)return n;null==n&&(n=create_container()),null==i&&(i={components:null});do{var r=create_node(e,t,n,i);null!=r&&null!=e.firstChild&&builder_build(e.firstChild,t,r,i)}while(null!=(e=e.nextNode));return n}function create_container(){return document.createDocumentFragment()}function create_node(e,t,n,i){var r,l,a;if(null!=CustomTags.all[e.tagName]){var o=CustomTags.all[e.tagName],s="function"==typeof o?new o(t):o;if(s.compoName=e.tagName,s.firstChild=e.firstChild,s.attr=util_extend(s.attr,e.attr),(i.components||(i.components=[])).push(s),s.parent=i,null!=listeners){var u=listeners.customCreated;if(null!=u)for(r=0,l=u.length;l>r;r++)u[r](s,t,n)}return s.render(t,n,s),null}if(null!=e.content){if("function"!=typeof e.content)return n.appendChild(document.createTextNode(e.content)),null;var c=e.content(t,"node",i,n),d="";for(r=0,l=c.length;l>r;r++)a=c[r],"object"==typeof a&&(""!==d&&(n.appendChild(document.createTextNode(d)),d=""),n.appendChild(a)),d+=a;return""!==d&&n.appendChild(document.createTextNode(d)),null}var f,p,h=document.createElement(e.tagName),g=e.attr;for(f in g)hasOwnProp.call(g,f)!==!1&&(p="function"==typeof g[f]?g[f](t,"attr",i,h,f).join(""):g[f],p&&(hasOwnProp.call(CustomAttributes,f)===!0?CustomAttributes[f](e,t,p,h,i):h.setAttribute(f,p)));return n.appendChild(h),h}var regexpWhitespace=/\s/g,regexpEscapedChar={"'":/\\'/g,'"':/\\"/g,"{":/\\\{/g,">":/\\>/g,";":/\\>/g},regexpTabsAndNL=/[\t\n\r]{1,}/g,regexpMultipleSpaces=/ {2,}/g,hasOwnProp={}.hasOwnProperty,listeners=null;Template.prototype={skipWhitespace:function(){for(var e=this.template,t=this.index,n=this.length;n>t&&32===e.charCodeAt(t);t++);return this.index=t,this},skipToAttributeBreak:function(){var e,t=this.template,n=this.index,i=this.length;do if(e=t.charCodeAt(++n),35===e&&123===t.charCodeAt(n+1))return this.index=n,this.sliceToChar("}"),this.index++,void 0;while(46!==e&&35!==e&&62!==e&&123!==e&&32!==e&&59!==e&&i>n);this.index=n},sliceToChar:function(e){for(var t,n,i=this.template,r=this.index,l=r,a=!1;(n=i.indexOf(e,r))>-1&&(r=n,92===i.charCodeAt(r-1));)a=!0,r++;return t=i.substring(l,r),this.index=r,a?t.replace(regexpEscapedChar[e],e):t}},ICustomTag.prototype.render=function(e,t){return builder_build(this.firstChild,e,t)};var CustomTags=function(){function e(){this.attr={}}function t(){this.attr={}}function n(){this.attr={}}var i=ICustomTag.prototype.render;return e.prototype.render=function(e,t,n){var i,r,l,a=this.attr,o=a.template,s=util_getProperty(e,a.value);if(!(s instanceof Array))return t;if(null!=o&&(i=document.querySelector(o).innerHTML,this.firstNode=Mask.compile(i)),null==this.firstChild)return t;for(r=0,l=s.length;l>r;r++)builder_build(this.firstChild,s[r],t,n);return t},t.prototype.render=function(e,t,n){return ConditionUtil.isCondition(this.attr.check,e)?i.call(this,e,t,n):t},n.prototype.render=function(){var e,t,i=Object.defineProperty,r=!1;if(i)try{r=Object.defineProperty({},"x",{get:function(){return!0}}).x}catch(l){r=!1}else Object.prototype.__defineGetter__&&(i=function(e,t,n){hasOwnProp.call(n,"get")&&e.__defineGetter__(t,n.get),hasOwnProp.call(n,"set")&&e.__defineSetter__(t,n.set)},r=!0);return r||(e=[],i=function(t,n,i){var r,l,a,o=!1;for(l=0,a=e.length;a>l;l++)if(r=e[l],r.obj===t){o=!0;break}o||(r=e[l]={obj:t,props:{}}),r.props[n]={value:t[n],set:i.set}},t=function(){var n,i,r,l,a,o,s;for(i=0,r=e.length;r>i;i++){n=e[i],l=n.props;for(a in l)hasOwnProp.call(l,a)&&(o=l[a],s=n.obj[a],s!==o.value&&o.set.call(null,s))}setTimeout(t,16)},t()),(n.prototype.render=function(e,t){var n=this.attr.value,r=e[n];return i.call(Object,e,n,{get:function(){return r},set:function(e){t.innerHTML=r=e}}),t.innerHTML=r,t}).apply(this,arguments)},{all:{list:e,visible:t,bind:n}}}(),CustomAttributes={},ConditionUtil=function(){function e(e,t){var n,i=t,r=e.index;if(null==i&&(e.skipWhitespace(),r=e.index,t=i=e.template.charCodeAt(e.index)),34===i||39===i)return e.index++,n=e.sliceToChar(39===i?"'":'"'),e.index++,n;do i=e.template.charCodeAt(++e.index);while(e.index<e.length&&32!==i&&33!==i&&60!==i&&61!==i&&62!==i&&40!==i&&41!==i&&38!==i&&124!==i);return n=e.template.substring(r,e.index),i=t,45===i||i>47&&58>i?n-0:116===i&&"true"===n?!0:102===i&&"false"===n?!1:{value:n}}function t(n,i){var r,l={};for(null==i&&(i=[]),"string"==typeof n&&(n=new Template(n));;){if(n.skipWhitespace(),n.index>=n.length)break;switch(r=n.template.charCodeAt(n.index)){case 61:case 60:case 62:case 33:var a=n.index;do r=n.template.charCodeAt(++n.index);while(n.index<n.length&&(60===r||61===r||62===r));l.sign=n.template.substring(a,n.index);continue;case 38:case 124:n.template.charCodeAt(++n.index)!==r&&console.error("Unary operation not valid"),l.join=38===r?"&&":"||",i.push(l),l={},++n.index;continue;case 40:n.index++,t(n,l.assertions=[]);break;case 41:n.index++;break;default:l[null==l.left?"left":"right"]=e(n,r);continue}}return(l.left||l.assertions)&&i.push(l),i}function n(n){if(null!=r[n])return r[n];var i=n.length,l={},a=n.indexOf("?"),o=new Template(n);return a>-1&&(o.length=a),l.assertions=t(o),o.length=i,o.index=a+1,l.case1=e(o),o.skipWhitespace(),58===o.template.charCodeAt(o.index)&&(o.index++,l.case2=e(o)),r[n]=l}function i(e,t){"string"==typeof e&&(e=n(e).assertions),null!=e.assertions&&(e=e.assertions);var r,l,a,o,s,u=!1;for(o=0,s=e.length;s>o;o++){if(r=e[o],r.assertions)u=i(r.assertions,t);else if(l="object"==typeof r.left?util_getProperty(t,r.left.value):r.left,null==r.right)u=!!l,"!"===r.sign&&(u=!u);else switch(a="object"==typeof r.right?util_getProperty(t,r.right.value):r.right,r.sign){case"<":u=a>l;break;case"<=":u=a>=l;break;case">":u=l>a;break;case">=":u=l>=a;break;case"!=":u=l!==a;break;case"==":u=l===a}if(u===!0){if("&&"===r.join)continue;break}if("||"!==r.join)break}return u}var r=[];return{condition:function(e,t){var r=n(e),l=i(r.assertions,t)?r.case1:r.case2;return null==l?"":"object"==typeof l&&l.value?util_getProperty(t,l.value):l},isCondition:i,parse:n,out:{isCondition:i,parse:n}}}(),ModelUtils={condition:ConditionUtil.condition},Parser=function(){function e(e){for(var t="#{",n="}",i=2,r=[],l=0,a=0,o=0,s=0;(l=e.indexOf(t,l))>-1;)s=e.indexOf(n,l+i),-1!==s?(l>a&&(r[o]=e.substring(a,l),o++),l===a&&(r[o]="",o++),r[o]=e.substring(l+i,s),o++,a=l=s+1):l+=i;return e.length>a&&(r[o]=e.substring(a)),e=null,function(e,t,n,i,l){return util_interpolate(r,e,t,n,i,l)}}function t(e,t){null==e.firstChild&&(e.firstChild=t),null!=e.lastChild&&(e.lastChild.nextNode=t),e.lastChild=t}return{parseAttributes:function(t,n){var i,r,l,a,o,s=t.template;e:for(;t.index<t.length;){switch(i=null,r=null,a=s.charCodeAt(t.index)){case 32:t.index++;continue;case 123:case 59:case 62:break e;case 46:o=t.index+1,t.skipToAttributeBreak(),r=s.substring(o,t.index),l=null!=l?l+" "+r:r;break;case 35:i="id",o=t.index+1,t.skipToAttributeBreak(),r=s.substring(o,t.index);break;default:i=this.parseAttributeValue(t),61!==s.charCodeAt(t.index)?r=i:(t.index++,t.skipWhitespace(),r=this.parseAttributeValue(t))}null!=i&&(r.indexOf("#{")>-1&&(r=t.serialize!==!0?e(r):{template:r}),n.attr[i]=r)}null!=l&&(n.attr["class"]=l.indexOf("#{")>-1?t.serialize!==!0?e(l):{template:l}:l)},parseAttributeValue:function(e){var t,n=e.template.charCodeAt(e.index);if(34===n||39===n)return e.index++,t=e.sliceToChar(34===n?'"':"'"),e.index++,t;var i=e.index;do n=e.template.charCodeAt(++e.index);while(61!==n&&32!==n&&123!==n&&62!==n&&59!==n&&e.index<e.length);return t=e.template.substring(i,e.index),32===n&&e.skipWhitespace(),t},parse:function(n){for(var i=n;n.index<n.length;n.index++){var r=n.template.charCodeAt(n.index);switch(r){case 32:continue;case 39:case 34:n.index++;var l=n.sliceToChar(39===r?"'":'"');l.indexOf("#{")>-1&&(l=n.serialize!==!0?e(l):{template:l});var a={content:l,parent:i,nextNode:null,firstChild:null};if(t(i,a),i.__single){if(null==i)continue;for(i=i.parent;null!=i&&null!=i.__single;)i=i.parent}continue;case 62:i.__single=!0;continue;case 123:continue;case 59:if(null!=i.firstChild)continue;case 125:if(null==i)continue;do i=i.parent;while(null!=i&&null!=i.__single);continue}var o=null;if(46===r||35===r)o="div";else{var s=n.index;do r=n.template.charCodeAt(++n.index);while(32!==r&&35!==r&&46!==r&&59!==r&&123!==r&&62!==r&&n.index<=n.length);o=n.template.substring(s,n.index)}""===o&&console.error("Parse Error: Undefined tag Name %d/%d %s",n.index,n.length,n.template.substring(n.index,n.index+10));var u={tagName:o,parent:i,firstChild:null,lastChild:null,currentNode:null,nextNode:null,attr:{},__single:null};null==i&&console.log("T",n,"rest",n.template.substring(n.index)),t(i,u),i=u,this.parseAttributes(n,i),n.index--}return n.firstChild},cleanObject:function(e){if(e instanceof Array){for(var t=0;e.length>t;t++)this.cleanObject(e[t]);return e}return delete e.parent,delete e.__single,null!=e.nodes&&this.cleanObject(e.nodes),e}}}(),cache={},Mask={render:function(e,t,n,i){return"string"==typeof e&&(e=this.compile(e)),builder_build(e,t,n,i)},compile:function(e,t){if(hasOwnProp.call(cache,e))return cache[e];var n=new Template(e.replace(regexpTabsAndNL,"").replace(regexpMultipleSpaces," "));return t===!0&&(n.serialize=!0),cache[e]=Parser.parse(n)},registerHandler:function(e,t){CustomTags.all[e]=t},getHandler:function(e){return null!=e?CustomTags.all[e]:CustomTags.all},registerAttrHandler:function(e,t){CustomAttributes[e]=t},registerUtility:function(e,t){ModelUtils[e]=t},serialize:function(e){return Parser.cleanObject(this.compile(e,!0))},deserialize:function(e){var t,n,i;if(e instanceof Array){for(t=0;e.length>t;t++)this.deserialize(e[t]);return e}if(null!=e.content)return null!=e.content.template&&(e.content=Parser.toFunction(e.content.template)),e;if(null!=e.attr){i=e.attr;for(n in i)if(hasOwnProp.call(i,n)===!0){if(null==i[n].template)continue;i[n]=Parser.toFunction(i[n].template)}}return null!=e.nodes&&this.deserialize(e.nodes),e},clearCache:function(e){"string"==typeof e?delete cache[e]:cache={}},ICustomTag:ICustomTag,ValueUtils:{condition:ConditionUtil.condition,out:ConditionUtil},Utils:{Condition:ConditionUtil,getProperty:util_getProperty},plugin:function(source){eval(source)},on:function(e,t){null==listeners&&(listeners={}),(listeners[e]||(listeners[e]=[])).push(t)},delegateReload:function(){}};return Mask.renderDom=Mask.render,Mask});