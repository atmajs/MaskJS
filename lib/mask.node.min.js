(function(n,e){"use strict";null==n&&"undefined"!=typeof global&&(n=global);var t="undefined"==typeof document?null:document,r=function(r){null==r&&(r={});var o,l=e(n,t,r);for(o in r)l[o]=r[o];return l};if("object"==typeof exports)module.exports=r();else if("function"==typeof define&&define.amd)define(r);else{var o={},l=r(o);n.mask=l;for(var i in o)n[i]=o[i]}})(this,function(global,document,exports){"use strict";function util_extend(n,e){null==n&&(n={});for(var t in e)hasOwnProp.call(e,t)!==!1&&(n[t]=e[t]);return n}function util_getProperty(n,e){if("."===e)return n;for(var t=n,r=e.split("."),o=-1,l=r.length;null!=t&&l>++o;)t=t[r[o]];return t}function util_interpolate(n,e,t,r,o,l,i){for(var s,u,a,c,f=n.length,p=0,d=null,h="",g=!0;f>p;p++)g===!0?null==d?h+=n[p]:d.push(n[p]):(c=n[p],u=null,a=c.indexOf(":"),-1===a?u=util_getProperty(t,c):(s=a>0?c.substring(0,a).replace(regexpWhitespace,""):"",""===s&&(s="expression"),c=c.substring(a+1),"function"==typeof ModelUtils[s]&&(u=ModelUtils[s](c,t,r,o,l,i,e))),null!=u&&("object"==typeof u&&null==d&&(d=[h]),null==d?h+=u:d.push(u))),g=!g;return null==d?h:d}function Template(n){this.template=n,this.index=0,this.length=n.length}function Node(n,e){this.type=Dom.NODE,this.tagName=n,this.parent=e,this.attr={}}function TextNode(n,e){this.content=n,this.parent=e,this.type=Dom.TEXTNODE}function Fragment(){this.nodes=[]}function Component(n,e,t){this.tagName=n,this.parent=e,this.controller=t,this.attr={}}var regexpWhitespace=/\s/g,regexpEscapedChar={"'":/\\'/g,'"':/\\"/g,"{":/\\\{/g,">":/\\>/g,";":/\\>/g},hasOwnProp={}.hasOwnProperty,listeners=null;Template.prototype={skipWhitespace:function(){for(var n=this.template,e=this.index,t=this.length;t>e&&!(n.charCodeAt(e)>32);e++);return this.index=e,this},skipToAttributeBreak:function(){var n,e=this.template,t=this.index,r=this.length;do if(n=e.charCodeAt(++t),35===n&&123===e.charCodeAt(t+1))return this.index=t,this.sliceToChar("}"),this.index++,void 0;while(46!==n&&35!==n&&62!==n&&123!==n&&32!==n&&59!==n&&r>t);this.index=t},sliceToChar:function(n){for(var e,t,r=this.template,o=this.index,l=o,i=!1;(t=r.indexOf(n,o))>-1&&(o=t,92===r.charCodeAt(o-1));)i=!0,o++;return e=r.substring(l,o),this.index=o,i?e.replace(regexpEscapedChar[n],n):e}};var ConditionUtil=function(){function n(n,e){var t,r=e,o=n.index;if(null==r&&(n.skipWhitespace(),o=n.index,e=r=n.template.charCodeAt(n.index)),34===r||39===r)return n.index++,t=n.sliceToChar(39===r?"'":'"'),n.index++,t;do r=n.template.charCodeAt(++n.index);while(n.index<n.length&&32!==r&&33!==r&&60!==r&&61!==r&&62!==r&&40!==r&&41!==r&&38!==r&&124!==r);return t=n.template.substring(o,n.index),r=e,45===r||r>47&&58>r?t-0:116===r&&"true"===t?!0:102===r&&"false"===t?!1:{value:t}}function e(t,r){var o,l={assertions:null,join:null,left:null,right:null};null==r&&(r=[]),"string"==typeof t&&(t=new Template(t));n:for(;;){if(t.skipWhitespace(),t.index>=t.length)break;switch(o=t.template.charCodeAt(t.index)){case 61:case 60:case 62:case 33:var i=t.index;do o=t.template.charCodeAt(++t.index);while(t.index<t.length&&(60===o||61===o||62===o));l.sign=t.template.substring(i,t.index);continue;case 38:case 124:t.template.charCodeAt(++t.index)!==o&&console.error("Unary operation not valid"),l.join=38===o?"&&":"||",r.push(l),l={assertions:null,join:null,left:null,right:null},++t.index;continue;case 40:t.index++,e(t,l.assertions=[]);break;case 41:t.index++;break n;default:l[null==l.left?"left":"right"]=n(t,o);continue}}return(l.left||l.assertions)&&r.push(l),r}function t(t){if(null!=o[t])return o[t];var r=t.length,l={assertions:null,case1:null,case2:null},i=t.indexOf("?"),s=new Template(t);return-1!==i&&(s.length=i),l.assertions=e(s),-1!==i&&(s.length=r,s.index=i+1,l.case1=n(s),s.skipWhitespace(),58===s.template.charCodeAt(s.index)&&(s.index++,l.case2=n(s))),o[t]=l}function r(n,e){"string"==typeof n&&(n=t(n).assertions),null!=n.assertions&&(n=n.assertions);var o,l,i,s,u,a=!1;for(s=0,u=n.length;u>s;s++){if(o=n[s],o.assertions)a=r(o.assertions,e);else if(l="object"==typeof o.left?util_getProperty(e,o.left.value):o.left,null==o.right)a=l,"!"===o.sign&&(a=!a);else switch(i="object"==typeof o.right?util_getProperty(e,o.right.value):o.right,o.sign){case"<":a=i>l;break;case"<=":a=i>=l;break;case">":a=l>i;break;case">=":a=l>=i;break;case"!=":a=l!==i;break;case"==":a=l===i}if(a){if("&&"===o.join)continue;break}if("||"!==o.join&&"&&"===o.join)for(++s;u>s&&"||"!==n[s].join;s++);}return a}var o=[];return{condition:function(n,e){var o=t(n),l=r(o.assertions,e);return null!=o.case1&&(l=l?o.case1:o.case2),null==l?"":"object"==typeof l&&l.value?util_getProperty(e,l.value):l},isCondition:r,parse:t,out:{isCondition:r,parse:t}}}(),ExpressionUtil=function(){function n(n){this.parent=n,this.type=G,this.body=[],this.join=null}function e(n){this.parent=n}function t(n){this.type=V,this.body=n,this.join=null}function r(n,e){this.parent=n,this.type=z,this.body=e,this.arguments=[],this.next=null}function o(n,e){this.parent=n,this.type=q,this.body=e,this.next=null}function l(n,e){this.parent=n,this.prefix=e}function i(e){this.body=e,this.case1=new n(this),this.case2=new n(this)}function s(n,e){null==n&&console.error("Undefined",n,e);var t=n.type;return G===t?(n.body.push(e),e):X===t||Z===t?n.body=e:q===t||z===t?n.next=e:(console.error("Unsupported - append:",n,e),e)}function u(){if(0===arguments.length)return null;var e=new n(arguments[0].parent);return e.join=arguments[arguments.length-1].join,e.body=Array.prototype.slice.call(arguments),e}function a(n){if(n.type!==G)return null!=n.body&&"object"==typeof n.body&&a(n.body),void 0;for(var e,t,r,o=n.body,l=0,i=o.length;i>l;l++)a(o[l]);for(l=1;i>l&&(e=o[l],t=o[l-1],!(ee[t.join]>ee[e.join]));l++);if(l!==i){for(r=[o[0]],l=1;i>l;l++)e=o[l],t=o[l-1],ee[t.join]>ee[e.join]&&i-1>l&&(e=u(o[l],o[++l])),r.push(e);n.body=r}}function c(n,e){console.error("Expression parser:",n,e,y.substring(C))}function f(n,e,t,r){var o,l,i=n,s=n.body;if(null==l&&null!=e&&(o=e,l=e[s]),null==l&&null!=t&&(o=t,l=t[s]),null==l&&null!=r)do o=r,l=r[s];while(null==l&&null!=(r=r.parent));if(null!=l)for(;;){if(i.type===z){for(var u,a=[],f=0,p=i.arguments.length;p>f;f++)u=i.arguments[f],a[f]=v(u,e,t,r);l=l.apply(o,a)}if(null==l||null==i.next)break;if(i=i.next,s=i.body,o=l,l=l[s],null==l)break}return null==l&&(null==i||null!=i.next)&&c("Mask - Accessor error - ",s),l}function p(n){for(var e,t,r=!1,o=39===n?"'":'"',l=C;(e=y.indexOf(o,C))>-1&&(C=e,92===y.charCodeAt(e-1));)r=!0,C++;return t=y.substring(l,C),r===!0&&(t=t.replace(regexpEscapedChar[o],o)),t}function d(){for(var n,e,t=C;;){if(n=y.charCodeAt(C),46===n){if(e===!0)return c("Unexpected punc"),null;e=!0}if(!((n>=48&&57>=n||46===n)&&x>C))break;C++}return+y.substring(t,C)}function h(){var n,e=C,t=y.charCodeAt(C);if(34===t||39===t)return C++,n=p(t),C++,n;for(;;){t=y.charCodeAt(C);{if(!(t>47&&58!==t&&60!==t&&61!==t&&62!==t&&63!==t&&124!==t&&x>C))break;C++}}return y.substring(e,C)}function g(n){return null==n&&C===x?null:40===n?S:41===n?L:44===n?$:46===n?H:43===n?O:45===n?w:42===n?N:47===n?k:61===n?y.charCodeAt(++C)!==n?(c("Not supported (Apply directive)"),null):j:33===n?61===y.charCodeAt(C+1)?(C++,D):_:62===n?61===y.charCodeAt(C+1)?(C++,P):R:60===n?61===y.charCodeAt(C+1)?(C++,M):U:38===n?y.charCodeAt(++C)!==n?(c("Single Binary Operator AND"),null):E:124===n?y.charCodeAt(++C)!==n?(c("Single Binary Operator OR"),null):T:n>=65&&90>=n||n>=97&&122>=n||95===n||36===n?Q:n>=48&&57>=n?K:34===n||39===n?B:63===n?F:58===n?W:(c("Unexpected / Unsupported directive"),null)}function m(u){y=u,C=0,x=u.length,b=new n;for(var f,m,v=b,A=Y;;)if(x>C&&33>(f=y.charCodeAt(C)))C++;else{if(C>=x)break;if(m=g(f),null==m&&x>C)break;if(S!==m)if(L!==m)if($!==m)if(F!==m)if(W!==m)if(H===m&&(f=y.charCodeAt(C+1),f>=48&&57>=f?m=K:(m=Q,C++)),v.type===G&&(v=s(v,new e(v))),w!==m&&_!==m||null!=v.body)if(w!==m&&O!==m&&N!==m&&k!==m&&E!==m&&T!==m&&j!==m&&D!==m&&R!==m&&P!==m&&U!==m&&M!==m){if((B===m||K===m)&&null!=v.body&&null==v.join){c("Directive Expected");break}if(B!==m)if(K!==m){if(Q===m){for(var I=h();x>C;){f=y.charCodeAt(C);{if(!(33>f))break;C++}}if(40===f){A=ne,C++;var q=s(v,new r(v,I));v=q.newArgument();continue}110===f&&"null"===I&&(I=null),102===f&&"false"===I&&(I=!1),116===f&&"true"===I&&(I=!0),v=s(v,"string"==typeof I?new o(v,I):new t(I))}}else s(v,new t(d(f)));else C++,s(v,new t(p(f))),C++}else{for(;v&&v.type!==X;)v=v.parent;if(null==v.body){c("Unexpected operator",v);break}v.join=m;do v=v.parent;while(null!=v&&v.type!==G);null==v&&console.error("Unexpected parent",v),C++}else v=s(v,new l(v,m)),C++;else v=b.case2,C++;else b=new i(b),v=b.case1,C++;else{if(A!==ne){c("Unexpected punctuation, comma");break}do v=v.parent;while(null!=v&&v.type!==z);if(null==v){c("OutOfAst Exception - next argument");break}v=v.newArgument(),C++}else{var V=G;A===ne&&(A=Y,V=z);do v=v.parent;while(null!=v&&v.type!==V);if(V===G&&(v=v.parent),null==v){c("OutOfAst Exception - body closed");break}C++}else v=s(v,new e(v)),v=s(v,new n(v)),C++}return null==v.body&&v.type===X&&c("Unexpected end of expression"),a(b),b}function v(n,e,t,r){var o,l;if(null==n)return null;l="string"==typeof n?A.hasOwnProperty(n)===!0?A[n]:A[n]=m(n):n;var i,s,u,a=l.type;if(G===a){var c,p;n:for(i=0,u=l.body.length;u>i;i++)if(s=l.body[i],c=v(s,e,t,r),null!=p){if(p.join===E)if(o)o=c;else for(;u>i&&l.body[i].join!==T;i++);if(p.join===T){if(o)break n;if(c){o=c;break n}}switch(p.join){case w:o-=c;break;case O:o+=c;break;case k:o/=c;break;case N:o*=c;break;case D:o=o!=c;break;case j:o=o==c;break;case R:o=o>c;break;case P:o=o>=c;break;case U:o=c>o;break;case M:o=c>=o}p=s}else p=s,o=c}if(X===a)return v(l.body,e,t,r);if(V===a)return l.body;if(q===a||z===a)return f(l,e,t,r);if(Z===a)switch(o=v(l.body,e,t,r),l.prefix){case w:o=-o;break;case _:o=!o}return J===a&&(o=v(l.body,e,t,r),o=v(o?l.case1:l.case2,e,t,r)),o}var y,b,C=0,x=0,A={},w="-",O="+",k="/",N="*",T="||",E="&&",_="!",j="==",D="!=",R=">",P=">=",U="<",M="<=",I=".",S=20,L=21,$=22,H=23,F=24,W=25,Q=30,B=31,K=32,G=1,X=2,q=3,z=4,V=6,Z=9,J=10,Y=1,ne=2,ee={};ee[I]=1,ee[k]=2,ee[N]=2,ee[w]=3,ee[O]=3,ee[R]=4,ee[P]=4,ee[U]=4,ee[M]=4,ee[j]=5,ee[D]=5,ee[E]=6,ee[T]=6,e.prototype={constructor:e,type:X,join:null,body:null},r.prototype={constructor:r,newArgument:function(){var e=new n(this);return this.arguments.push(e),e}},l.prototype={constructor:l,type:Z,body:null},i.prototype={constructor:i,type:J,case1:null,case2:null};var te=function(){function n(n,e){return null==n?e:null==e?n:("string"==typeof n&&(n=[n]),"string"==typeof e?(n.push(e),n):n.concat(e))}return function e(t){if(null==t)return null;"string"==typeof t&&(t=m(t));var r,o;if(G===t.type)for(var l=0,i=t.body.length;i>l;l++)o=e(t.body[l]),r=n(r,o);if(q===t.type){for(var s=t.body,u=t.next;null!=u;){if(z===u.type)return r=e(u),null;if(q!==u.type)return console.error("Ast Exception: next should be a symbol/function ref"),null;s+="."+u.body,u=u.next}return s}if((X===t.type||Z===t.type||J===t.type)&&(o=e(t.body),r=n(r,o)),J===t.type&&(o=e(b.case1),r=n(r,o),o=e(b.case2),r=n(r,o)),z===t.type)for(var l=0,i=t.arguments.length;i>l;l++)o=e(t.arguments[l]),r=n(r,o);return r}}();return{parse:m,eval:v,varRefs:te}}(),ModelUtils={condition:ConditionUtil.condition,expression:function(n,e,t,r,o){return ExpressionUtil.eval(n,e,t,o)}},CustomAttributes={"class":null,id:null,style:null,name:null,type:null},CustomTags={div:null,span:null,input:null,button:null,textarea:null,select:null,option:null,h1:null,h2:null,h3:null,h4:null,h5:null,h6:null,a:null,p:null,img:null,table:null,td:null,tr:null,pre:null,ul:null,li:null,ol:null,i:null,b:null,strong:null,form:null},Dom={NODE:1,TEXTNODE:2,FRAGMENT:3,COMPONENT:4,CONTROLLER:9,SET:10,Node:Node,TextNode:TextNode,Fragment:Fragment,Component:Component};Node.prototype={constructor:Node,type:Dom.NODE,tagName:null,parent:null,attr:null,nodes:null,__single:null},TextNode.prototype={type:Dom.TEXTNODE,content:null,parent:null},Fragment.prototype={constructor:Fragment,type:Dom.FRAGMENT,nodes:null},Component.prototype={constructor:Component,type:Dom.COMPONENT,parent:null,attr:null,controller:null,nodes:null,components:null};var Parser=function(n,e,t,r){function o(n){for(var e=-1;-1!==(e=n.indexOf(i,e))&&n.charCodeAt(e+1)!==a;)e++;if(-1===e)return n;for(var t,r=[],o=0,l=0;;){if(t=n.indexOf(s,e+2),-1===t)break;for(r[l++]=o===e?"":n.substring(o,e),r[l++]=n.substring(e+2,t),o=e=t+1;-1!==(e=n.indexOf(i,e))&&n.charCodeAt(e+1)!==a;)e++;if(-1===e)break}return n.length>o&&(r[l]=n.substring(o)),n=null,function(n,e,t,o,l,i){if(null==n){for(var s,u="",a=0,c=r.length;c>a;a++)s=r[a],u+=1===a%2?"~["+s+"]":s;return u}return util_interpolate(r,n,e,t,o,l,i)}}function l(n,e,t,r){var o={2:"tag",3:"tag",5:"attribute key",6:"attribute value",8:"literal"}[t],l=n.substring(0,e).split("\n"),i=l.length,s=l[i-1].length,u=["Mask - Unexpected:",r,"at(",i,":",s,") [ in",o,"]"];console.error(u.join(" "),{stopped:n.substring(e),template:n})}var i="~",s="]",u=126,a=91,c=93;return{parse:function(i){for(var s,f,p,d,h,g,m,v=new t,y=v,b=2,C=3,x=0,A=i.length,w=2,O=3,k=5,N=6,T=7,E=8,_=9;;)if(A>x&&33>(g=i.charCodeAt(x)))x++;else if(47!==g||47!==i.charCodeAt(x+1)){if(C===k&&(null!=s&&(v.attr["class"]=o(s),s=null),null!=p&&(v.attr[p]=p,p=null,f=null)),null!=f){if(b===k)null==p?p=f:d=f,null!=p&&null!=d&&("class"!==p?v.attr[p]=d:s=null==s?d:s+" "+d,p=null,d=null);else if(C===O)h=null!=CustomTags[f]?new r(f,v,CustomTags[f]):new n(f,v),null==v.nodes?v.nodes=[h]:v.nodes.push(h),v=h,b=k;else if(C===E){if(h=new e(f,v),null==v.nodes?v.nodes=[h]:v.nodes.push(h),v.__single===!0)do v=v.parent;while(null!=v&&null!=v.__single);b=w}f=null}if(x>=A){b===k&&(null!=s&&(v.attr["class"]=o(s)),null!=p&&(v.attr[p]=p));break}if(b===_){for(v=v.parent;null!=v&&null!=v.__single;)v=v.parent;b=w}if(123!==g)if(62!==g)if(59!==g||null==v.nodes)if(59!==g&&125!==g)if(39!==g&&34!==g)if(b!==w||(C=O,b=O,46!==g&&35!==g)){if(b===k)if(46===g)x++,p="class",b=T;else if(35===g)x++,p="id",b=T;else{if(61===g){x++,b=N;continue}if(null!=p){f=p;continue}}(b===N||b===T)&&(C=b,b=k);var j=null;for(m=x;A>x;){if(g=i.charCodeAt(x),g===u&&i.charCodeAt(x+1)===a){j=!0,++x;do g=i.charCodeAt(++x);while(g!==c&&A>x)}if(39===g||34===g||47===g||60===g||44===g){l(i,x,b,String.fromCharCode(g));break}if(C!==N&&(46===g||35===g))break;if(61===g||62===g||123===g||33>g||59===g)break;x++}if(f=i.substring(m,x),!f){l(i,x,b,"*EMPTY*");break}if(j===!0&&b===O){l(i,x,b,"Tag Names cannt be interpolated (in dev)");break}j===!0&&(b===k&&"class"===p)==!1&&(f=o(f))}else f="div";else{b===N?b=k:C=b=E,x++;var D,R=!1,P=39===g?"'":'"';for(m=x;(D=i.indexOf(P,x))>-1&&(x=D,92===i.charCodeAt(D-1));)R=!0,x++;f=i.substring(m,x),R===!0&&(f=f.replace(regexpEscapedChar[P],P)),f=o(f),x++}else x++,C=b,b=_;else x++;else C=b,b=w,x++,v.__single=!0;else C=b,b=w,x++}else for(x++;10!==g&&13!==g&&A>x;)g=i.charCodeAt(++x);return null!=v.parent&&v.parent!==y&&v.parent.__single!==!0&&null!=v.nodes&&console.warn("Mask - ",v.parent.tagName,JSON.stringify(v.parent.attr),"was not proper closed."),1===y.nodes.length?y.nodes[0]:y},cleanObject:function(n){if(n instanceof Array){for(var e=0;n.length>e;e++)this.cleanObject(n[e]);return n}return delete n.parent,delete n.__single,null!=n.nodes&&this.cleanObject(n.nodes),n},setInterpolationQuotes:function(n,e){return n&&2===n.length?e&&1===e.length?(u=n.charCodeAt(0),a=n.charCodeAt(1),c=e.charCodeAt(0),s=e,i=n.charAt(0),void 0):(console.error("Interpolation End must be of 1 Character"),void 0):(console.error("Interpolation Start must contain 2 Characters"),void 0)}}}(Node,TextNode,Fragment,Component),cache={},Mask={render:function(n,e,t,r,o){return null!=r&&"function"!=typeof r.appendChild&&(console.error(".render(template[, model, cntx, container, controller]","Container should implement .appendChild method"),console.warn("Args:",arguments)),"string"==typeof n&&(n=hasOwnProp.call(cache,n)?cache[n]:cache[n]=Parser.parse(n)),builder_build(n,e,t,r,o)},compile:Parser.parse,parse:Parser.parse,build:builder_build,registerHandler:function(n,e){CustomTags[n]=e},getHandler:function(n){return null!=n?CustomTags[n]:CustomTags},registerAttrHandler:function(n,e){CustomAttributes[n]=e},registerUtility:function(n,e){ModelUtils[n]=e},clearCache:function(n){"string"==typeof n?delete cache[n]:cache={}},ValueUtils:{condition:ConditionUtil.condition,out:ConditionUtil},Utils:{Condition:ConditionUtil,Expression:ExpressionUtil,getProperty:util_getProperty},Dom:Dom,plugin:function(source){eval(source)},on:function(n,e){null==listeners&&(listeners={}),(listeners[n]||(listeners[n]=[])).push(e)},delegateReload:function(){},setInterpolationQuotes:Parser.setInterpolationQuotes};Mask.renderDom=Mask.render,function(n){var e=function(){function e(n){for(var e="";n--;)e+=" ";return e}function t(n,t,o){var l,i;null==t&&(t=0),null==o&&(l=!0,o=[]);var s=o.length;if(n.type===f.FRAGMENT&&(n=n.nodes),n instanceof Array)for(i=0;n.length>i;i++)r(n[i],t,o);else r(n,t,o);var u=e(t);for(i=s;o.length>i;i++)o[i]=u+o[i];return l?o.join(0===c?"":"\n"):void 0}function r(n,e,r){return"string"==typeof n.content?(r.push(u(n.content)),void 0):"function"==typeof n.content?(r.push(u(n.content())),void 0):l(n)?(r.push(o(n)+";"),void 0):i(n)?(r.push(o(n)+" > "),t(s(n),c,r),void 0):(r.push(o(n)+"{"),t(n.nodes,c,r),r.push("}"),void 0)}function o(n){var e=n.tagName,t=n.attr.id||"",r=n.attr["class"]||"";"function"==typeof t&&(t=t()),"function"==typeof r&&(r=r()),t&&(t=-1!==t.indexOf(" ")?"":"#"+t),r&&(r="."+r.split(" ").join("."));var o="";for(var l in n.attr)if("id"!==l&&"class"!==l){var i=n.attr[l];"function"==typeof i&&(i=i()),(a===!1||/\s/.test(i))&&(i=u(i)),o+=" "+l+"="+i}return"div"===e&&(t||r)&&(e=""),e+t+r+o}function l(n){return null==n.nodes||n.nodes instanceof Array&&0===n.nodes.length}function i(n){return n.nodes&&(n.nodes instanceof Array==!1||1===n.nodes.length)}function s(n){return n.nodes instanceof Array?n.nodes[0]:n.nodes}function u(n){return-1===n.indexOf('"')?'"'+n.trim()+'"':-1===n.indexOf("'")?"'"+n.trim()+"'":'"'+n.replace(/"/g,'\\"').trim()+'"'}var a,c,f=n.Dom;return function(e,r){return"string"==typeof e&&(e=n.parse(e)),"number"==typeof r?(c=r,a=0===c):(c=r&&r.indent||4,a=0===c||r&&r.minimizeAttributes),t(e)}}();n.stringify=e}(Mask),function(n){function e(){this.attr={"debugger":null,use:null,repeat:null,"if":null,"else":null,each:null,log:null}}function t(n,e,t,r){null==n.nodes&&Compo!==void 0&&Compo.ensureTemplate(n);var i=util_getProperty(e,n.attr.foreach||n.attr.each),s=n.nodes;if(n.nodes=[],n.template=s,n.container=r,i instanceof Array!=!1){for(var u=0,a=i.length;a>u;u++)n.nodes[u]=o(s,i[u],r,n);for(var c in l)n[c]=l[c]}}function r(n,e,t,r){var l,i=n.attr.repeat.split(".."),s=+i[0],u=+i[1],a=n.nodes;(isNaN(s)||isNaN(u))&&console.error("Repeat attribute(from..to) invalid",n.attr.repeat),n.nodes=[];for(var c=0;u>s;s++)l=o(a,e,r,n),l._repeatIndex=s,n.nodes[c++]=l}function o(n,e,t,r){var o=new Component;return o.nodes=n,o.model=e,o.container=t,o.parent=r,o}n.registerHandler("%",e),e.prototype={constructor:e,renderStart:function(n,e,o){var l=this.attr;if(null!=l.use)return this.model=util_getProperty(n,l.use),void 0;if(null==l["debugger"]){if(null!=l.log){var i=l.log,s=util_getProperty(n,i);return console.log("Key: %s, Value: %s",i,s),void 0}if(null!=l.repeat&&r(this,n,e,o),this.model=n,null!=l["if"]){var u=l["if"];return this.state=ConditionUtil.isCondition(u,n),this.state||(this.nodes=null),void 0}if(null!=l["else"]){var a=this.parent.components,c=a&&a[a.length-1];return null!=c&&"%"===c.compoName&&null!=c.attr["if"]?(c.state&&(this.nodes=null),void 0):(console.error("Previous Node should be \"% if='condition'\"",c,this.parent),void 0)}(null!=l.each||null!=l.foreach)&&t(this,n,e,o)}},render:null};var l={append:function(e){var t;t=new Component,t.nodes=this.template,t.model=e,n.render(t,e,null,this.container,this)}}}(Mask),function(n){function e(){}function t(){}function r(){}var o={};n.templates=o,n.registerHandler(":template",e),e.prototype.render=function(){return null==this.attr.id?(console.warn("Template Should be defined with ID attribute for future lookup"),void 0):(o[this.attr.id]=this.nodes,void 0)},n.registerHandler(":import",t),t.prototype={constructor:t,attr:null,template:null,renderStart:function(){if(this.attr.id){if(this.nodes=this.template,null==this.nodes&&(this.nodes=o[this.attr.id]),null==this.nodes){for(var n,e=this,t=":template[id="+this.attr.id+"]";null==n&&null!=(e=e.parent);)null!=e.nodes&&(n=jmask(e.nodes).filter(t).get(0));null!=n&&(this.nodes=n.nodes)}null==this.nodes&&console.warn("Template could be not imported",this.attr.id)}}},n.registerHandler(":html",r),r.prototype.render=function(n,e,t){var r=jmask(this.nodes).text(n,e,this);return r?(t.insertAdjacentHTML("beforeend",r),void 0):(console.warn("No HTML for node",this),void 0)}}(Mask);var Compo=exports.Compo=function(n){function e(n,e){if(null==n&&(n={}),null==e)return n;for(var t in e)n[t]=e[t];return n}function t(n){var e={};for(var t in n)e[t]=n[t];return e}function r(n,e,t){if(null==n&&console.warn("selector is null for type",e),"object"==typeof n)return n;var r,o,l;if(null==r)switch(n[0]){case"#":r="id",n=n.substring(1),o="attr";break;case".":r="class",n=RegExp("\\b"+n.substring(1)+"\\b"),o="attr";break;default:r=e===c.SET?"tagName":"compoName"}return l="up"===t?"parent":e===c.SET?"nodes":"components",{key:r,prop:o,selector:n,nextKey:l}}function o(n,e,t){"string"==typeof e&&(null==t&&(t=c[n.compoName?"CONTROLLER":"SET"]),e=r(e,t));var o=e.prop?n[e.prop]:n;if(null==o)return!1;if(null!=e.selector.test){if(e.selector.test(o[e.key]))return!0}else if(o[e.key]==e.selector)return!0;return!1}function l(n,e){if(n instanceof Array){for(var t,r=0,i=n.length;i>r;r++){t=n[r];var s=l(t,e);if(null!=s)return s}return null}return o(n,e)===!0?n:(n=n[e.nextKey])&&l(n,e)}function i(n,e,t){return null!=n.addEventListener?(n.addEventListener(e,t,!1),void 0):(n.attachEvent&&n.attachEvent("on"+e,t),void 0)}function s(n,e){return n.filter(e).add(n.find(e))}function u(n,e,t,r){return null==t?n.on(e,r):(n.on(e,t,r),n.filter(t).on(e,r),n)}var a=global.jQuery||global.Zepto||global.$,c=n.Dom;a||console.warn("jQuery / Zepto etc. was not loaded before compo.js, please use Compo.config.setDOMLibrary to define dom engine");var f={select:function(n,e){for(var t in e){var r=e[t],o=null,l=null;if(r instanceof Array&&(l=r[0],o=r.splice(1)),"string"==typeof r&&(l=r),null==r||null==l)return console.error("Unknown component child",t,e[t]),console.warn("Is this object shared within multiple compo classes? Define it in constructor!"),void 0;var i=l.indexOf(":"),s=l.substring(0,i);s=v.config.selectors[s],null==s?n.compos[t]=n.$[0].querySelector(l):(l=l.substring(++i).trim(),n.compos[t]=s(n,l));var u=n.compos[t];null!=o&&(u instanceof v&&(u=u.$),p.on(n,o,u))}}},p={on:function(n,e,t){null==t&&(t=n.$);for(var r,o=e instanceof Array,l=o?e.length:1,i=0;o?l>i:1>i;i++)if(r=o?e[i]:e,r instanceof Array)null!=d&&(r[0]=d(r[0])),t.on.apply(t,r);else for(var s in r){var a,c,f="string"==typeof r[s]?n[r[s]]:r[s],p=s.indexOf(":");-1!==p?(a=s.substring(0,p),c=s.substring(p+1).trim()):a=s,null!=d&&(a=d(a)),u(t,a,c,f.bind(n))}}},d=null,h=function(){var n=function(){if(null==document)return!1;if("createTouch"in document)return!0;try{return!!document.createEvent("TouchEvent").initTouchEvent}catch(n){return!1}}();return{touch:function(e){return n===!1?e:"click"===e?"touchend":"mousedown"===e?"touchstart":"mouseup"===e?"touchend":"mousemove"===e?"touchmove":e}}}(),g=function(){function e(n,e){return function(){new s(n).emit(e)}}function t(n,e){return null==e.pipes[n]?(console.error("Controller has no pipes to be added to collection",n,e),void 0):(null==u[n]&&(u[n]=[]),u[n].push(e),void 0)}function r(n,e){for(var t=u[n],r=t.length;--r;)t[r]===e&&(t.splice(r,1),r++)}function o(){var n=this,e=n.pipes;for(var t in e)r(t,n)}function l(n){var e=n.pipes;if(null==e)return console.error("Controller has no pipes",n),void 0;for(var r in e)t(r,n);v.attachDisposer(n,o.bind(n))}function s(n){return this instanceof s==!1?new s(n):(this.pipeName=n,this)}n.registerAttrHandler("x-pipe-signal",function(n,t,r,o,l){for(var s,u=t.split(";"),a=0,c=u.length;c>a;a++)if(s=u[a].trim(),""!==s){var f,p,h=s.substring(0,s.indexOf(":")),g=s.substring(s.indexOf(":")+1).trim(),m=g.indexOf(".");if(-1===m)return console.error('define pipeName "click: pipeName.pipeSignal"'),void 0;f=g.substring(0,m),p=g.substring(++m);var v=e(f,p);!h&&console.error("Signal: event type is not set",t),null!=d&&(h=d(h)),i(l,h,v)}});var u={};return s.prototype={constructor:s,emit:function(n,e){var t=u[this.pipeName],r=this.pipeName;if(null==t)return console.warn("Pipe.emit: No signals were bound to a Pipe",r),void 0;for(var o,l,i,s,a=t.length;-1!==--a;)o=t[a],l=o.pipes[r],null!=l&&(i=l[n],"function"==typeof i&&(i.apply(o,e),s=!0));s!==!0&&console.warn("No piped slot found for a signal",n,r)}},s.addController=l,s.removeController=o,{addController:l,removeController:o,emit:function(n,e,t){s(n).emit(e,t)},pipe:s}}(),m=function(){var n={};return{create:function(e){return null==e.ID?(console.warn("Component should have an ID"),void 0):(n[e.ID]=e,void 0)},resolveCompo:function(e){if(null==e)return null;do{var t=e.getAttribute("x-compo-id");if(null!=t){var r=n[t];return null==r&&(r=this.resolveCompo(e.parentNode),null!=r&&(r=v.find(r,{key:"ID",selector:t,nextKey:"components"}))),null==r&&console.warn("No controller for ID",t),r}e=e.parentNode}while(e&&1===e.nodeType);return null},removeCompo:function(e){null!=e.ID&&delete n[e.ID]}}}(),v=function(){function o(n){if(this instanceof o)return null;var e;null==n&&(n={}),n.hasOwnProperty("constructor")&&(e=n.constructor),e=b(e,n),null==e&&(e=function(){});for(var t in C)null==n[t]&&(n[t]=C[t]),n["base_"+t]=C[t];return e.prototype=n,n=null,e}function i(n){null!=n.dispose&&n.dispose(),m.removeCompo(n);var e=0,t=n.components,r=t&&t.length;if(r)for(;r>e;e++)i(t[e])}function u(e){if(null==e.nodes){if(e.template)return e.nodes=n.parse(e.template),void 0;var t=e.attr.template;if("string"==typeof t){if("#"===t[0]){var r=document.getElementById(t.substring(1));if(null==r)return console.error("Template holder not found by id:",t),void 0;t=r.innerHTML}t=n.parse(t)}t!==void 0&&(e.nodes=t,delete e.attr.template)}}function v(){var n=[];return n.appendChild=function(n){this.push(n)},n}function y(n,e){if("function"==typeof n.dispose){var t=n.dispose;return n.dispose=function(){e(),t()},void 0}n.dispose=e}function b(n,e){var r=e.compos,o=e.pipes;return null==r&&null==o?n:function(){null!=r&&(this.compos=t(r)),null!=o&&g.addController(this),"function"==typeof n&&n.call(this)}}e(o,{create:function(n){var e;null==n&&(n={}),n.hasOwnProperty("constructor")&&(e=n.constructor),null==e&&(e=function(){});for(var t in C)null==n[t]&&(n[t]=C[t]),n["base_"+t]=C[t];return e.prototype=n,e},render:function(e,t,r,o){u(e);var l=[];return n.render(null==e.tagName?e.nodes:e,t,r,o,e,l),e.$=a(l),null!=e.events&&p.on(e,e.events),null!=e.compos&&f.select(e,e.compos),e},initialize:function(e,t,r,l,i){null==l&&(r&&null!=r.nodeType?(l=r,r=null):t&&null!=t.nodeType&&(l=t,t=null)),"string"==typeof e&&(e=n.getHandler(e),e||console.error("Compo not found:",e));var s={controller:e,type:c.COMPONENT};null==i&&null!=l&&(i=m.resolveCompo(l)),null==i&&(i=new c.Component);var u=n.render(s,t,r,null,i),a=i.components[i.components.length-1];return null!=l&&(l.appendChild(u),o.signal.emitIn(a,"domInsert")),a},dispose:function(n){"function"==typeof n.dispose&&n.dispose();var e=0,t=n.components,r=t&&t.length;if(r)for(;r>e;e++)o.dispose(t[e])},find:function(n,e){return l(n,r(e,c.CONTROLLER,"down"))},closest:function(n,e){return l(n,r(e,c.CONTROLLER,"up"))},ensureTemplate:u,attachDisposer:y,config:{selectors:{$:function(n,e){var t=s(n.$,e);return 0===t.length&&console.error("Compo Selector - element not found -",e,n),t},compo:function(n,e){var t=o.find(n,e);return null==t&&console.error("Compo Selector - component not found -",e,n),t}},setDOMLibrary:function(n){a=n},eventDecorator:function(n){return"function"==typeof n?(d=n,void 0):"string"==typeof n?(d=h[n],void 0):"boolean"==typeof n&&n===!1?(d=null,void 0):void 0}},pipe:g.pipe});var C={type:c.CONTROLLER,tagName:null,compoName:null,nodes:null,attr:null,slots:null,pipes:null,onRenderStart:null,onRenderEnd:null,render:null,renderStart:function(n,e,t){1===arguments.length&&null!=n&&n instanceof Array==!1&&null!=n[0]&&(n=arguments[0][0],e=arguments[0][1],t=arguments[0][2]),"function"==typeof this.onRenderStart&&this.onRenderStart(n,e,t),null==this.model&&(this.model=n),null==this.nodes&&u(this)},renderEnd:function(n,e,t,r){1===arguments.length&&n instanceof Array==!1&&(n=arguments[0][0],e=arguments[0][1],t=arguments[0][2],r=arguments[0][3]),m.create(this,n),this.$=a(n),null!=this.events&&p.on(this,this.events),null!=this.compos&&f.select(this,this.compos),"function"==typeof this.onRenderEnd&&this.onRenderEnd(n,e,t,r)},appendTo:function(n){var e;if(e="string"==typeof n?document.querySelector(n):n,null==e)return console.warn("Compo.appendTo: parent is undefined. Args:",arguments),this;for(var t=0;this.$.length>t;t++)e.appendChild(this.$[t]);return this.emitIn("domInsert"),this},append:function(e,t,o){var i;if(null==this.$){var s="string"==typeof e?n.compile(e):e;return i=o?l(this,r(o,c.CONTROLLER,"down")):this,null==i.nodes?(this.nodes=s,this):(i.nodes=[this.nodes,s],this)}var u=n.render(e,t,null,v(),this);i=o?this.$.find(o):this.$;for(var a=0;u.length>a;a++)i.append(u[a]);return this.emitIn("domInsert"),this},find:function(n){return l(this,r(n,c.CONTROLLER,"down"))},closest:function(n){return l(this,r(n,c.CONTROLLER,"up"))},on:function(){var n=Array.prototype.slice.call(arguments);return 3>arguments.length?(console.error("Invalid Arguments Exception @use .on(type,selector,fn)"),this):(null!=this.$&&p.on(this,[n]),null==this.events?this.events=[n]:this.events instanceof Array?this.events.push(n):this.events=[n,this.events],this)},remove:function(){null!=this.$&&(this.$.remove(),this.$=null),i(this);var n=this.parent&&this.parent.components;if(null!=n){var e=n.indexOf(this);if(-1===e)return console.warn("Compo::remove - parent doesnt contains me",this),this;n.splice(e,1)}return this},slotState:function(n,e){o.slot.toggle(this,n,e)},signalState:function(n,e){o.signal.toggle(this,n,e)},emitOut:function(n,e,t){o.signal.emitOut(this,n,e,t)},emitIn:function(n,e,t){o.signal.emitIn(this,n,e,t)}};return o.prototype=C,o}();return function(){function t(n,e,r,o,l){if(null!=n){if(null!=o&&("function"==typeof o.unshift?o=[r,o]:o.unshift(r)),null!=n.slots&&"function"==typeof n.slots[e]){var i=n.slots[e],s=null!=n.slots.__disabled&&n.slots.__disabled[e];if(s!==!0){var u=null==o?i.call(n,r):i.apply(n,o);if(u===!1)return}}if(-1===l&&null!=n.parent&&t(n.parent,e,r,o,l),1===l&&null!=n.components)for(var a=0,c=n.components.length;c>a;a++)t(n.components[a],e,r,o,l)}}function r(n,e,t,o){if(null==n)return!1;var l=n.slots;if(null!=l&&null!=l[e]&&("string"==typeof l[e]&&(l[e]=n[l[e]]),"function"==typeof l[e])){if(o!==!0)return!0;if(null==l.__disabled||l.__disabled[e]!==!0)return!0}if(-1===t&&null!=n.parent)return r(n.parent,e,t);if(1===t&&null!=n.components)for(var i=0,s=n.components.length;s>i;i++)if(r(n.components[i],e,t))return!0;return!1}function o(n,e){return r(n,e,-1)===!1?null:function(r){t(n,e,r,null,-1)}}function l(n,e,t){var r=n.slots;null!=r&&r.hasOwnProperty(e)!==!1&&(null==r.__disabled&&(r.__disabled={}),r.__disabled[e]=t===!1)}function s(n,e,t){if(l(n,e,t),null!=n.components)for(var r=0,o=n.components.length;o>r;r++)s(n.components[r],e,t)}function u(n,e,t){return null==n.$?(console.warn("Controller has no elements to toggle state"),void 0):(a().add(n.$.filter("[data-signals]")).add(n.$.find("[data-signals]")).each(function(n,r){var o=r.getAttribute("data-signals");null!=o&&-1!==o.indexOf(e)&&r[t===!0?"removeAttribute":"setAttribute"]("disabled","disabled")}),void 0)}function c(n,e,t){for(var r=n,o=n;null!=(r=r.parent);)l(r,e,t),null!=r.$&&0!==r.$.length&&(o=r);s(n,e,t),u(o,e,t)}function f(n,e,t){l(n,e,t),(t||!r(n,e,-1,!0)&&!r(n,e,1,!0))&&u(n,e,t)
}n.registerAttrHandler("x-signal",function(n,e,t,r,l,s){for(var u,a=e.split(";"),c="",f=0,p=a.length;p>f;f++)if(u=a[f].trim(),""!==u){var h=u.substring(0,u.indexOf(":")),g=u.substring(u.indexOf(":")+1).trim(),m=o(s,g);!h&&console.error("Signal: event type is not set",e),m&&(null!=d&&(h=d(h)),c+=","+g+",",i(l,h,m)),!m&&console.warn("No slot found for signal",g,s)}""!==c&&l.setAttribute("data-signals",c)}),e(v,{signal:{toggle:c,emitOut:function(n,e,r,o){t(n,e,r,o,-1)},emitIn:function(n,e,r,o){t(n,e,r,o,1)},enable:function(n,e){c(n,e,!0)},disable:function(n,e){c(n,e,!1)}},slot:{toggle:f,enable:function(n,e){f(n,e,!0)},disable:function(n,e){f(n,e,!1)},invoke:function(n,e,t,r){var o=n.slots;return null==o||"function"!=typeof o[e]?(console.error("Slot not found",e,n),null):null==r?o[e].call(n,t):o[e].apply(n,[t].concat(r))}}})}(),function(){null!=a&&null!=a.fn&&(a.fn.compo=function(n){if(0===this.length)return null;var e=m.resolveCompo(this[0]);return null==n?e:l(e,r(n,c.CONTROLLER,"up"))},a.fn.model=function(n){var e=this.compo(n);if(null==e)return null;for(var t=e.model;null==t&&e.parent;)e=e.parent,t=e.model;return t})}(),v}(Mask);return Mask});