(function(e,t){var n=typeof document=="undefined"?null:document,r=function(){return t(n)};typeof exports=="object"?module.exports=r():typeof define=="function"&&define.amd?define(r):e.mask=r()})(this,function(document){function Template(e){this.template=e,this.index=0,this.length=e.length}function ICustomTag(){this.attr={}}var regexpWhitespace=/\s/g,regexpLinearCondition=/([(]?)([!]?['"A-Za-z0-9_\-\.$]+)(([!<>=]{1,3})([^\|&()]+))?([\|&]{2})?([)]?([\|&]{2})?)/g,regexpEscapedChar={"'":/\\'/g,'"':/\\"/g,"{":/\\\{/g,">":/\\>/g,";":/\\>/g},regexpTabsAndNL=/[\t\n\r]{1,}/g,regexpMultipleSpaces=/ {2,}/g,hasOwnProp={}.hasOwnProperty,listeners=null,Helper={extend:function(e,t){var n;if(t==null)return e;e==null&&(e={});for(n in t)hasOwnProp.call(t,n)&&(e[n]=t[n]);return e},getProperty:function(e,t){var n=e,r,i,s,o;if(typeof e!="object"||t==null)return e;typeof t=="string"&&(r=t.split("."));for(s=0,o=r.length;s<o;s++){i=r[s],n=n[i];if(!n)return n}return n},interpolate:function(e,t,n,r,i,s){var o=e.length,u=new Array(o),a=!0,f,l,c,h,p;for(p=0,o=e.length;p<o;p++)a?u[p]=e[p]:(h=e[p],l=null,c=h.indexOf(":"),~c?(f=c>0?h.substring(0,c).replace(regexpWhitespace,""):"",f===""&&(f="condition"),h=h.substring(c+1),l=typeof ModelUtils[f]=="function"?ModelUtils[f](h,t,n,r,i,s):null):l=Helper.getProperty(t,h),u[p]=l==null?"":l),a=!a;return u},templateFunction:function(e,t){var n="",r=!0,i,s,o,u,a,f;for(a=0,f=e.length;a<f;a++)r?n+=e[a]:(u=e[a],s=null,o=u.indexOf(":"),~o?(i=o>0?u.substring(0,o).replace(regexpWhitespace,""):"",i===""&&(i="condition"),u=u.substring(o+1),s=typeof ModelUtils[i]=="function"?ModelUtils[i](u,t):null):s=Helper.getProperty(t,u),n+=s==null?"":s),r=!r;return n}};Template.prototype={next:function(){return this.index++,this},skipWhitespace:function(){var e=this.template,t=this.index,n=this.length;for(;t<n;t++)if(e.charCodeAt(t)!==32)break;return this.index=t,this},skipToChar:function(e){var t=this.template,n;do n=t.indexOf(e,this.index);while(~n&&t.charCodeAt(n-1)!==92);return this.index=n,this},skipToAttributeBreak:function(){var e=this.template,t=this.index,n=this.length,r;do{r=e.charCodeAt(++t);if(r===35&&e.charCodeAt(t+1)===123){this.index=t,this.sliceToChar("}"),this.index++;return}}while(r!==46&&r!==35&&r!==62&&r!==123&&r!==32&&r!==59&&t<n);return this.index=t,this},sliceToChar:function(e){var t=this.template,n=this.index,r=n,i=!1,s,o;while((o=t.indexOf(e,n))>-1){n=o;if(t.charCodeAt(n-1)!==92)break;i=!0,n++}return s=t.substring(r,n),this.index=n,i?s.replace(regexpEscapedChar[e],e):s}},ICustomTag.prototype.render=function(e,t){return Builder.build(this.nodes,e,t)};var CustomTags=function(){function t(){this.attr={}}function n(){this.attr={}}function r(){this.attr={}}var e=ICustomTag.prototype.render;return t.prototype.render=function(e,t,n){var r=this.attr,i=r.template,s=Helper.getProperty(e,r.value),o,u,a,f;if(s instanceof Array){i!=null&&(u=document.querySelector(i).innerHTML,this.nodes=o=Mask.compile(u));if(this.nodes==null)return t;for(a=0,f=s.length;a<f;a++)Builder.build(this.nodes,s[a],t,n);return t}return t},n.prototype.render=function(t,n,r){return ConditionUtil.isCondition(this.attr.check,t)?e.call(this,t,n,r):n},r.prototype.render=function(){var e=Object.defineProperty,t=!1,n,i;if(e)try{t=Object.defineProperty({},"x",{get:function(){return!0}}).x}catch(s){t=!1}else Object.prototype.__defineGetter__&&(e=function(e,t,n){hasOwnProp.call(n,"get")&&e.__defineGetter__(t,n.get),hasOwnProp.call(n,"set")&&e.__defineSetter__(t,n.set)},t=!0);return t||(n=[],e=function(e,t,r){var i,s=!1,o,u;for(o=0,u=n.length;o<u;o++){i=n[o];if(i.obj===e){s=!0;break}}s||(i=n[o]={obj:e,props:{}}),i.props[t]={value:e[t],set:r.set}},i=function(){var e,t,r,s,o,u,a;for(t=0,r=n.length;t<r;t++){e=n[t],s=e.props;for(o in s)hasOwnProp.call(s,o)&&(u=s[o],a=e.obj[o],a!==u.value&&u.set.call(null,a))}setTimeout(i,16)},i()),(r.prototype.render=function(t,n){var r=this.attr.value,i=t[r];return e.call(Object,t,r,{get:function(){return i},set:function(e){n.innerHTML=i=e}}),n.innerHTML=i,n}).apply(this,arguments)},{all:{list:t,visible:n,bind:r}}}(),CustomAttributes={},ConditionUtil=function(){function e(e,t){var n=t,r=e.index,i;n==null&&(e.skipWhitespace(),r=e.index,t=n=e.template.charCodeAt(e.index));if(n===34||n===39){var s=e.template.charAt(e.index);e.index++;var o=e.template.charAt(e.index);return i=e.sliceToChar(n===39?"'":'"'),e.index++,i}do n=e.template.charCodeAt(++e.index);while(e.index<e.length&&n!==32&&n!==33&&n!==60&&n!==61&&n!==62&&n!==40&&n!==41&&n!==38&&n!==124);return i=e.template.substring(r,e.index),n=t,n===45||n>47&&n<58?i-0:n===116&&i==="true"?!0:n===102&&i==="false"?!1:{value:i}}function t(n,r){var i={},s;r==null&&(r=[]),typeof n=="string"&&(n=new Template(n));do{n.skipWhitespace();if(n.index>=n.length)break;s=n.template.charCodeAt(n.index);switch(s){case 61:case 60:case 62:case 33:var o=n.index;do s=n.template.charCodeAt(++n.index);while(n.index<n.length&&(s===60||s===61||s===62));i.sign=n.template.substring(o,n.index);continue;case 38:case 124:n.template.charCodeAt(++n.index)!==s&&console.error("Unary operation not valid"),i.join=s==38?"&&":"||",r.push(i),i={},++n.index;continue;case 40:n.index++,t(n,i.assertions=[]);break;case 41:n.index++;break;default:i[i.left==null?"left":"right"]=e(n,s);continue}}while(1);return(i.left||i.assertions)&&r.push(i),r}function r(r){if(n[r]!=null)return n[r];var i=r.length,s={},o=r.indexOf("?"),u=new Template(r);return o>-1&&(u.length=o),s.assertions=t(u),u.length=i,u.index=o+1,s.case1=e(u),u.skipWhitespace(),u.template.charCodeAt(u.index)===58&&(u.index++,s.case2=e(u)),n[r]=s}function i(e){e.skipWhitespace();var t=e.template.charCodeAt(e.index);switch(t){case 34:case 39:var n=e.index;e.index++;var r=String.fromCharCode(t),i=e.sliceToChar(r);return e.index++,i;default:var n=e.index;do t=e.template.charCodeAt(++e.index);while(e.index<e.length&&t!==58&&t!==32);return e.template.substring(n,e.index)}}function s(e,t){typeof e=="string"&&(e=r(e).assertions),e.assertions!=null&&(e=e.assertions);var n=!1,i,o,u,a,f;for(a=0,f=e.length;a<f;a++){i=e[a];if(i.assertions)n=s(i.assertions,t);else{o=typeof i.left=="object"?Helper.getProperty(t,i.left.value):i.left;if(i.right==null)n=!!o,i.sign==="!"&&(n=!n);else{u=typeof i.right=="object"?Helper.getProperty(t,i.right.value):i.right;switch(i.sign){case"<":n=o<u;break;case"<=":n=o<=u;break;case">":n=o>u;break;case">=":n=o>=u;break;case"!=":n=o!==u;break;case"==":n=o===u}}}if(n===!0){if(i.join==="&&")continue;break}if(i.join==="||")continue;break}return n}var n=[];return{condition:function(e,t){var n=r(e),i=s(n.assertions,t)?n.case1:n.case2;return i==null?"":typeof i=="object"&&i.value?Helper.getProperty(t,i.value):i},isCondition:s,parse:r,out:{isCondition:s,parse:r}}}(),ModelUtils={condition:ConditionUtil.condition},Parser={toFunction:function(e){var t="#{",n="}",r=2,i=[],s=0,o=0,u=0,a=0;while((s=e.indexOf(t,s))>-1){a=e.indexOf(n,s+r);if(a==-1){s+=r;continue}o<s&&(i[u]=e.substring(o,s),u++),s==o&&(i[u]="",u++),i[u]=e.substring(s+r,a),u++,o=s=a+1}return o<e.length&&(i[u]=e.substring(o)),e=null,function(e,t,n,r,s){return Helper.interpolate(i,e,t,n,r,s)}},parseAttributes:function(e,t){var n=e.template,r,i,s,o,u,a,f;t.attr==null&&(t.attr={});e:for(;e.index<e.length;){r=null,i=null,u=e.template.charCodeAt(e.index);switch(u){case 32:e.index++;continue;case 123:case 59:case 62:break e;case 46:a=e.index+1,e.skipToAttributeBreak(),i=e.template.substring(a,e.index),s=s!=null?s+" "+i:i;break;case 35:r="id",a=e.index+1,e.skipToAttributeBreak(),i=e.template.substring(a,e.index);break;default:r=this.parseAttributeValue(e),e.template.charCodeAt(e.index)!==61?i=r:(e.index++,e.skipWhitespace(),i=this.parseAttributeValue(e))}r!=null&&(i.indexOf("#{")>-1&&(i=e.serialize!==!0?this.toFunction(i):{template:i}),t.attr[r]=i)}s!=null&&(t.attr["class"]=s.indexOf("#{")>-1?e.serialize!==!0?this.toFunction(s):{template:s}:s)},parseAttributeValue:function(e){var t=e.template.charCodeAt(e.index),n;if(t===34||t===39)return e.index++,n=e.sliceToChar(t===34?'"':"'"),e.index++,n;var r=e.index,t;do t=e.template.charCodeAt(++e.index);while(t!=61&&t!==32&&t!==123&&t!==62&&t!==59&&e.index<e.length);return n=e.template.substring(r,e.index),t===32&&e.skipWhitespace(),n},parse:function(e){var t=e;for(;e.index<e.length;e.index++){var n=e.template.charCodeAt(e.index);switch(n){case 32:continue;case 39:case 34:e.index++;var r=e.sliceToChar(n===39?"'":'"');r.indexOf("#{")>-1&&(r=e.serialize!==!0?this.toFunction(r):{template:r});var i={content:r};t.nodes==null?t.nodes=i:t.nodes.push==null?t.nodes=[t.nodes,i]:t.nodes.push(i);if(t.__single){if(t==null)continue;t=t.parent;while(t!=null&&t.__single!=null)t=t.parent}continue;case 62:t.__single=!0;continue;case 123:continue;case 59:if(t.nodes!=null)continue;case 125:if(t==null)continue;do t=t.parent;while(t!=null&&t.__single!=null);continue}var s=null;if(n===46||n===35)s="div";else{var o=e.index;do n=e.template.charCodeAt(++e.index);while(n!==32&&n!==35&&n!==46&&n!==59&&n!==123&&n!==62&&e.index<=e.length);s=e.template.substring(o,e.index)}s===""&&console.error("Parse Error: Undefined tag Name %d/%d %s",e.index,e.length,e.template.substring(e.index,e.index+10));var u={tagName:s,parent:t};t==null&&console.log("T",e,"rest",e.template.substring(e.index)),t.nodes==null?t.nodes=u:t.nodes.push==null?t.nodes=[t.nodes,u]:t.nodes.push(u),t=u,this.parseAttributes(e,t),e.index--}return e.nodes},cleanObject:function(e){if(e instanceof Array){for(var t=0;t<e.length;t++)this.cleanObject(e[t]);return e}return delete e.parent,delete e.__single,e.nodes!=null&&this.cleanObject(e.nodes),e}},Builder={build:function(e,t,n,r){if(e==null)return n;n==null&&(n=document.createDocumentFragment()),r==null&&(r={});var i=e instanceof Array,s=i===!0?e.length:1,o,u,a,f;for(o=0;o<s;o++){u=i===!0?e[o]:e;if(CustomTags.all[u.tagName]!=null){var l=CustomTags.all[u.tagName],c=l instanceof Function?new l(t):l;c.compoName=u.tagName,c.nodes=u.nodes,c.attr=Helper.extend(c.attr,u.attr),(r.components||(r.components=[])).push(c),c.parent=r;if(listeners!=null){var h=listeners.customCreated;if(h!=null)for(a=0,f=h.length;a<f;a++)h[a](c,t,n)}c.render(t,n,c);continue}if(u.content!=null){if(typeof u.content=="function"){var p=u.content(t,"node",r,n),d="";for(a=0,f=p.length;a<f;a++){if(typeof p[a]=="object"){d!==""&&(n.appendChild(document.createTextNode(d)),d=""),n.appendChild(p[a]);continue}d+=p[a]}d!==""&&n.appendChild(document.createTextNode(d))}else n.appendChild(document.createTextNode(u.content));continue}var v=document.createElement(u.tagName),m=u.attr;for(var g in m)if(hasOwnProp.call(m,g)===!0){var y;if(typeof m[g]=="function"){var p=m[g](t,"attr",r,v,g);y=p.join("")}else y=m[g];y&&(CustomAttributes[g]!=null?CustomAttributes[g](u,t,y,v,r):v.setAttribute(g,y))}u.nodes!=null&&this.build(u.nodes,t,v,r),n.appendChild(v)}return n}},cache={},Mask={render:function(e,t,n,r){return typeof e=="string"&&(e=this.compile(e)),Builder.build(e,t,n,r)},compile:function(e,t){if(hasOwnProp.call(cache,e))return cache[e];var n=new Template(e.replace(regexpTabsAndNL,"").replace(regexpMultipleSpaces," "));return t===!0&&(n.serialize=!0),cache[e]=Parser.parse(n)},registerHandler:function(e,t){CustomTags.all[e]=t},getHandler:function(e){return e!=null?CustomTags.all[e]:CustomTags.all},registerAttrHandler:function(e,t){CustomAttributes[e]=t},registerUtility:function(e,t){ModelUtils[e]=t},serialize:function(e){return Parser.cleanObject(this.compile(e,!0))},deserialize:function(e){var t,n,r;if(e instanceof Array){for(t=0;t<e.length;t++)this.deserialize(e[t]);return e}if(e.content!=null)return e.content.template!=null&&(e.content=Parser.toFunction(e.content.template)),e;if(e.attr!=null){r=e.attr;for(n in r)if(hasOwnProp.call(r,n)===!0){if(r[n].template==null)continue;r[n]=Parser.toFunction(r[n].template)}}return e.nodes!=null&&this.deserialize(e.nodes),e},clearCache:function(e){typeof e=="string"?delete cache[e]:cache={}},ICustomTag:ICustomTag,ValueUtils:{condition:ConditionUtil.condition,out:ConditionUtil},Utils:{Condition:ConditionUtil},plugin:function(source){eval(source)},on:function(e,t){listeners==null&&(listeners={}),(listeners[e]||(listeners[e]=[])).push(t)},delegateReload:function(){}};return Mask.renderDom=Mask.render,Mask});