(function(e,n){"use strict";null==e&&"undefined"!=typeof global&&(e=global);var t="undefined"==typeof document?null:document,r=function(){return n(e,t)};"object"==typeof exports?module.exports=r():"function"==typeof define&&define.amd?define(r):e.mask=r()})(this,function(global,doc){"use strict";function util_extend(e,n){null==e&&(e={});for(var t in n)hasOwnProp.call(n,t)!==!1&&(e[t]=n[t]);return e}function util_getProperty(e,n){if("."===n)return e;for(var t=e,r=n.split("."),o=-1,i=r.length;null!=t&&i>++o;)t=t[r[o]];return t}function util_interpolate(e,n,t,r,o,i,l){for(var s,u,a,c,f=e.length,d=0,p=null,h="",m=!0;f>d;d++)m===!0?null==p?h+=e[d]:p.push(e[d]):(c=e[d],u=null,a=c.indexOf(":"),-1===a?u=util_getProperty(t,c):(s=a>0?c.substring(0,a).replace(regexpWhitespace,""):"",""===s&&(s="expression"),c=c.substring(a+1),"function"==typeof ModelUtils[s]&&(u=ModelUtils[s](c,t,r,o,i,l,n))),null!=u&&("object"==typeof u&&null==p&&(p=[h]),null==p?h+=u:p.push(u))),m=!m;return null==p?h:p}function Template(e){this.template=e,this.index=0,this.length=e.length}function Node(e,n){this.type=Dom.NODE,this.tagName=e,this.parent=n,this.attr={}}function TextNode(e,n){this.content=e,this.parent=n,this.type=Dom.TEXTNODE}function Fragment(){this.nodes=[]}function Component(e,n,t){this.tagName=e,this.parent=n,this.controller=t,this.attr={}}function builder_build(e,n,t,r,o,i){if(null==e)return r;var l,s=e.type;if(null==r&&1!==s&&(r=document.createDocumentFragment()),null==o&&(o=new Component),10===s||e instanceof Array){for(var u=0,a=e.length;a>u;u++)builder_build(e[u],n,t,r,o,i);return r}if(null==s&&(null!=e.tagName?s=1:null!=e.content&&(s=2)),1===s){var c,f,d=e.tagName,p=e.attr,h=document.createElement(d);for(c in p)"function"==typeof p[c]?(f=p[c]("attr",n,t,h,o,c),f instanceof Array&&(f=f.join(""))):f=p[c],f&&("function"==typeof CustomAttributes[c]?CustomAttributes[c](e,f,n,t,h,o):h.setAttribute(c,f));null!=r&&r.appendChild(h),null!=i&&(i.push(h),i=null),r=h}if(2===s){var u,a,m,g,v,y;if(g=e.content,"function"==typeof g)if(v=g("node",n,t,r,o),"string"==typeof v)r.appendChild(document.createTextNode(v));else{for(y="",u=0,a=v.length;a>u;u++)if(m=v[u],"object"!=typeof m)y+=m;else{if(""!==y&&(r.appendChild(document.createTextNode(y)),y=""),null==m.nodeType){y+=""+m;continue}r.appendChild(m)}""!==y&&r.appendChild(document.createTextNode(y))}else r.appendChild(document.createTextNode(g));return r}if(4===s){var b=e.controller,C="function"==typeof b?new b(n):b;if(null!=C){C.compoName=e.tagName,C.attr=util_extend(C.attr,e.attr),C.ID=++_controllerID;for(var c in C.attr)"function"==typeof C.attr[c]&&(C.attr[c]=C.attr[c]("attr",n,t,r,o,c));if(C.nodes=e.nodes,C.parent=o,null!=listeners&&null!=listeners.compoCreated)for(var x=listeners.compoCreated,a=x.length,u=0;a>u;u++)x[u](C,n,t,r);"function"==typeof C.renderStart&&C.renderStart(n,t,r),null!=C.tagName&&C.tagName!==e.compoName&&(C.nodes={tagName:C.tagName,attr:C.attr,nodes:C.nodes,type:1}),e=C}if(null==o.components?o.components=[e]:o.components.push(e),o=e,l=[],null!=o.model&&(n=o.model),"function"==typeof o.render)return o.render(n,t,r),r}var k=e.nodes;if(null!=k){null!=i&&null==l&&(l=i);for(var w=k instanceof Array,A=w===!0?k.length:1,N=0,O=null;A>N;N++)O=w===!0?k[N]:k,4===s&&1===O.type&&(O.attr["x-compo-id"]=e.ID),builder_build(O,n,t,r,o,l)}if(4===s&&"function"==typeof e.renderEnd&&e.renderEnd(l,n,t,r),null!=i&&i!==l)for(var E=i.length,T=l.length,u=-1;T>++u;)i[E+u]=l[u];return r}var regexpWhitespace=/\s/g,regexpEscapedChar={"'":/\\'/g,'"':/\\"/g,"{":/\\\{/g,">":/\\>/g,";":/\\>/g},hasOwnProp={}.hasOwnProperty,listeners=null;Template.prototype={skipWhitespace:function(){for(var e=this.template,n=this.index,t=this.length;t>n&&!(e.charCodeAt(n)>32);n++);return this.index=n,this},skipToAttributeBreak:function(){var e,n=this.template,t=this.index,r=this.length;do if(e=n.charCodeAt(++t),35===e&&123===n.charCodeAt(t+1))return this.index=t,this.sliceToChar("}"),this.index++,void 0;while(46!==e&&35!==e&&62!==e&&123!==e&&32!==e&&59!==e&&r>t);this.index=t},sliceToChar:function(e){for(var n,t,r=this.template,o=this.index,i=o,l=!1;(t=r.indexOf(e,o))>-1&&(o=t,92===r.charCodeAt(o-1));)l=!0,o++;return n=r.substring(i,o),this.index=o,l?n.replace(regexpEscapedChar[e],e):n}};var ConditionUtil=function(){function e(e,n){var t,r=n,o=e.index;if(null==r&&(e.skipWhitespace(),o=e.index,n=r=e.template.charCodeAt(e.index)),34===r||39===r)return e.index++,t=e.sliceToChar(39===r?"'":'"'),e.index++,t;do r=e.template.charCodeAt(++e.index);while(e.index<e.length&&32!==r&&33!==r&&60!==r&&61!==r&&62!==r&&40!==r&&41!==r&&38!==r&&124!==r);return t=e.template.substring(o,e.index),r=n,45===r||r>47&&58>r?t-0:116===r&&"true"===t?!0:102===r&&"false"===t?!1:{value:t}}function n(t,r){var o,i={assertions:null,join:null,left:null,right:null};null==r&&(r=[]),"string"==typeof t&&(t=new Template(t));e:for(;;){if(t.skipWhitespace(),t.index>=t.length)break;switch(o=t.template.charCodeAt(t.index)){case 61:case 60:case 62:case 33:var l=t.index;do o=t.template.charCodeAt(++t.index);while(t.index<t.length&&(60===o||61===o||62===o));i.sign=t.template.substring(l,t.index);continue;case 38:case 124:t.template.charCodeAt(++t.index)!==o&&console.error("Unary operation not valid"),i.join=38===o?"&&":"||",r.push(i),i={assertions:null,join:null,left:null,right:null},++t.index;continue;case 40:t.index++,n(t,i.assertions=[]);break;case 41:t.index++;break e;default:i[null==i.left?"left":"right"]=e(t,o);continue}}return(i.left||i.assertions)&&r.push(i),r}function t(t){if(null!=o[t])return o[t];var r=t.length,i={assertions:null,case1:null,case2:null},l=t.indexOf("?"),s=new Template(t);return-1!==l&&(s.length=l),i.assertions=n(s),-1!==l&&(s.length=r,s.index=l+1,i.case1=e(s),s.skipWhitespace(),58===s.template.charCodeAt(s.index)&&(s.index++,i.case2=e(s))),o[t]=i}function r(e,n){"string"==typeof e&&(e=t(e).assertions),null!=e.assertions&&(e=e.assertions);var o,i,l,s,u,a=!1;for(s=0,u=e.length;u>s;s++){if(o=e[s],o.assertions)a=r(o.assertions,n);else if(i="object"==typeof o.left?util_getProperty(n,o.left.value):o.left,null==o.right)a=i,"!"===o.sign&&(a=!a);else switch(l="object"==typeof o.right?util_getProperty(n,o.right.value):o.right,o.sign){case"<":a=l>i;break;case"<=":a=l>=i;break;case">":a=i>l;break;case">=":a=i>=l;break;case"!=":a=i!==l;break;case"==":a=i===l}if(a){if("&&"===o.join)continue;break}if("||"!==o.join&&"&&"===o.join)for(++s;u>s&&"||"!==e[s].join;s++);}return a}var o=[];return{condition:function(e,n){var o=t(e),i=r(o.assertions,n);return null!=o.case1&&(i=i?o.case1:o.case2),null==i?"":"object"==typeof i&&i.value?util_getProperty(n,i.value):i},isCondition:r,parse:t,out:{isCondition:r,parse:t}}}(),ExpressionUtil=function(){function e(e){this.parent=e,this.type=G,this.body=[],this.join=null}function n(e){this.parent=e}function t(e){this.type=X,this.body=e,this.join=null}function r(e,n){this.parent=e,this.type=q,this.body=n,this.arguments=[],this.next=null}function o(e,n){this.parent=e,this.type=Z,this.body=n,this.next=null}function i(e,n){this.parent=e,this.prefix=n}function l(n){this.body=n,this.case1=new e(this),this.case2=new e(this)}function s(e,n){null==e&&console.error("Undefined",e,n);var t=e.type;return G===t?(e.body.push(n),n):Q===t||z===t?e.body=n:Z===t||q===t?e.next=n:(console.error("Unsupported - append:",e,n),n)}function u(){if(0===arguments.length)return null;var n=new e(arguments[0].parent);return n.join=arguments[arguments.length-1].join,n.body=Array.prototype.slice.call(arguments),n}function a(e){if(e.type!==G)return null!=e.body&&"object"==typeof e.body&&a(e.body),void 0;for(var n,t,r,o=e.body,i=0,l=o.length;l>i;i++)a(o[i]);for(i=1;l>i&&(n=o[i],t=o[i-1],!(nn[t.join]>nn[n.join]));i++);if(i!==l){for(r=[o[0]],i=1;l>i;i++)n=o[i],t=o[i-1],nn[t.join]>nn[n.join]&&l-1>i&&(n=u(o[i],o[++i])),r.push(n);e.body=r}}function c(e,n){console.error("Expression parser:",e,n,y.substring(C))}function f(e,n,t,r){var o,i,l=e,s=e.body;if(null==i&&null!=n&&(o=n,i=n[s]),null==i&&null!=t&&(o=t,i=t[s]),null==i&&null!=r)do o=r,i=r[s];while(null==i&&null!=(r=r.parent));if(null!=i)for(;;){if(l.type===q){for(var u,a=[],f=0,d=l.arguments.length;d>f;f++)u=l.arguments[f],a[f]=v(u,n,t,r);i=i.apply(o,a)}if(null==i||null==l.next)break;if(l=l.next,s=l.body,o=i,i=i[s],null==i)break}return null==i&&((null==l||null!=l.next)&&c("Mask - Accessor error - ",s),null!=l&&l.type===q&&c("Mask - Accessor error - Function Call -",s)),i}function d(e){for(var n,t,r=!1,o=39===e?"'":'"',i=C;(n=y.indexOf(o,C))>-1&&(C=n,92===y.charCodeAt(n-1));)r=!0,C++;return t=y.substring(i,C),r===!0&&(t=t.replace(regexpEscapedChar[o],o)),t}function p(){for(var e,n,t=C;;){if(e=y.charCodeAt(C),46===e){if(n===!0)return c("Unexpected punc"),null;n=!0}if(!((e>=48&&57>=e||46===e)&&x>C))break;C++}return+y.substring(t,C)}function h(){var e,n=C,t=y.charCodeAt(C);if(34===t||39===t)return C++,e=d(t),C++,e;for(;;){t=y.charCodeAt(C);{if(!(t>47&&58!==t&&60!==t&&61!==t&&62!==t&&63!==t&&124!==t&&x>C))break;C++}}return y.substring(n,C)}function m(e){if(null==e&&C===x)return null;if(40===e)return P;if(41===e)return U;if(44===e)return $;if(46===e)return F;if(43===e)return A;if(45===e)return w;if(42===e)return O;if(47===e)return N;if(61===e)return y.charCodeAt(++C)!==e?(c("Not supported (Apply directive)"),null):j;if(33===e){var n=y.charCodeAt(C+1);return 61===n?(C++,R):_}if(62===e){var n=y.charCodeAt(C+1);return 61===n?(C++,S):L}if(60===e){var n=y.charCodeAt(C+1);return 61===n?(C++,M):D}return 38===e?y.charCodeAt(++C)!==e?(c("Single Binary Operator AND"),null):T:124===e?y.charCodeAt(++C)!==e?(c("Single Binary Operator OR"),null):E:e>=65&&90>=e||e>=97&&122>=e||95===e||36===e?B:e>=48&&57>=e?V:34===e||39===e?K:63===e?H:58===e?W:(c("Unexpected / Unsupported directive"),null)}function g(u){y=u,C=0,x=u.length,b=new e;for(var f,g,v=b,k=Y;;)if(x>C&&33>(f=y.charCodeAt(C)))C++;else{if(C>=x)break;if(g=m(f),null==g&&x>C)break;if(P!==g)if(U!==g)if($!==g)if(H!==g)if(W!==g)if(F===g&&(f=y.charCodeAt(C+1),f>=48&&57>=f?g=V:(g=B,C++)),v.type===G&&(v=s(v,new n(v))),w!==g&&_!==g||null!=v.body)if(w!==g&&A!==g&&O!==g&&N!==g&&T!==g&&E!==g&&j!==g&&R!==g&&L!==g&&S!==g&&D!==g&&M!==g){if((K===g||V===g)&&null!=v.body&&null==v.join){c("Directive Expected");break}if(K!==g)if(V!==g){if(B===g){for(var I=h();x>C;){f=y.charCodeAt(C);{if(!(33>f))break;C++}}if(40===f){k=en,C++;var Z=s(v,new r(v,I));v=Z.newArgument();continue}110===f&&"null"===I&&(I=null),102===f&&"false"===I&&(I=!1),116===f&&"true"===I&&(I=!0),v=s(v,"string"==typeof I?new o(v,I):new t(I))}}else s(v,new t(p(f)));else C++,s(v,new t(d(f))),C++}else{for(;v&&v.type!==Q;)v=v.parent;if(null==v.body){c("Unexpected operator",v);break}v.join=g;do v=v.parent;while(null!=v&&v.type!==G);null==v&&console.error("Unexpected parent",v),C++}else v=s(v,new i(v,g)),C++;else v=b.case2,C++;else b=new l(b),v=b.case1,C++;else{if(k!==en){c("Unexpected punctuation, comma");break}do v=v.parent;while(null!=v&&v.type!==q);if(null==v){c("OutOfAst Exception - next argument");break}v=v.newArgument(),C++}else{var X=G;k===en&&(k=Y,X=q);do v=v.parent;while(null!=v&&v.type!==X);if(X===G&&(v=v.parent),null==v){c("OutOfAst Exception - body closed");break}C++}else v=s(v,new n(v)),v=s(v,new e(v)),C++}return null==v.body&&v.type===Q&&c("Unexpected end of expression"),a(b),b}function v(e,n,t,r){var o,i;if(null==e)return null;i="string"==typeof e?k.hasOwnProperty(e)===!0?k[e]:k[e]=g(e):e;var l=i.type,o=null;if(G===l){var s,u;e:for(var a,c=0,d=i.body.length;d>c;c++)if(a=i.body[c],s=v(a,n,t,r),null!=u){if(u.join===T)if(o)o=s;else for(;d>c&&i.body[c].join!==E;c++);if(u.join===E){if(o)break e;if(s){o=s;break e}}switch(u.join){case w:o-=s;break;case A:o+=s;break;case N:o/=s;break;case O:o*=s;break;case R:o=o!=s;break;case j:o=o==s;break;case L:o=o>s;break;case S:o=o>=s;break;case D:o=s>o;break;case M:o=s>=o}u=a}else u=a,o=s}if(Q===l)return v(i.body,n,t,r);if(X===l)return i.body;if(Z===l||q===l)return f(i,n,t,r);if(q===l){for(var a,p=[],c=0,d=i.arguments.length;d>c;c++)a=i.arguments[c],p[c]=v(a,n,t,r);return util_callFunction(i.body,p,n,t,r)}if(z===l)switch(o=v(i.body,n,t,r),i.prefix){case w:o=-o;break;case _:o=!o}return J===l&&(o=v(i.body,n,t,r),o=v(o?i.case1:i.case2,n,t,r)),o}var y,b,C=0,x=0,k={},w="-",A="+",N="/",O="*",E="||",T="&&",_="!",j="==",R="!=",L=">",S=">=",D="<",M="<=",I=".",P=20,U=21,$=22,F=23,H=24,W=25,B=30,K=31,V=32,G=1,Q=2,Z=3,q=4,X=6,z=9,J=10,Y=1,en=2,nn={};nn[I]=1,nn[N]=2,nn[O]=2,nn[w]=3,nn[A]=3,nn[L]=4,nn[S]=4,nn[D]=4,nn[M]=4,nn[j]=5,nn[R]=5,nn[T]=6,nn[E]=6,n.prototype={constructor:n,type:Q,join:null,body:null},r.prototype={constructor:r,newArgument:function(){var n=new e(this);return this.arguments.push(n),n}},i.prototype={constructor:i,type:z,body:null},l.prototype={constructor:l,type:J,case1:null,case2:null};var tn=function(){function e(e,n){return null==e?n:null==n?e:("string"==typeof e&&(e=[e]),"string"==typeof n?(e.push(n),e):e.concat(n))}return function n(t){if(null==t)return null;"string"==typeof t&&(t=g(t));var r,o;if(G===t.type)for(var i=0,l=t.body.length;l>i;i++)o=n(t.body[i]),r=e(r,o);if(Z===t.type){for(var s=t.body,u=t.next;null!=u;){if(q===u.type)return r=n(u),null;if(Z!==u.type)return console.error("Ast Exception: next should be a symbol/function ref"),null;s+="."+u.body,u=u.next}return s}if((Q===t.type||z===t.type||J===t.type)&&(o=n(t.body),r=e(r,o)),J===t.type&&(o=n(b.case1),r=e(r,o),o=n(b.case2),r=e(r,o)),q===t.type)for(var i=0,l=t.arguments.length;l>i;i++)o=n(t.arguments[i]),r=e(r,o);return r}}();return{parse:g,eval:v,varRefs:tn}}(),ModelUtils={condition:ConditionUtil.condition,expression:function(e,n,t,r,o){return ExpressionUtil.eval(e,n,t,o)}},CustomAttributes={"class":null,id:null,style:null,name:null,type:null},CustomTags={div:null,span:null,input:null,button:null,textarea:null,select:null,option:null,h1:null,h2:null,h3:null,h4:null,h5:null,h6:null,a:null,p:null,img:null,table:null,td:null,tr:null,pre:null,ul:null,li:null,ol:null,i:null,b:null,strong:null,form:null},Dom={NODE:1,TEXTNODE:2,FRAGMENT:3,COMPONENT:4,CONTROLLER:9,SET:10,Node:Node,TextNode:TextNode,Fragment:Fragment,Component:Component};Node.prototype={constructor:Node,type:Dom.NODE,tagName:null,parent:null,attr:null,nodes:null,__single:null},TextNode.prototype={type:Dom.TEXTNODE,content:null,parent:null},Fragment.prototype={constructor:Fragment,type:Dom.FRAGMENT,nodes:null},Component.prototype={constructor:Component,type:Dom.COMPONENT,parent:null,attr:null,controller:null,nodes:null,components:null};var Parser=function(e,n,t,r){function o(e){for(var n=-1;-1!==(n=e.indexOf(l,n))&&e.charCodeAt(n+1)!==a;)n++;if(-1===n)return e;for(var t=[],r=0,o=0,i=0;;){var i=e.indexOf(s,n+2);if(-1===i)break;for(t[o++]=r===n?"":e.substring(r,n),t[o++]=e.substring(n+2,i),r=n=i+1;-1!==(n=e.indexOf(l,n))&&e.charCodeAt(n+1)!==a;)n++;if(-1===n)break}return e.length>r&&(t[o]=e.substring(r)),e=null,function(e,n,r,o,i,l){if(null==e){for(var s,u="",a=0,c=t.length;c>a;a++)s=t[a],u+=1===a%2?"~["+s+"]":s;return u}return util_interpolate(t,e,n,r,o,i,l)}}function i(e,n,t,r){for(var o,i=0,l=0,s=0,u=/[\r\n]+/g,a={2:"tag",3:"tag",5:"attribute key",6:"attribute value",8:"literal"}[t];;){if(o=u.exec(e),null==o)break;if(o.index>n)break;l++,i=o.index}s=n-i;var c=["Mask - Unexpected:",r,"at(",l,":",s,") [ in",a,"]"];console.error(c.join(" "),{template:e,stopped:e.substring(n)})}var l="~",s="]",u=126,a=91,c=93;return{parse:function(l){for(var s,f,d,p,h,m,g,v=new t,y=v,b=2,C=3,x=0,k=l.length,w=2,A=3,N=5,O=6,E=7,T=8,_=9;;)if(k>x&&33>(m=l.charCodeAt(x)))x++;else if(47!==m||47!==l.charCodeAt(x+1)){if(C===N&&(null!=s&&(v.attr["class"]=o(s),s=null),null!=d&&(v.attr[d]=d,d=null,f=null)),null!=f){if(b===N)null==d?d=f:p=f,null!=d&&null!=p&&("class"!==d?v.attr[d]=p:s=null==s?p:s+" "+p,d=null,p=null);else if(C===A)h=null!=CustomTags[f]?new r(f,v,CustomTags[f]):new e(f,v),null==v.nodes?v.nodes=[h]:v.nodes.push(h),v=h,b=N;else if(C===T){if(h=new n(f,v),null==v.nodes?v.nodes=[h]:v.nodes.push(h),v.__single===!0)do v=v.parent;while(null!=v&&null!=v.__single);b=w}f=null}if(x>=k){b===N&&(null!=s&&(v.attr["class"]=o(s)),null!=d&&(v.attr[d]=d));break}if(b===_){for(v=v.parent;null!=v&&null!=v.__single;)v=v.parent;b=w}if(123!==m)if(62!==m)if(59!==m||null==v.nodes)if(59!==m&&125!==m)if(39!==m&&34!==m)if(b!==w||(C=A,b=A,46!==m&&35!==m)){if(b===N)if(46===m)x++,d="class",b=E;else if(35===m)x++,d="id",b=E;else{if(61===m){x++,b=O;continue}if(null!=d){f=d;continue}}(b===O||b===E)&&(C=b,b=N);var j=null;for(g=x;k>x;){if(m=l.charCodeAt(x),m===u&&l.charCodeAt(x+1)===a){j=!0,++x;do m=l.charCodeAt(++x);while(m!==c&&k>x)}if(39===m||34===m||47===m||60===m){i(l,x,b,String.fromCharCode(m));break}if(C!==O&&(46===m||35===m||61===m))break;if(62===m||123===m||33>m||59===m)break;x++}if(f=l.substring(g,x),!f){i(l,x,b,"*EMPTY*");break}if(j===!0&&b===A){i(l,x,b,"Tag Names cannt be interpolated (in dev)");break}j===!0&&(b===N&&"class"===d)==!1&&(f=o(f))}else f="div";else{b===O?b=N:C=b=T,x++;var R,L=!1,S=39===m?"'":'"';for(g=x;(R=l.indexOf(S,x))>-1&&(x=R,92===l.charCodeAt(R-1));)L=!0,x++;f=l.substring(g,x),L===!0&&(f=f.replace(regexpEscapedChar[S],S)),f=o(f),x++}else x++,C=b,b=_;else x++;else C=b,b=w,x++,v.__single=!0;else C=b,b=w,x++}else for(x++;10!==m&&13!==m&&k>x;)m=l.charCodeAt(++x);if(isNaN(m))throw console.log(m,_index,_length),"";return null!=v.parent&&v.parent!==y&&v.parent.__single!==!0&&null!=v.nodes&&console.warn("Mask - ",v.parent.tagName,JSON.stringify(v.parent.attr),"was not proper closed."),1===y.nodes.length?y.nodes[0]:y},cleanObject:function(e){if(e instanceof Array){for(var n=0;e.length>n;n++)this.cleanObject(e[n]);return e}return delete e.parent,delete e.__single,null!=e.nodes&&this.cleanObject(e.nodes),e},setInterpolationQuotes:function(e,n){return e&&2===e.length?n&&1===n.length?(u=e.charCodeAt(0),a=e.charCodeAt(1),c=n.charCodeAt(0),s=n,l=e.charAt(0),void 0):(console.error("Interpolation End must be of 1 Character"),void 0):(console.error("Interpolation Start must contain 2 Characters"),void 0)}}}(Node,TextNode,Fragment,Component),_controllerID=0,cache={},Mask={render:function(e,n,t,r,o){return null!=r&&"function"!=typeof r.appendChild&&(console.error(".render(template[, model, cntx, container, controller]","Container should implement .appendChild method"),console.warn("Args:",arguments)),"string"==typeof e&&(e=hasOwnProp.call(cache,e)?cache[e]:cache[e]=Parser.parse(e)),builder_build(e,n,t,r,o)},compile:Parser.parse,parse:Parser.parse,build:builder_build,registerHandler:function(e,n){CustomTags[e]=n},getHandler:function(e){return null!=e?CustomTags[e]:CustomTags},registerAttrHandler:function(e,n){CustomAttributes[e]=n},registerUtility:function(e,n){ModelUtils[e]=n},clearCache:function(e){"string"==typeof e?delete cache[e]:cache={}},ValueUtils:{condition:ConditionUtil.condition,out:ConditionUtil},Utils:{Condition:ConditionUtil,Expression:ExpressionUtil,getProperty:util_getProperty},Dom:Dom,plugin:function(source){eval(source)},on:function(e,n){null==listeners&&(listeners={}),(listeners[e]||(listeners[e]=[])).push(n)},delegateReload:function(){},setInterpolationQuotes:Parser.setInterpolationQuotes};Mask.renderDom=Mask.render,function(e){var n=function(){function n(e){for(var n="";e--;)n+=" ";return n}function t(e,t,o){var i,l;null==t&&(t=0),null==o&&(i=!0,o=[]);var s=o.length;if(e.type===f.FRAGMENT&&(e=e.nodes),e instanceof Array)for(l=0;e.length>l;l++)r(e[l],t,o);else r(e,t,o);var u=n(t);for(l=s;o.length>l;l++)o[l]=u+o[l];return i?o.join(0===c?"":"\n"):void 0}function r(e,n,r){return"string"==typeof e.content?(r.push(u(e.content)),void 0):"function"==typeof e.content?(r.push(u(e.content())),void 0):i(e)?(r.push(o(e)+";"),void 0):l(e)?(r.push(o(e)+" > "),t(s(e),c,r),void 0):(r.push(o(e)+"{"),t(e.nodes,c,r),r.push("}"),void 0)}function o(e){var n=e.tagName,t=e.attr.id||"",r=e.attr["class"]||"";"function"==typeof t&&(t=t()),"function"==typeof r&&(r=r()),t&&(t=-1!==t.indexOf(" ")?"":"#"+t),r&&(r="."+r.split(" ").join("."));var o="";for(var i in e.attr)if("id"!==i&&"class"!==i){var l=e.attr[i];"function"==typeof l&&(l=l()),(a===!1||/\s/.test(l))&&(l=u(l)),o+=" "+i+"="+l}return"div"===n&&(t||r)&&(n=""),n+t+r+o}function i(e){return null==e.nodes||e.nodes instanceof Array&&0===e.nodes.length}function l(e){return e.nodes&&(e.nodes instanceof Array==!1||1===e.nodes.length)}function s(e){return e.nodes instanceof Array?e.nodes[0]:e.nodes}function u(e){return-1===e.indexOf('"')?'"'+e.trim()+'"':-1===e.indexOf("'")?"'"+e.trim()+"'":'"'+e.replace(/"/g,'\\"').trim()+'"'}var a,c,f=e.Dom;return function(n,r){return"string"==typeof n&&(n=e.parse(n)),"number"==typeof r?(c=r,a=0===c):(c=r&&r.indent||4,a=0===c||r&&r.minimizeAttributes),t(n)}}();Mask.stringify=n}(Mask),function(e){function n(){}function t(e,n,t,o){null==e.nodes&&Compo!==void 0&&Compo.ensureTemplate(e);var i=util_getProperty(n,e.attr.foreach||e.attr.each),l=e.nodes,s=null;if(e.nodes=[],e.template=l,e.container=o,i instanceof Array!=!1){for(var u,a=0,c=i.length;c>a;a++)u=i[a],s=new Component,s.nodes=l,s.model=u,s.container=o,e.nodes[a]=s;for(var f in r)e[f]=r[f]}}e.registerHandler("%",n),n.prototype={constructor:n,renderStart:function(e,n,r){var o=this.attr;if(null!=o.use)return this.model=util_getProperty(e,o.use),void 0;if(null==o["debugger"]){if(null!=o.log){var i=o.log,l=util_getProperty(e,i);return console.log("Key: %s, Value: %s",i,l),void 0}if(this.model=e,null!=o["if"]){var s=o["if"];return this.state=ConditionUtil.isCondition(s,e),this.state||(this.nodes=null),void 0}if(null!=o["else"]){var u=this.parent.components,a=u&&u[u.length-1];return null!=a&&"%"===a.compoName&&null!=a.attr["if"]?(a.state&&(this.nodes=null),void 0):(console.error("Previous Node should be \"% if='condition'\"",a,this.parent),void 0)}(null!=o.each||null!=o.foreach)&&t(this,e,n,r)}},render:null};var r={append:function(n){var t;t=new Component,t.nodes=this.template,t.model=n,e.render(t,n,null,this.container,this)}}}(Mask),function(e){function n(){}function t(){}var r={};e.templates=r,e.registerHandler(":template",n),n.prototype.render=function(){return null!=this.attr.id?(console.warn("Template Should be defined with ID attribute for future lookup"),void 0):(r[this.attr.id]=this,void 0)},e.registerHandler(":html",t),t.prototype.render=function(e,n,t){var r=null;if(null!=this.attr.template){var o=this.attr.template[0];"#"===o&&(r=document.getElementById(this.attr.template.substring(1)).innerHTML)}return this.nodes&&(r=this.nodes[0].content),null==r?(console.warn("No HTML for node",this),void 0):(t.innerHTML=r,void 0)}}(Mask),function(e){function n(e,n){for(var t=0,r=n.length-1;r>t;t++){var o=n.shift();null==e[o]&&(e[o]={}),e=e[o]}return e}function t(e,n){for(var t=n.split("."),r=t.length,o=0;r>o;o++){if(null==e)return null;e=e[t[o]]}return e}function r(e,n,t){for(var r=n.split("."),o=r.length,i=0,l=null;o-1>i;i++)l=r[i],null==e[l]&&(e[l]={}),e=e[l];e[r[i]]=t}function o(e,r,o){if(null==e.__observers&&Object.defineProperty(e,"__observers",{value:{},enumerable:!1}),e.__observers[r]){e.__observers[r].push(o);var i=t(e,r);return i instanceof Array&&a(i,o),void 0}var l=e.__observers[r]=[o],s=r.split("."),u=s.length>1?n(e,s):e,c=s[0],f=u[c];Object.defineProperty(u,c,{get:function(){return f},set:function(e){f=e;for(var n=0,t=l.length;t>n;n++)l[n](e);f instanceof Array&&a(f,o)}}),f instanceof Array&&a(f,o)}function i(e,n,o){if(null!=e.__observers&&null!=e.__observers[n]){var i=t(e,n);if(2===arguments.length)return r(e,n,i),delete e.__observers[n],void 0;s(e.__observers[n],o),i instanceof Array&&s(i.__observers,o)}}function l(e,n){if(null==n)return e;null==e&&(e={});for(var t in n)e[t]=n[t];return e}function s(e){if(null==e)return!1;for(var n,t=0,r=e.length,o=1,i=arguments.length,l=0;r>t;t++)for(n=e[t],o=1;i>o;o++)if(arguments[o]===n){e.splice(t,1),t--,r--,l++;break}return l+1===i}function u(e){return Array.prototype.slice.call(e)}function a(e,n){function t(n){e[n]=function(){var e=this.__observers,t=u(arguments),r=Array.prototype[n].apply(this,t);if(null==e||0===e.length)return r;for(var o,i=0,l=e.length;l>i;i++)o=e[i],"function"==typeof o&&o(this,n,t);return r}}null==e.__observers&&Object.defineProperty(e,"__observers",{value:[],enumerable:!1});for(var r=0,o=["push","unshift","splice","pop","shift","reverse","sort"],i=o.length;i>r;r++)t(o[r]);e.__observers.push(n),e=null}function c(e){return e.parentNode.removeChild(e)}function f(e){if(null!=e)for(var n=0,t=e.length;t>n;n++)c(e[n])}function d(e,n){return n.parentNode.insertBefore(e,n.nextSibling)}function p(e,n){return n.parentNode.insertBefore(e,n)}function h(e,n,t){return"function"==typeof E?(E(e).on(n,t),void 0):null!=e.addEventListener?(e.addEventListener(n,t,!1),void 0):(e.attachEvent&&e.attachEvent("on"+n,t),void 0)}function m(e,n,t){if(null==e.components)return d(t,e.placeholder);for(var r,o=e.components,i=null,l=!0,s=o.length,u=n;s>u;u++)if(r=o[u].elements,r&&r.length){i=r[0];break}if(null==i)for(l=!1,u=s>n?n:s;--u>-1;)if(r=o[u].elements,r&&r.length){i=r[r.length-1];break}return null==i&&(i=e.placeholder),l?p(t,i):d(t,i)}function g(n,t,r,o,i){return e.render(t,r,o,i,n)}function v(e,n){if(null==e)return!1;f(e.elements),e.elements=null,Compo!==void 0&&Compo.dispose(e);var t=n&&n.components||e.parent&&e.parent.components;return null==t?(console.error("Parent Components Collection is undefined"),!1):s(t,e)}function y(e){Compo!==void 0&&Compo.signal.emitIn(e,"domInsert")}function b(e,n){if("function"==typeof e.dispose){var t=e.dispose;return e.dispose=function(){n(),t()},void 0}e.dispose=n}function C(e,n,t,r,i){var l=j(e),s=R(l),u=_(l,n);if(null==s)return u;if("string"==typeof s)return o(n,s,i),u;for(var a,c=0,f=s.length;f>c;c++)a=s[c],o(n,a,i);return u}function x(e,n,t){var r=j(e),o=R(r);if(null!=o){if("string"==typeof o)return i(n,o,t),void 0;for(var l=0,s=o.length;s>l;l++)i(n,o[l],t)}}function k(e,n,t,r,o){return function(){o(_(e,n,t,r))}}function w(){}function A(){}function N(){}function O(e,n){if(null==n&&(n=[]),null==e.components)return n;for(var t,r=e.components,o=0,i=r.length;i>o;o++)t=r[o],"validate"!==t.compoName?O(t):n.push(t);return n}var E=window.jQuery||window.Zepto||window.$;null==E&&console.warn("Without jQuery/Zepto etc. binder is limited (mouse dom event bindings)");var T=e.Utils.Expression,_=T.eval,j=T.parse,R=T.varRefs,L=function(){function n(e,n,t,r){null==r&&(r=":bind"===t.compoName?"single":"dual"),this.node=t,this.model=e,this.element=n,this.value=t.attr.value,this.property=t.attr.property||("single"===r?"element.innerHTML":"element.value"),this.setter=t.attr.setter,this.getter=t.attr.getter,this.dismiss=0,this.bindingType=r}function s(e){var n=e.node.attr.value,t=e.model,r=e.objectChanged=e.objectChanged.bind(e);if(o(t,n,r),"dual"===e.bindingType){var i=e.element,l=e.node.attr.changeEvent||"change",s=e.domChanged.bind(e);h(i,l,s)}return e.objectChanged(),e}e.registerBinding=function(e,n){u[e]=n};var u={},a=e.Utils.Expression;return n.create=function(e,t,r,o){var i,a=r.attr.bindingProvider||t.tagName.toLowerCase(),c=u[a];return c instanceof Function?new c(e,t,r,o):(i=new n(e,t,r,o),null!=c&&l(i,c),s(i))},n.prototype={constructor:n,dispose:function(){i(this.model,this.value,this.objectChanged)},objectChanged:function(e){this.dismiss-->0||(null==e&&(e=this.objectWay.get(this.model,this.node.attr.value)),this.domWay.set(this,e))},domChanged:function(){var e=this.domWay.get(this);if(this.node.validations)for(var n,t=0,r=this.node.validations.length;r>t;t++)if(n=this.node.validations[t],n.validate(e,this.element,this.objectChanged.bind(this))===!1)return;this.dismiss=1,this.objectWay.set(this.model,this.node.attr.value,e),this.dismiss=0},objectWay:{get:function(e,n){return":"===n[0]?a.eval(n.substring(1),e):t(e,n)},set:function(e,n,t){r(e,n,t)}},domWay:{get:function(e){if(e.getter){var n=e.node.parent;return null==n||"function"!=typeof n[e.getter]?(console.error("Mask.bindings: Getter should be a function",e.getter,e),null):n[e.getter]()}return t(e,e.property)},set:function(e,n){if(e.setter){var t=e.node.parent;if(null==t||"function"!=typeof t[e.setter])return console.error("Mask.bindings: Getter should be a function",e.getter,e),void 0;t[e.setter](n)}else r(e,e.property,n)}}},n}();e.registerHandler(":visible",w),w.prototype={constructor:w,refresh:function(n,t){t.style.display=e.Utils.Condition.isCondition(this.attr.check,n)?"":"none"},renderStart:function(e,n,t){this.refresh(e,t),this.attr.bind&&o(e,this.attr.bind,this.refresh.bind(this,e,t))}},function(){function n(){}e.registerHandler(":bind",n),n.prototype={constructor:n,renderStart:function(e,n,t){this.provider=L.create(e,t,this,"single")},dispose:function(){this.provider&&"function"==typeof this.provider.dispose&&this.provider.dispose()}}}(),e.registerHandler(":dualbind",A),A.prototype={constructor:A,renderEnd:function(e,n,t,r){if(this.components)for(var o,i=0,l=this.components.length;l>i;i++)o=this.components[i],":validate"===o.compoName&&(this.validations||(this.validations=[])).push(o);this.provider=L.create(n,r,this)},dispose:function(){this.provider&&"function"==typeof this.provider.dispose&&this.provider.dispose()}},function(){function n(){}function r(e,n,t){console.warn("Validate Notification:",e,n);var r=E(e).next(".-validate-invalid");0===r.length&&(r=E("<div>").addClass("-validate-invalid").html("<span></span><button>cancel</button>").insertAfter(e)),r.children("button").off().on("click",function(){r.hide(),t&&t()}).end().children("span").text(n).end().show()}function o(e){E(e).next(".-validate-invalid").hide()}e.registerValidator=function(e,n){i[e]=n},e.registerHandler(":validate",n),n.prototype={constructor:n,renderStart:function(e,n,t){this.element=t,this.model=e},validate:function(e,n,i){null==n&&(n=this.element),this.attr.getter&&(e=t({node:this,element:n},this.attr.getter)),null==this.validators&&this.initValidators();for(var l,s=0,u=this.validators.length;u>s;s++)if(l=this.validators[s],l.validate(this,e)===!1)return r(n,this.message,i),!1;return o(n),!0},initValidators:function(){this.validators=[],this.message=this.attr.message,delete this.attr.message;for(var e in this.attr)if(e in i!=!1){var n=i[e];"function"==typeof n&&(n=new n(this)),this.validators.push(n)}else console.error("Unknown Validator:",e,this)}};var i={match:{validate:function(e,n){return RegExp(e.attr.match).test(n)}},unmatch:{validate:function(e,n){return!RegExp(e.attr.unmatch).test(n)}},minLength:{validate:function(e,n){return n.length>=parseInt(e.attr.minLength,10)}},maxLength:{validate:function(e,n){return n.length<=parseInt(e.attr.maxLength,10)}}}}(),e.registerHandler(":validate:group",N),N.prototype={constructor:N,validate:function(){for(var e,n=O(this),t=0,r=n.length;r>t;t++)if(e=n[t],!e.validate())return!1;return!0}},function(){function n(e,n,t,r,o){return function(n){switch(e){case"node":t.textContent=n;break;case"attr":var i=t.getAttribute(o),l=i?i.replace(r,n):n;t.setAttribute(o,l),r=n}}}e.registerUtility("bind",function(e,t,r,o,i,l,s){var u=_(e,t,r,i),a=n(s,e,o,u,l),c=k(e,t,r,i,a);return C(e,t,r,i,c),"node"===s&&(o=document.createTextNode(u)),b(i,function(){x(e,t,c)}),"node"===s?o:"attr"===s?u:(console.error("Unknown binding type",arguments),"Unknown")})}(),function(e){function n(){}e.registerHandler("%%",n);var t=function(){var n={refresh:function(n){if(this.model=n,this.elements)for(var t,r=0,o=this.elements.length;o>r;r++)t=this.elements[r],t.parentNode.removeChild(t);Compo!==void 0&&Compo.dispose(this),e.render(this.nodes,this.model,this.cntx).insertBefore(this.placeholder)}};return function(e,t,r,o){var i=e.attr.use;e.placeholder=document.createComment(""),e.model=C(i,t,r,e,n.refresh.bind(e)),o.appendChild(e.placeholder)}}(),r=function(){return function(e,n,t){function r(e){console.log("Logger > Key: %s, Value: %s",o,e)}var o=e.attr.log,i=C(o,n,t,e,r);r(i),e=null,n=null,t=null}}(),o=function(){var n={refresh:function(n){(null!=this.elements||n)&&(null==this.elements?(e.render(this.template,this.model,this.cntx,null,this).insertBefore(this.placeholder),this.$=E(this.elements)):(null==this.$&&(this.$=E(this.elements)),this.$[n?"show":"hide"]()),this.onchange&&this.onchange(n))
}};return function(e,t,r,o){var i=e.attr["if"];e.placeholder=document.createComment(""),e.template=e.nodes,e.state=!!C(i,t,r,e,n.refresh.bind(e)),e.state||(e.nodes=null),o.appendChild(e.placeholder)}}(),i=function(){var e={refresh:function(e){if(null!=this.elements||!e){if(null==this.elements)return p(g(this,this.template,this.model,this.cntx)),this.$=E(this.elements),void 0;null==this.$&&(this.$=E(this.elements)),this.$[e?"hide":"show"]()}}};return function(n,t,r,o){var i=n.parent.components,l=i&&i[i.length-1];return n.template=n.nodes,n.placeholder=document.createComment(""),null==l||"%%"!==l.compoName||null==l.attr["if"]?(console.error('Mask.Binding: Binded ELSE should be after binded IF - %% if="expression" { ...'),void 0):(l.onchange=e.refresh.bind(n),l.state&&(n.nodes=null),o.appendChild(n.placeholder),void 0)}}(),l=function(){function n(e,n){var t=[];if(n instanceof Array==!1)return t;for(var r,o=0,l=n.length;l>o;o++){switch(r=n[o],typeof r){case"string":case"number":case"boolean":r=n[o]=Object(r)}t[o]=new i(e.template,r,e)}return t}function t(e,n){for(var t=e.components,r=0,o=t.length,i=0,l=null,s=null,u=null,a=document.createDocumentFragment(),c=[];o>r;r++)if(u=t[r],null!=u.elements&&0!==u.elements.length)for(i=0,l=u.elements.length;l>i;i++)s=u.elements[i],s.parentNode.removeChild(s);e:for(i=0,l=n.length;l>i;i++){for(r=0;o>r;r++)if(n[i]===t[r].model){c[i]=t[r];continue e}console.warn("No Model Found for",n[i])}for(r=0,o=c.length;o>r;r++)if(u=c[r],null!=u.elements&&0!==u.elements.length)for(i=0,l=u.elements.length;l>i;i++)s=u.elements[i],a.appendChild(s);e.components=c,p(a,e.placeholder)}function r(e,t,r,i,l){if(null!=t&&null!=r){var s=t,u=t+r;for(u>e.components.length&&(u=e.components.length);u>s;s++)v(e.components[s],e)&&(s--,u--)}if(null!=i&&l&&l.length){var a=new o,c=n(e,l),f=g(a,c),d=a.components;m(e,i,f),y(a),null==e.components&&(e.components=[]),e.components.splice.apply(e.components,[i,0].concat(d))}}var o=e.Dom.Component,i=function(){function e(e,n,t){this.nodes=e,this.model=n,this.parent=t}var n=o.prototype;e.prototype={constructor:l,renderEnd:function(e){this.elements=e}};for(var t in n)e.prototype[t]=n[t];return e}(),l={append:function(n){var t=new i(this.template,n,this);e.render(t,n,null,this.container,this)}},s={refresh:function(e,o,i){var l,s,u=0;if(null==o){for(var l,u=0,a=this.components.length;a>u;u++)l=this.components[u],v(l,this)&&(u--,a--);return this.components=[],this.nodes=n(this,e),p(g(this,this.nodes),this.placeholder),void 0}for(s=e.length;s>u;u++)switch(l=e[u],typeof l){case"string":case"number":case"boolean":e[u]=Object(l)}switch(o){case"push":r(this,null,null,e.length,e.slice(e.length-1));break;case"pop":r(this,e.length,1);break;case"unshift":r(this,null,null,0,e.slice(0,1));break;case"shift":r(this,0,1);break;case"splice":var c=i[0],f=1===i.length?this.components.length:i[1],d=i.length>2?e.slice(i[0],i.length-2+i[0]):null;r(this,c,f,c,d);break;case"sort":case"reverse":t(this,e)}},dispose:function(){x(this.expr,this.model,this.refresh)}};return function(e,t,r,o){null==e.nodes&&Compo!==void 0&&Compo.ensureTemplate(e),e.refresh=s.refresh.bind(e),e.dispose=s.dispose.bind(e),e.expr=e.attr.each||e.attr.foreach;var i=C(e.expr,t,r,e,e.refresh);e.template=e.nodes,e.container=o,e.placeholder=document.createComment(""),o.appendChild(e.placeholder);for(var u in l)e[u]=l[u];e.nodes=n(e,i)}}();n.prototype={constructor:n,elements:null,renderStart:function(e,n,s){var u=this.attr;if(null==u["debugger"])return null!=u.use?(t(this,e,n,s),void 0):null!=u.log?(r(this,e,n,s),void 0):(this.model=e,null!=u["if"]?(o(this,e,n,s),void 0):null!=u["else"]?(i(this,e,n,s),void 0):((null!=u.each||null!=u.foreach)&&l(this,e,n,s),void 0))},render:null,renderEnd:function(e){this.elements=e}}}(e)}(Mask);var jMask=function(){function e(e,n){if(null==e&&(e={}),null==n)return e;for(var t in n)e[t]=n[t];return e}function n(e,n){for(var t=0,r=e.length;r>t;t++)n(e[t],t)}function t(e,n){if(null==e)return console.error("Can not remove myself from parent",n),void 0;var t=e.indexOf(n);return-1===t?(console.error("Can not remove myself from parent",n,t),void 0):(e.splice(t,1),void 0)}function r(e,n,t){if(null==e&&console.warn("selector is null for type",n),"object"==typeof e)return e;var r,o,i;if(null==r)switch(e[0]){case"#":r="id",e=e.substring(1),o="attr";break;case".":r="class",e=RegExp("\\b"+e.substring(1)+"\\b"),o="attr";break;default:r=n===c.SET?"tagName":"compoName"}return i="up"===t?"parent":n===c.SET?"nodes":"components",{key:r,prop:o,selector:e,nextKey:i}}function o(e,n,t){"string"==typeof n&&(null==t&&(t=c[e.compoName?"CONTROLLER":"SET"]),n=r(n,t));var o=n.prop?e[n.prop]:e;if(null==o)return!1;if(null!=n.selector.test){if(n.selector.test(o[n.key]))return!0}else if(o[n.key]===n.selector)return!0;return!1}function i(e,n){if(null==n)return e;for(var t,r=[],i=0,l=e.length;l>i;i++)t=e[i],o(t,n)&&r.push(t);return r}function l(e,n,t){if(null==t&&(t=[]),e instanceof Array){for(var r=0,i=e.length;i>r;r++)l(e[r],n,t);return t}o(e,n)&&t.push(e);var s=e[n.nextKey];return null!=s&&l(s,n,t),t}function s(n,t){var r={type:1,tagName:1,compoName:1,controller:1},o={parent:t};for(var i in n)1===r[i]&&(o[i]=n[i]);n.attr&&(o.attr=e({},n.attr));var l=n.nodes;if(null!=l&&l.length>0){o.nodes=[];for(var u=l instanceof Array,a=u===!0?l.length:1,c=0;a>c;c++)o.nodes[c]=s(u===!0?l[c]:l,o)}return o}function u(e){for(var n,t=e;null!=t;)n=t,t=t.nodes&&t.nodes[0];return n}function a(e){return this instanceof a==!1?new a(e):null==e?this:e.type===c.SET?e:this.add(e)}var c=mask.Dom,f=mask.render,d=mask.parse,p=(global.Compo||mask.Compo).signal.emitIn;return a.prototype={constructor:a,type:c.SET,length:0,components:null,add:function(e){var n,t;if("string"==typeof e&&(e=d(e)),e instanceof Array){for(n=0,t=e.length;t>n;n++)this.add(e[n]);return this}"function"==typeof e&&null!=e.prototype.type&&(e={controller:e,type:c.COMPONENT});var r=e.type;if(!r)return console.error("Only Mask Node/Component/NodeText/Fragment can be added to jmask set",e),this;if(r===c.FRAGMENT){var o=e.nodes;for(n=0,t=o.length;t>n;)this[this.length++]=o[n++];return this}if(r===c.CONTROLLER&&(null!=this.components&&(this.type=c.CONTROLLER),null!=e.nodes))for(n=e.nodes.length;0!==n;)e.nodes[--n].parent=e;return this[this.length++]=e,this},toArray:function(){return Array.prototype.slice.call(this)},render:function(e,n,t){if(this.components=[],1===this.length)return f(this[0],e,n,t,this);null==t&&(t=document.createDocumentFragment());for(var r=0,o=this.length;o>r;r++)f(this[r],e,n,t,this);return t},prevObject:null,end:function(){return this.prevObject||this},pushStack:function(e){var n;return n=a(e),n.prevObject=this,n},controllers:function(){return null==this.components&&console.warn("Set was not rendered"),this.pushStack(this.components||[])},mask:function(e){if(null!=e)return this.empty().append(e);if(arguments.length)return this;var n;if(0===this.length)n=new c.Node;else if(1===this.length)n=this[0];else{n=new c.Fragment;for(var t=0,r=this.length;r>t;t++)n.nodes[t]=this[t]}return mask.stringify(n)}},n(["append","prepend"],function(e){a.prototype[e]=function(n){for(var t,r,o=a(n),i=0,l=this.length;l>i;i++){r=this[i],t=o.toArray();for(var s=0,u=t.length;u>s;s++)t[s].parent=r;r.nodes=null!=r.nodes?"append"===e?r.nodes.concat(t):t.concat(r.nodes):t}return this}}),n(["appendTo"],function(e){a.prototype[e]=function(e,n,t){return null!=e.nodeType&&"function"==typeof e.appendChild?(e.appendChild(this.render(n,t)),p(this,"domInsert"),this):(a(e).append(this),this)}}),function(){function t(e){for(var n,t,r=e.split(";"),o={},i=0,l=r.length;l>i;i++)t=r[i],n=t.indexOf(":"),o[t.substring(0,n).trim()]=t.substring(n+1).trim();return o}function r(e){var n=[],t=0;for(var r in e)n[t++]=r+":"+e[r];return n.join(";")}n(["add","remove","toggle","has"],function(e){a.prototype[e+"Class"]=function(n){var t,r,o,i,l,s=this.length,u=0;if("string"!=typeof n){if("remove"===e)for(;s>u;u++)this[0].attr["class"]=null;return this}for(;s>u;u++)if(i=this[u],null!=i.attr){if(l=i.attr["class"],null==l)l=n;else{for(l=" "+l+" ",null==t&&(t=n.split(" "),o=t.length),r=0;o>r;r++)if(t[r]){var a=l.indexOf(" "+t[r]+" ")>-1;if("has"!==e)a!==!1||"add"!==e&&"toggle"!==e?a!==!0||"remove"!==e&&"toggle"!==e||(l=l.replace(" "+t[r]+" "," ")):l+=t[r]+" ";else if(a)return!0}l=l.trim()}"has"!==e&&(i.attr["class"]=l)}return"has"===e?!1:this}}),n(["attr","removeAttr","prop","removeProp"],function(e){a.prototype[e]=function(n,t){if(!n)return this;for(var r,o=this.length,i=0,l=arguments.length;o>i;i++)switch(r=this[i],e){case"attr":case"prop":if(1===l){if("string"==typeof n)return r.attr[n];for(var s in n)r.attr[s]=n[s]}else 2===l&&(r.attr[n]=t);break;case"removeAttr":case"removeProp":r.attr[n]=null}return this}}),e(a.prototype,{tag:function(e){if("string"==typeof e){for(var n=0,t=this.length;t>n;n++)this[n].tagName=e;return this}return this[0]&&this[0].tagName},css:function(e,n){var o,i,l,s=arguments.length,u=this.length,a=0;if(1===s&&"string"==typeof e)return 0===u?null:"string"==typeof this[0].attr.style?t(this[0].attr.style)[e]:null;for(;u>a;a++)if(l=this[a].attr.style,"function"!=typeof l){if(1===s&&"object"==typeof e){if(null==l){this[a].attr.style=r(e);continue}o=t(l);for(i in e)o[i]=e[i];this[a].attr.style=r(o)}if(2===s){if(null==l){this[a].attr.style=e+":"+n;continue}o=t(l),o[e]=n,this[a].attr.style=r(o)}}return this}})}(),e(a.prototype,{clone:function(){for(var e=[],n=0,t=this.length;t>n;n++)e[n]=s(this[0]);return a(e)},wrap:function(e){var n,t=a(e),r=[];if(0===t.length)return console.log("Not valid wrapper",e),this;for(var o=0,i=this.length;i>o;o++)n=i>0?t.clone():t,u(n[0]).nodes=[this[o]],r[o]=n[0],null!=this[o].parent&&(this[o].parent.nodes=r[o]);return a(r)},wrapAll:function(e){var n=a(e);return 0===n.length?(console.error("Not valid wrapper",e),this):(this.parent().mask(n),u(n[0]).nodes=this.toArray(),this.pushStack(n))}}),n(["empty","remove"],function(e){a.prototype[e]=function(){for(var n,r=0,o=this.length;o>r;r++)n=this[r],"empty"!==e?"remove"!==e||null!=n.parent&&t(n.parent.nodes,n):n.nodes=null;return this}}),e(a.prototype,{each:function(e){for(var n=0,t=this.length;t>n;n++)e(this[n],n);return this},eq:function(e){return-1===e?this.slice(e):this.slice(e,e+1)},get:function(e){return 0>e?this[this.length-e]:this[e]},slice:function(){return this.pushStack(Array.prototype.slice.apply(this,arguments))}}),n(["filter","children","closest","parent","find","first","last"],function(e){a.prototype[e]=function(n){var t,s,u,f=[],d=null==n?null:r(n,this.type,"closest"===e?"up":"down");switch(e){case"filter":return a(i(this,d));case"children":for(t=0,u=this.length;u>t;t++)s=this[t],null!=s.nodes&&(f=f.concat(null==d?s.nodes:i(s.nodes,d)));break;case"parent":for(t=0,u=this.length;u>t;t++)s=this[t].parent,!s||s.type===c.FRAGMENT||d&&o(s,d)||f.push(s);break;case"closest":case"find":if(null==d)break;for(t=0,u=this.length;u>t;t++)l(this[t][d.nextKey],d,f);break;case"first":case"last":var p;for(t=0,u=this.length;u>t;t++)if(p="first"===e?t:u-t-1,s=this[p],null==d||o(s,d)){f[0]=s;break}}return this.pushStack(f)}}),a}(),Compo=function(){function e(e,n){if(null==e&&(e={}),null==n)return e;for(var t in n)e[t]=n[t];return e}function n(e,n,t){if(null==e&&console.warn("selector is null for type",n),"object"==typeof e)return e;var r,o,l;if(null==r)switch(e[0]){case"#":r="id",e=e.substring(1),o="attr";break;case".":r="class",e=RegExp("\\b"+e.substring(1)+"\\b"),o="attr";break;default:r=n===i.SET?"tagName":"compoName"}return l="up"===t?"parent":n===i.SET?"nodes":"components",{key:r,prop:o,selector:e,nextKey:l}}function t(e,t,r){"string"==typeof t&&(null==r&&(r=i[e.compoName?"CONTROLLER":"SET"]),t=n(t,r));var o=t.prop?e[t.prop]:e;if(null==o)return!1;if(null!=t.selector.test){if(t.selector.test(o[t.key]))return!0}else if(o[t.key]===t.selector)return!0;return!1}function r(e,n){if(e instanceof Array){for(var o,i=0,l=e.length;l>i;i++){o=e[i];var s=r(o,n);if(null!=s)return s}return null}return t(e,n)===!0?e:(e=e[n.nextKey])&&r(e,n)}var o=global.jQuery||global.Zepto||global.$,i=mask.Dom;o||console.warn("jQuery / Zepto etc. was not loaded before compo.js, please use Compo.config.setDOMLibrary to define dom engine");var l={select:function(e,n){for(var t in n){var r=n[t],o=null,i=null;if(r instanceof Array&&(i=r[0],o=r.splice(1)),"string"==typeof r&&(i=r),null==r||null==i)return console.error("Unknown component child",t,n[t]),console.warn("Is this object shared within multiple compo classes? Define it in constructor!"),void 0;var l=i.indexOf(":"),u=i.substring(0,l);u=f.config.selectors[u],null==u?e.compos[t]=e.$[0].querySelector(i):(i=i.substring(++l).trim(),e.compos[t]=u(e,i));var a=e.compos[t];null!=o&&(a instanceof f&&(a=a.$),s.on(e,o,a))}}},s={on:function(e,n,t){null==t&&(t=e.$);for(var r,o=n instanceof Array,i=o?n.length:1,l=0;o?i>l:1>l;l++)if(r=o?n[l]:n,r instanceof Array)null!=u&&(r[0]=u(r[0])),t.on.apply(t,r);else for(var s in r){var a="string"==typeof r[s]?e[r[s]]:r[s],c=s.split(":"),f=c[0]||"click";null!=u&&(f=u(f)),t.on(f,c.splice(1).join(":").trim()||null,a.bind(e))}}},u=null,a=function(){var e=function(){if("undefined"==typeof document)return!1;if("createTouch"in document)return!0;try{return!!document.createEvent("TouchEvent").initTouchEvent}catch(e){return!1}}();return{touch:function(n){return e===!1?n:"click"===n?"touchend":"mousedown"===n?"touchstart":"mouseup"===n?"touchend":"mousemove"===n?"touchmove":n}}}(),c=function(){var e={};return{create:function(n){return null==n.ID?(console.warn("Component should have an ID"),void 0):(e[n.ID]=n,void 0)},resolveCompo:function(n){if(null==n)return null;do{var t=n.getAttribute("x-compo-id");if(null!=t){var r=e[t];return null==r&&(r=this.resolveCompo(n.parentNode),null!=r&&(r=f.find(r,{key:"ID",selector:t,nextKey:"components"}))),null==r&&console.warn("No controller for ID",t),r}n=n.parentNode}while(n&&1===n.nodeType);return null},removeCompo:function(n){null!=n.ID&&delete e[n.ID]}}}(),f=function(){function t(e){if(this instanceof t)return null;var n;null==e&&(e={}),e.hasOwnProperty("constructor")&&(n=e.constructor),null==n&&(n=function(){});for(var r in h)null==e[r]&&(e[r]=h[r]),e["base_"+r]=h[r];return n.prototype=e,n}function f(e){null!=e.dispose&&e.dispose(),c.removeCompo(e);var n=0,t=e.components,r=t&&t.length;if(r)for(;r>n;n++)f(t[n])}function d(e){if(null==e.nodes){var n=e.attr.template;if("string"==typeof n){if("#"===n[0]){var t=document.getElementById(n.substring(1));if(null==t)return console.error("Template holder not found by id:",n),void 0;n=t.innerHTML}n=mask.compile(n)}n!==void 0&&(e.nodes=n,delete e.attr.template)}}function p(){var e=[];return e.appendChild=function(e){this.push(e)},e}e(t,{create:function(e){var n;null==e&&(e={}),e.hasOwnProperty("constructor")&&(n=e.constructor),null==n&&(n=function(){});for(var t in h)null==e[t]&&(e[t]=h[t]),e["base_"+t]=h[t];return n.prototype=e,n},render:function(e,n,t,r){d(e);var i=[];return mask.render(null==e.tagName?e.nodes:e,n,t,r,e,i),e.$=o(i),null!=e.events&&s.on(e,e.events),null!=e.compos&&l.select(e,e.compos),e},initialize:function(e,n,r,o,l){null==o&&(r&&null!=r.nodeType?(o=r,r=null):n&&null!=n.nodeType&&(o=n,n=null)),"string"==typeof e&&(e=mask.getHandler(e),e||console.error("Compo not found:",e));var s={controller:e,type:i.COMPONENT};null==l&&null!=o&&(l=c.resolveCompo(o)),null==l&&(l={});var u=mask.render(s,n,r,null,l),a=l.components[l.components.length-1];return null!=o&&(o.appendChild(u),t.signal.emitIn(a,"domInsert")),a},dispose:function(e){"function"==typeof e.dispose&&e.dispose();var n=0,r=e.components,o=r&&r.length;if(o)for(;o>n;n++)t.dispose(r[n])},find:function(e,t){return r(e,n(t,i.CONTROLLER,"down"))},closest:function(e,t){return r(e,n(t,i.CONTROLLER,"up"))},ensureTemplate:d,config:{selectors:{$:function(e,n){var t=e.$.find(n);return t.length>0?t:(t=e.$.filter(n),0===t.length&&console.error("Compo Selector - element not found -",n,e),t)},compo:function(e,n){var r=t.find(e,n);return null==r&&console.error("Compo Selector - component not found -",n,e),r}},setDOMLibrary:function(e){o=e},eventDecorator:function(e){return"function"==typeof e?(u=e,void 0):"string"==typeof e?(u=a[e],void 0):"boolean"==typeof e&&e===!1?(u=null,void 0):void 0}}});var h={type:i.CONTROLLER,tagName:null,compoName:null,nodes:null,attr:null,onRenderStart:null,onRenderEnd:null,render:null,renderStart:function(e,n,t){1===arguments.length&&null!=e&&e instanceof Array==!1&&null!=e[0]&&(e=arguments[0][0],n=arguments[0][1],t=arguments[0][2]),"function"==typeof this.onRenderStart&&this.onRenderStart(e,n,t),null==this.model&&(this.model=e),null==this.nodes&&d(this)},renderEnd:function(e,n,t,r){1===arguments.length&&e instanceof Array==!1&&(e=arguments[0][0],n=arguments[0][1],t=arguments[0][2],r=arguments[0][3]),c.create(this,e),this.$=o(e),null!=this.events&&s.on(this,this.events),null!=this.compos&&l.select(this,this.compos),"function"==typeof this.onRenderEnd&&this.onRenderEnd(e,n,t,r)},appendTo:function(e){var n;if(n="string"==typeof e?document.querySelector(e):e,null==n)return console.warn("Compo.appendTo: parent is undefined. Args:",arguments),this;for(var t=0;this.$.length>t;t++)n.appendChild(this.$[t]);return this.emitIn("domInsert"),this},append:function(e,t,o){var l;if(null==this.$){var s="string"==typeof e?mask.compile(e):e;return l=o?r(this,n(o,i.CONTROLLER,"down")):this,null==l.nodes?(this.nodes=s,this):(l.nodes=[this.nodes,s],this)}var u=mask.render(e,t,null,p(),this);l=o?this.$.find(o):this.$;for(var a=0;u.length>a;a++)l.append(u[a]);return this.emitIn("domInsert"),this},find:function(e){return r(this,n(e,i.CONTROLLER,"down"))},closest:function(e){return r(this,n(e,i.CONTROLLER,"up"))},on:function(){var e=Array.prototype.slice.call(arguments);return 3>arguments.length?(console.error("Invalid Arguments Exception @use .on(type,selector,fn)"),this):(null!=this.$&&s.on(this,[e]),null==this.events?this.events=[e]:this.events instanceof Array?this.events.push(e):this.events=[e,this.events],this)},remove:function(){null!=this.$&&(this.$.remove(),this.$=null),f(this);var e=this.parent&&this.parent.components;if(null!=e){var n=e.indexOf(this);if(-1===n)return console.warn("Compo::remove - parent doesnt contains me",this),this;e.splice(n,1)}return this},slotState:function(e,n){t.slot.toggle(this,e,n)},signalState:function(e,n){t.signal.toggle(this,e,n)},emitOut:function(e,n,r){t.signal.emitOut(this,e,n,r)},emitIn:function(e,n,r){t.signal.emitIn(this,e,n,r)}};return t.prototype=h,t}();return function(){function n(e,t,r,o,i){if(null!=e){if(null!=o&&("function"==typeof o.unshift?o=[r,o]:o.unshift(r)),null!=e.slots&&"function"==typeof e.slots[t]){var l=e.slots[t],s=null!=e.slots.__disabled&&e.slots.__disabled[t];if(s!==!0){var u=null==o?l.call(e,r):l.apply(e,o);if(u===!1)return}}if(-1===i&&null!=e.parent&&n(e.parent,r,t,o,i),1===i&&null!=e.components)for(var a=0,c=e.components.length;c>a;a++)n(e.components[a],r,t,o,i)}}function t(e,n,r,o){if(null==e)return!1;var i=e.slots;if(null!=i&&"function"==typeof i[n]){if(o!==!0)return!0;if(null==i.__disabled||i.__disabled[n]!==!0)return!0}if(-1===r&&null!=e.parent)return t(e.parent,n,r);if(1===r&&null!=e.components)for(var l=0,s=e.components.length;s>l;l++)if(t(e.components[l],n,r))return!0;return!1}function r(e,r){return t(e,r,-1)===!1?null:function(t){n(e,r,t,null,-1)}}function i(e,n,t){return"function"==typeof o?(o(e).on(n,t),void 0):null!=e.addEventListener?(e.addEventListener(n,t,!1),void 0):(e.attachEvent&&e.attachEvent("on"+n,t),void 0)}function l(e,n,t){var r=e.slots;null!=r&&r.hasOwnProperty(n)!==!1&&(null==r.__disabled&&(r.__disabled={}),r.__disabled[n]=t===!1)}function s(e,n,t){if(l(e,n,t),null!=e.components)for(var r=0,o=e.components.length;o>r;r++)s(e.components[r],n,t)}function a(e,n,t){return null==e.$?(console.warn("Controller has no elements to toggle state"),void 0):(o().add(e.$.filter("[data-signals]")).add(e.$.find("[data-signals]")).each(function(e,r){var o=r.getAttribute("data-signals");null!=o&&-1!==o.indexOf(n)&&r[t===!0?"removeAttribute":"setAttribute"]("disabled","disabled")}),void 0)}function c(e,n,t){for(var r=e,o=e;null!=(r=r.parent);)l(r,n,t),null!=r.$&&0!==r.$.length&&(o=r);s(e,n,t),a(o,n,t)}function d(e,n,r){l(e,n,r),(r||!t(e,n,-1,!0)&&!t(e,n,1,!0))&&a(e,n,r)}mask.registerAttrHandler("x-signal",function(e,n,t,o,l,s){for(var a,c=n.split(";"),f="",d=0,p=c.length;p>d;d++){a=c[d];var h=a.substring(0,a.indexOf(":")),m=a.substring(a.indexOf(":")+1).trim(),g=r(s,m);!h&&console.error("Signal: event type is not set",n),g&&(null!=u&&(h=u(h)),f+=","+m+",",i(l,h,g)),!g&&console.warn("No slot found for signal",m,s)}""!==f&&l.setAttribute("data-signals",f)}),e(f,{signal:{toggle:c,emitOut:function(e,t,r,o){n(e,t,r,o,-1)},emitIn:function(e,t,r,o){n(e,t,r,o,1)},enable:function(e,n){c(e,n,!0)},disable:function(e,n){c(e,n,!1)}},slot:{toggle:d,enable:function(e,n){d(e,n,!0)},disable:function(e,n){d(e,n,!1)},invoke:function(e,n,t,r){var o=e.slots;return null==o||"function"!=typeof o[n]?(console.error("Slot not found",n,e),null):null==r?o[n].call(e,t):o[n].apply(e,[t].concat(r))}}})}(),function(){null!=o&&null!=o.fn&&(o.fn.compo=function(e){if(0===this.length)return null;var t=c.resolveCompo(this[0]);return null==e?t:r(t,n(e,i.CONTROLLER,"up"))},o.fn.model=function(e){var n=this.compo(e);if(null==n)return null;for(var t=n.model;null==t&&n.parent;)n=n.parent,t=n.model;return t})}(),f}();return Mask});