(function(e,t){"use strict";var n="undefined"==typeof document?null:document,r=function(){return t(n)};"object"==typeof exports?module.exports=r():"function"==typeof define&&define.amd?define(r):e.mask=r()})(this,function(document){"use strict";function util_extend(e,t){null==e&&(e={});for(var n in t)hasOwnProp.call(t,n)&&(e[n]=t[n]);return e}function util_getProperty(e,t){if("."===t)return e;for(var n=e,r=t.split("."),i=-1,l=r.length;null!=n&&l>++i;)n=n[r[i]];return n}function util_interpolate(e,t,n,r,i,l){var o,a,s,u,c,d=e.length,f=Array(d),h=!0;for(c=0,d=e.length;d>c;c++)h?f[c]=e[c]:(u=e[c],a=null,s=u.indexOf(":"),~s?(o=s>0?u.substring(0,s).replace(regexpWhitespace,""):"",""===o&&(o="condition"),u=u.substring(s+1),"function"==typeof ModelUtils[o]&&(a=ModelUtils[o](u,t,n,r,i,l))):a=util_getProperty(t,u),f[c]=null==a?"":a),h=!h;return f}function util_createInterpoleFunction(e){for(var t="#{",n="}",r=2,i=[],l=0,o=0,a=0,s=0;(l=e.indexOf(t,l))>-1;)s=e.indexOf(n,l+r),-1!==s?(l>o&&(i[a]=e.substring(o,l),a++),l===o&&(i[a]="",a++),i[a]=e.substring(l+r,s),a++,o=l=s+1):l+=r;return e.length>o&&(i[a]=e.substring(o)),e=null,function(e,t,n,r,l){return util_interpolate(i,e,t,n,r,l)}}function Template(e){this.template=e,this.index=0,this.length=e.length}function builder_build(e,t,n,r){if(null==e)return n;null==n&&(n=create_container()),null==r&&(r={components:null});do{var i=create_node(e,t,n,r);null!=i&&null!=e.firstChild&&builder_build(e.firstChild,t,i,r)}while(null!=(e=e.nextNode));return n}function create_container(){return document.createDocumentFragment()}function create_node(e,t,n,r){var i,l,o;if(null!=CustomTags[e.tagName]){var a=CustomTags[e.tagName],s="function"==typeof a?new a(t):a;if(s.compoName=e.tagName,s.firstChild=e.firstChild,s.attr=util_extend(s.attr,e.attr),(r.components||(r.components=[])).push(s),s.parent=r,null!=listeners){var u=listeners.customCreated;if(null!=u)for(i=0,l=u.length;l>i;i++)u[i](s,t,n)}return s.render(t,n,s),null}if(null!=e.content){if("function"!=typeof e.content)return n.appendChild(document.createTextNode(e.content)),null;var c=e.content(t,"node",r,n),d="";for(i=0,l=c.length;l>i;i++)o=c[i],"object"==typeof o&&(""!==d&&(n.appendChild(document.createTextNode(d)),d=""),n.appendChild(o)),d+=o;return""!==d&&n.appendChild(document.createTextNode(d)),null}var f,h,p=document.createElement(e.tagName),g=e.attr;for(f in g)hasOwnProp.call(g,f)!==!1&&(h="function"==typeof g[f]?g[f](t,"attr",r,p,f).join(""):g[f],h&&(hasOwnProp.call(CustomAttributes,f)===!0?CustomAttributes[f](e,t,h,p,r):p.setAttribute(f,h)));return n.appendChild(p),p}var regexpWhitespace=/\s/g,regexpEscapedChar={"'":/\\'/g,'"':/\\"/g,"{":/\\\{/g,">":/\\>/g,";":/\\>/g},regexpTabsAndNL=/[\t\n\r]{1,}/g,regexpMultipleSpaces=/ {2,}/g,hasOwnProp={}.hasOwnProperty,listeners=null;Template.prototype={skipWhitespace:function(){for(var e=this.template,t=this.index,n=this.length;n>t&&32===e.charCodeAt(t);t++);return this.index=t,this},sliceToChar:function(e){for(var t,n,r=this.template,i=this.index,l=i,o=!1;(n=r.indexOf(e,i))>-1&&(i=n,92===r.charCodeAt(i-1));)o=!0,i++;return t=r.substring(l,i),this.index=i,o?t.replace(regexpEscapedChar[e],e):t}};var ConditionUtil=function(){function e(e,t){var n,r=t,i=e.index;if(null==r&&(e.skipWhitespace(),i=e.index,t=r=e.template.charCodeAt(e.index)),34===r||39===r)return e.index++,n=e.sliceToChar(39===r?"'":'"'),e.index++,n;do r=e.template.charCodeAt(++e.index);while(e.index<e.length&&32!==r&&33!==r&&60!==r&&61!==r&&62!==r&&40!==r&&41!==r&&38!==r&&124!==r);return n=e.template.substring(i,e.index),r=t,45===r||r>47&&58>r?n-0:116===r&&"true"===n?!0:102===r&&"false"===n?!1:{value:n}}function t(n,r){var i,l={assertions:null,join:null,left:null,right:null};for(null==r&&(r=[]),"string"==typeof n&&(n=new Template(n));;){if(n.skipWhitespace(),n.index>=n.length)break;switch(i=n.template.charCodeAt(n.index)){case 61:case 60:case 62:case 33:var o=n.index;do i=n.template.charCodeAt(++n.index);while(n.index<n.length&&(60===i||61===i||62===i));l.sign=n.template.substring(o,n.index);continue;case 38:case 124:n.template.charCodeAt(++n.index)!==i&&console.error("Unary operation not valid"),l.join=38===i?"&&":"||",r.push(l),l={assertions:null,join:null,left:null,right:null},++n.index;continue;case 40:n.index++,t(n,l.assertions=[]);break;case 41:n.index++;break;default:l[null==l.left?"left":"right"]=e(n,i);continue}}return(l.left||l.assertions)&&r.push(l),r}function n(n){if(null!=i[n])return i[n];var r=n.length,l={},o=n.indexOf("?"),a=new Template(n);return o>-1&&(a.length=o),l.assertions=t(a),a.length=r,a.index=o+1,l.case1=e(a),a.skipWhitespace(),58===a.template.charCodeAt(a.index)&&(a.index++,l.case2=e(a)),i[n]=l}function r(e,t){"string"==typeof e&&(e=n(e).assertions),null!=e.assertions&&(e=e.assertions);var i,l,o,a,s,u=!1;for(a=0,s=e.length;s>a;a++){if(i=e[a],i.assertions)u=r(i.assertions,t);else if(l="object"==typeof i.left?util_getProperty(t,i.left.value):i.left,null==i.right)u=!!l,"!"===i.sign&&(u=!u);else switch(o="object"==typeof i.right?util_getProperty(t,i.right.value):i.right,i.sign){case"<":u=o>l;break;case"<=":u=o>=l;break;case">":u=l>o;break;case">=":u=l>=o;break;case"!=":u=l!==o;break;case"==":u=l===o}if(u===!0){if("&&"===i.join)continue;break}if("||"!==i.join)break}return u}var i=[];return{condition:function(e,t){var i=n(e),l=r(i.assertions,t)?i.case1:i.case2;return null==l?"":"object"==typeof l&&l.value?util_getProperty(t,l.value):l},isCondition:r,parse:n,out:{isCondition:r,parse:n}}}(),ModelUtils={condition:ConditionUtil.condition},CustomAttributes={},CustomTags={},Parser=function(){function e(e,t){this.tagName=e,this.parent=t,this.attr={},this.firstChild=null,this.lastChild=null,this.nextNode=null,this.currentNode=null,this.__single=null}function t(e,t){this.content=e,this.parent=t,this.nextNode=null}function n(e,t){null==e.firstChild&&(e.firstChild=t),null!=e.lastChild&&(e.lastChild.nextNode=t),e.lastChild=t}function r(e){for(var t,n,r;c>d;)if(t=null,n=null,h=u.charCodeAt(d),32!==h){if(123===h||59===h||62===h)break;46!==h?(35===h?(d++,t="id",n=o()):(t=l(),61!==u.charCodeAt(d)?n=t:(h=u.charCodeAt(++d),a(),n=l())),null!=t&&(e[t]=i(n))):(d++,n=o(),r=null==r?n:r+" "+n)}else d++;null!=r&&(e["class"]=i(r))}function i(e){return-1===e.indexOf("#{")?e:f!==!0?util_createInterpoleFunction(e):{template:e}}function l(){var e;return 34===h||39===h?(d++,e=s(34===h?'"':"'"),d++,e):(e=o(),a(),e)}function o(){var e=d;do if(h=u.charCodeAt(d++),35===h&&123===u.charCodeAt(d)){s("}"),d+=2;break}while(46!==h&&35!==h&&62!==h&&123!==h&&32!==h&&59!==h&&61!==h&&c>=d);return d--,u.substring(e,d)}function a(){for(;32===h&&c>d;)h=u.charCodeAt(++d)}function s(e){for(var t,n,r=d,i=!1;(n=u.indexOf(e,d))>-1&&(d=n,92===u.charCodeAt(n-1));)i=!0,d++;return t=u.substring(r,d),i?t.replace(regexpEscapedChar[e],e):t}var u,c,d,f,h;return{parse:function(l){u=l.template,d=l.index,c=l.length,f=l.serialize;for(var a=new e,p=a;c>d;)if(h=u.charCodeAt(d),32!==h&&123!==h)if(62!==h)if(59!==h||null==a.firstChild)if(59!==h&&125!==h)if(39!==h&&34!==h){var g=null;g=46===h||35===h?"div":o(),""===g&&console.error("Parse Error: Undefined tag Name %d/%d %s",d,length,u.substring(d,d+10));var m=new e(g,a);r(m.attr),n(a,a=m)}else{d++;var C=i(s(39===h?"'":'"'));if(n(a,new t(C,a)),a.__single===!0)for(;null!=(a=a.parent)&&null!=a.__single;);d++}else{if(d++,null==a)continue;for(a=a.parent;null!=a&&null!=a.__single;)a=a.parent}else d++;else d++,a.__single=!0;else d++;return p.firstChild},cleanObject:function(e){if(e instanceof Array){for(var t=0;e.length>t;t++)this.cleanObject(e[t]);return e}return delete e.parent,delete e.__single,null!=e.nodes&&this.cleanObject(e.nodes),e}}}(),cache={},Mask={render:function(e,t,n,r){return"string"==typeof e&&(e=this.compile(e)),builder_build(e,t,n,r)},compile:function(e,t){if(hasOwnProp.call(cache,e))return cache[e];var n=new Template(e.replace(regexpTabsAndNL,"").replace(regexpMultipleSpaces," "));return t===!0&&(n.serialize=!0),cache[e]=Parser.parse(n)},registerHandler:function(e,t){CustomTags[e]=t},getHandler:function(e){return null!=e?CustomTags[e]:CustomTags},registerAttrHandler:function(e,t){CustomAttributes[e]=t},registerUtility:function(e,t){ModelUtils[e]=t},serialize:function(e){return Parser.cleanObject(this.compile(e,!0))},deserialize:function(e){var t,n,r;if(e instanceof Array){for(t=0;e.length>t;t++)this.deserialize(e[t]);return e}if(null!=e.content)return null!=e.content.template&&(e.content=Parser.toFunction(e.content.template)),e;if(null!=e.attr){r=e.attr;for(n in r)if(hasOwnProp.call(r,n)===!0){if(null==r[n].template)continue;r[n]=Parser.toFunction(r[n].template)}}return null!=e.nodes&&this.deserialize(e.nodes),e},clearCache:function(e){"string"==typeof e?delete cache[e]:cache={}},ValueUtils:{condition:ConditionUtil.condition,out:ConditionUtil},Utils:{Condition:ConditionUtil,getProperty:util_getProperty},plugin:function(source){eval(source)},on:function(e,t){null==listeners&&(listeners={}),(listeners[e]||(listeners[e]=[])).push(t)},delegateReload:function(){}};return Mask.renderDom=Mask.render,Mask});