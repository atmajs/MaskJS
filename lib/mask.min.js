(function(global,document){"use strict";function ICustomTag(){this.attr={}}function cleanObject(e){if(e instanceof Array){for(var t=0;t<e.length;t++)cleanObject(e[t]);return e}return delete e.parent,delete e.__single,e.nodes!=null&&cleanObject(e.nodes),e}function Builder(e,t,n,r){if(e==null)return n;n==null&&(n=document.createDocumentFragment()),r==null&&(r={});var i=e instanceof Array,s=i===!0?e.length:1,o,u,a;for(o=0;o<s;o++){u=i===!0?e[o]:e;if(CustomTags.all[u.tagName]!=null){var f=CustomTags.all[u.tagName],l=f instanceof Function?new f(t):f;l.compoName=u.tagName,l.nodes=u.nodes,l.attr=extend(l.attr,u.attr),(r.components||(r.components=[])).push(l),l.parent=r;if(listeners!=null){var c=listeners.customCreated;if(c!=null)for(a=0;a<c.length;a++)c[a](l,t,n)}l.render(t,n,l);continue}if(u.content!=null){n.appendChild(document.createTextNode(typeof u.content=="function"?u.content(t):u.content));continue}var h=document.createElement(u.tagName),p=u.attr;for(var d in p){var v=typeof p[d]=="function"?p[d](t):p[d];v&&h.setAttribute(d,v)}u.nodes!=null&&Builder(u.nodes,t,h,r),n.appendChild(h)}return n}var regexpWhitespace=/\s/g,regexpLinearCondition=/([!]?['"A-Za-z0-9_\-\.]+)([!<>=]{1,2})?([^\|&]+)?([\|&]{2})?/g,regexpEscapedChar={"'":/\\'/g,'"':/\\"/g,"{":/\\\{/g,">":/\\>/g,";":/\\>/g},regexpTabsAndNL=/[\t\n\r]{1,}/g,regexpMultipleSpaces=/ {2,}/g,hasOwnProp={}.hasOwnProperty,listeners=null,extend=function(e,t){var n;if(t==null)return e;e==null&&(e={});for(n in t)e[n]=t[n];return e},getProperty=function(e,t){var n=e,r,i,s,o;if(typeof e!="object"||t==null)return e;typeof t=="string"&&(r=t.split("."));for(s=0,o=r.length;s<o;s++){i=r[s],n=n[i];if(!n)return n}return n},templateFunction=function(e,t){var n="",r=!0,i,s,o,u,a,f;for(a=0,f=e.length;a<f;a++)r?n+=e[a]:(u=e[a],s=null,o=u.indexOf(":"),~o?(i=o>0?u.substring(0,o).replace(regexpWhitespace,""):"",i===""&&(i="condition"),u=u.substring(o+1),s=typeof ValueUtilities[i]=="function"?ValueUtilities[i](u,t):null):s=getProperty(t,u),n+=s==null?"":s),r=!r;return n};ICustomTag.prototype.render=function(e,t){return Builder(this.nodes,e,t)};var CustomTags=function(){function t(){this.attr={}}function n(){this.attr={}}function r(){this.attr={}}var e=ICustomTag.prototype.render;return t.prototype.render=function(e,t,n){var r=this.attr,i=r.template,s=getProperty(e,r.value),o,u,a,f;if(s instanceof Array){i!=null&&(u=document.querySelector(i).innerHTML,this.nodes=o=Mask.compile(u));if(this.nodes==null)return t;for(a=0,f=s.length;a<f;a++)Builder(this.nodes,s[a],t,n);return t}return t},n.prototype.render=function(t,n,r){return ValueUtilities.out.isCondition(this.attr.check,t)?e.call(this,t,n,r):n},r.prototype.render=function(){var e=Object.defineProperty,t=!1,n,i;if(e)try{t=Object.defineProperty({},"x",{get:function(){return!0}}).x}catch(s){t=!1}else Object.prototype.__defineGetter__&&(e=function(e,t,n){hasOwnProp.call(n,"get")&&e.__defineGetter__(t,n.get),hasOwnProp.call(n,"set")&&e.__defineSetter__(t,n.set)},t=!0);return t||(n=[],e=function(e,t,r){var i,s=!1,o,u;for(o=0,u=n.length;o<u;o++){i=n[o];if(i.obj===e){s=!0;break}}s||(i=n[o]={obj:e,props:{}}),i.props[t]={value:e[t],set:r.set}},i=function(){var e,t,r,s,o,u,a;for(t=0,r=n.length;t<r;t++){e=n[t],s=e.props;for(o in s)hasOwnProp.call(s,o)&&(u=s[o],a=e.obj[o],a!==u.value&&u.set.call(null,a))}setTimeout(i,16)},i()),(r.prototype.render=function(t,n){var r=this.attr.value,i=t[r];return e.call(Object,t,r,{get:function(){return i},set:function(e){n.innerHTML=i=e}}),n.innerHTML=i,n}).apply(this,arguments)},{all:{list:t,visible:n,bind:r}}}(),ValueUtilities=function(){function e(e,t){var n=e.charCodeAt(0);return n===34||n===39?e.substring(1,e.length-1):n===45||n>47&&n<58?e<<0:Helper.getProperty(t,e)}var t=function(e){var t={assertions:[]},r={data:e.replace(regexpWhitespace,"")},i,s;r.index=r.data.indexOf("?"),r.index===-1&&console.error('Invalid Linear Condition: "?" is not found'),s=r.data.substring(0,r.index);while((i=regexpLinearCondition.exec(s))!=null)t.assertions.push({join:i[4],left:i[1],sign:i[2],right:i[3]});return r.index++,n(r,t,"case1"),r.index++,n(r,t,"case2"),t},n=function(e,t,n){var r=e.data[e.index],i=null;if(r==null)return;r==='"'||r==="'"?(i=e.data.indexOf(r,++e.index),t[n]=e.data.substring(e.index,i)):(i=e.data.indexOf(":",e.index),i===-1&&(i=e.data.length),t[n]={value:e.data.substring(e.index,i)}),i!=null&&(e.index=++i)},r=function(n,r){typeof n=="string"&&(n=t(n));var i=!1,s,o,u,a,f;for(a=0,f=n.assertions.length;a<f;a++){s=n.assertions[a];if(s.right==null){i=s.left.charCodeAt(0)===33?!Helper.getProperty(r,s.left.substring(1)):!!Helper.getProperty(r,s.left);if(i===!0){if(s.join==="&&")continue;break}if(s.join==="||")continue;break}o=e(s.left,r),u=e(s.right,r);switch(s.sign){case"<":i=o<u;break;case"<=":i=o<=u;break;case">":i=o>u;break;case">=":i=o>=u;break;case"!=":i=o!==u;break;case"==":i=o===u}if(i===!0){if(s.join==="&&")continue;break}if(s.join==="||")continue;break}return i};return{condition:function(e,n){var i=t(e),s=r(i,n)?i.case1:i.case2;return s==null?"":typeof s=="string"?s:Helper.getProperty(n,s.value)},out:{isCondition:r,parse:t}}}(),Parser=function(){function i(){for(;t<n;t++)if(e.charCodeAt(index)!==32)break}function s(n){var r;do r=e.indexOf(n,t);while(~r&&e.charCodeAt(r-1)!==92);t=r}function o(){var r;do{r=e.charCodeAt(++t);if(r===35&&e.charCodeAt(t+1)===123){u("}"),t++;return}}while(r!==46&&r!==35&&r!==62&&r!==123&&r!==32&&r!==59&&t<n)}function u(n){var r=t,i=!1,s,o;while((o=e.indexOf(n,t))>-1){t=o;if(e.charCodeAt(t-1)!==92)break;i=!0,t++}return s=e.substring(r,t),i?s.replace(regexpEscapedChar[n],n):s}function a(e){var t=e.split("#{"),n=t.length,r;for(r=1;r<n;r++){var i=t[r],s=i.indexOf("}");t.splice(r,0,i.substring(0,s)),r++,n++,t[r]=i.substring(s+1)}return e=null,function(e){return templateFunction(t,e)}}function f(i){var s,f,l,c,h,p,d;i.attr==null&&(i.attr={});e:for(;t<n;){s=null,f=null,h=e.charCodeAt(t);switch(h){case 32:t++;continue;case 123:case 59:case 62:break e;case 46:p=t+1,o(),f=e.substring(p,t),l=l!=null?l+" "+f:f;break;case 35:s="id",p=t+1,o(),f=e.substring(p,t);break;default:p=d=t;var v=null;do h=e.charCodeAt(++d),v==null&&h===32&&(v=d);while(h!==61&&d<=n);s=e.substring(p,v||d);do c=e.charAt(++d);while(c===" ");t=++d,f=u(c),t++}s!=null&&(f.indexOf("#{")>-1&&(f=r!==!0?a(f):{template:f}),i.attr[s]=f)}l!=null&&(i.attr["class"]=l.indexOf("#{")>-1?r!==!0?a(l):{template:l}:l)}var e=null,t=null,n=null,r=null;return function(s){e=s,n=s.length,t=0;var o=[],l={nodes:o};for(;t<n;t++){var c=e.charCodeAt(t);switch(c){case 32:continue;case 39:case 34:t++;var h=u(c===39?"'":'"');h.indexOf("#{")>-1&&(h=r!==!0?a(h):{template:h});var p={content:h};l.nodes==null?l.nodes=p:l.nodes.push==null?l.nodes=[l.nodes,p]:l.nodes.push(p);if(l.__single){if(l==null)continue;l=l.parent;while(l!=null&&l.__single!=null)l=l.parent}continue;case 62:l.__single=!0;continue;case 123:continue;case 59:if(l.nodes!=null)continue;case 125:if(l==null)continue;do l=l.parent;while(l!=null&&l.__single!=null);continue}var d=null;if(c===46||c===35)d="div";else{var v=t;do c=e.charCodeAt(++t);while(c!==32&&c!==35&&c!==46&&c!==59&&c!==123&&c!==62&&t<=n);d=e.substring(v,t)}d===""&&console.error("Parse Error: Undefined tag Name %d/%d %s",t,n,e.substring(t,t+10));var m={tagName:d,parent:l};l==null&&console.log("T",l,"rest",e.substring(t)),l.nodes==null?l.nodes=m:l.nodes.push==null?l.nodes=[l.nodes,m]:l.nodes.push(m),l=m,f(l),t--}return o}}(),cache={},Mask={render:function(e,t,n,r){return typeof e=="string"&&(e=this.compile(e)),Builder(e,t,n,r)},compile:function(e,t){return cache[e]!=null?cache[e]:(t===!0&&(_serialize=!0),cache[e]=Parser(e.replace(regexpTabsAndNL,"").replace(regexpMultipleSpaces," ")))},registerHandler:function(e,t){CustomTags.all[e]=t},getHandler:function(e){return e!=null?CustomTags.all[e]:CustomTags.all},registerUtility:function(e,t){ValueUtilities[e]=t},serialize:function(e){return Parser.cleanObject(this.compile(e,!0))},deserialize:function(e){var t,n,r;if(e instanceof Array){for(t=0;t<e.length;t++)this.deserialize(e[t]);return e}if(e.content!=null)return e.content.template!=null&&(e.content=Parser.toFunction(e.content.template)),e;if(e.attr!=null){r=e.attr;for(n in r)if(hasOwnProp.call(r,n)===!0){if(r[n].template==null)continue;r[n]=Parser.toFunction(r[n].template)}}return e.nodes!=null&&this.deserialize(e.nodes),e},clearCache:function(e){typeof e=="string"?delete cache[e]:cache={}},ICustomTag:ICustomTag,ValueUtils:ValueUtilities,plugin:function(source){eval(source)},on:function(e,t){listeners==null&&(listeners={}),(listeners[e]||(listeners[e]=[])).push(t)},delegateReload:function(){}};Mask.renderDom=Mask.render,typeof module!="undefined"&&module.exports?module.exports=Mask:global.mask=Mask})(this,typeof document=="undefined"?null:document);