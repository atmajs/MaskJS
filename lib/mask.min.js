(function(e,n){"use strict";null==e&&"undefined"!=typeof global&&(e=global);var t="undefined"==typeof document?null:document,r=function(r){null==r&&(r={});var o,i=n(e,t,r);for(o in r)i[o]=r[o];return i};if("object"==typeof exports)module.exports=r();else if("function"==typeof define&&define.amd)define(r);else{var o={},i=r(o);e.mask=i;for(var l in o)e[l]=o[l]}})(this,function(global,document,exports){"use strict";function util_extend(e,n){null==e&&(e={});for(var t in n)hasOwnProp.call(n,t)!==!1&&(e[t]=n[t]);return e}function util_getProperty(e,n){if("."===n)return e;for(var t=e,r=n.split("."),o=-1,i=r.length;null!=t&&i>++o;)t=t[r[o]];return t}function util_interpolate(e,n,t,r,o,i,l){for(var s,u,a,c,f=e.length,d=0,h=null,p="",g=!0;f>d;d++)g===!0?null==h?p+=e[d]:h.push(e[d]):(c=e[d],u=null,a=c.indexOf(":"),-1===a?u=util_getProperty(t,c):(s=a>0?c.substring(0,a).replace(regexpWhitespace,""):"",""===s&&(s="expression"),c=c.substring(a+1),"function"==typeof ModelUtils[s]&&(u=ModelUtils[s](c,t,r,o,i,l,n))),null!=u&&("object"==typeof u&&null==h&&(h=[p]),null==h?p+=u:h.push(u))),g=!g;return null==h?p:h}function Template(e){this.template=e,this.index=0,this.length=e.length}function Node(e,n){this.type=Dom.NODE,this.tagName=e,this.parent=n,this.attr={}}function TextNode(e,n){this.content=e,this.parent=n,this.type=Dom.TEXTNODE}function Fragment(){this.nodes=[]}function Component(e,n,t){this.tagName=e,this.parent=n,this.controller=t,this.attr={}}function builder_build(e,n,t,r,o,i){if(null==e)return r;var l,s,u,a,c=e.type,f=null;if(null==r&&1!==c&&(r=document.createDocumentFragment()),null==o&&(o=new Component),10===c||e instanceof Array){for(l=0,s=e.length;s>l;l++)builder_build(e[l],n,t,r,o,i);return r}if(null==c&&(null!=e.tagName?c=1:null!=e.content&&(c=2)),1===c){var d,h=e.tagName,p=e.attr;try{d=document.createElement(h)}catch(g){return console.error(h,"element cannot be created. If this should be a custom handler tag, then controller is not defined"),void 0}null!=i&&(i.push(d),i=null,p["x-compo-id"]=o.ID);for(u in p)"function"==typeof p[u]?(a=p[u]("attr",n,t,d,o,u),a instanceof Array&&(a=a.join(""))):a=p[u],a&&("function"==typeof CustomAttributes[u]?CustomAttributes[u](e,a,n,t,d,o):d.setAttribute(u,a));null!=r&&r.appendChild(d),r=d}if(2===c){var m,v,y,b;if(v=e.content,"function"==typeof v)if(y=v("node",n,t,r,o),"string"==typeof y)r.appendChild(document.createTextNode(y));else{for(b="",l=0,s=y.length;s>l;l++)if(m=y[l],"object"!=typeof m)b+=m;else{if(""!==b&&(r.appendChild(document.createTextNode(b)),b=""),null==m.nodeType){b+=""+m;continue}r.appendChild(m)}""!==b&&r.appendChild(document.createTextNode(b))}else r.appendChild(document.createTextNode(v));return r}if(4===c){var p,C=e.controller,x="function"==typeof C?new C(n):C;if(null!=x){x.compoName=e.tagName,x.attr=p=util_extend(x.attr,e.attr);for(u in p)"function"==typeof p[u]&&(p[u]=p[u]("attr",n,t,r,o,u));if(x.nodes=e.nodes,x.parent=o,null!=listeners&&null!=listeners.compoCreated){var k=listeners.compoCreated;for(l=0,s=k.length;s>l;l++)k[l](x,n,t,r)}"function"==typeof x.renderStart&&x.renderStart(n,t,r),null!=x.tagName&&x.tagName!==e.compoName&&(x.nodes={tagName:x.tagName,attr:x.attr,nodes:x.nodes,type:1}),e=x}if(null==o.components?o.components=[e]:o.components.push(e),o=e,o.ID=++_controllerID,f=[],null!=o.model&&(n=o.model),"function"==typeof o.render)return o.render(n,t,r),r}var w=e.nodes;if(null!=w){null!=i&&null==f&&(f=i);for(var A=w instanceof Array,N=A===!0?w.length:1,O=0,_=null;N>O;O++)_=A===!0?w[O]:w,builder_build(_,n,t,r,o,f)}if(4===c&&"function"==typeof e.renderEnd&&e.renderEnd(f,n,t,r),null!=i&&i!==f){var T=i.length,E=f.length;for(l=-1;E>++l;)i[T+l]=f[l]}return r}var regexpWhitespace=/\s/g,regexpEscapedChar={"'":/\\'/g,'"':/\\"/g,"{":/\\\{/g,">":/\\>/g,";":/\\>/g},hasOwnProp={}.hasOwnProperty,listeners=null;Template.prototype={skipWhitespace:function(){for(var e=this.template,n=this.index,t=this.length;t>n&&!(e.charCodeAt(n)>32);n++);return this.index=n,this},skipToAttributeBreak:function(){var e,n=this.template,t=this.index,r=this.length;do if(e=n.charCodeAt(++t),35===e&&123===n.charCodeAt(t+1))return this.index=t,this.sliceToChar("}"),this.index++,void 0;while(46!==e&&35!==e&&62!==e&&123!==e&&32!==e&&59!==e&&r>t);this.index=t},sliceToChar:function(e){for(var n,t,r=this.template,o=this.index,i=o,l=!1;(t=r.indexOf(e,o))>-1&&(o=t,92===r.charCodeAt(o-1));)l=!0,o++;return n=r.substring(i,o),this.index=o,l?n.replace(regexpEscapedChar[e],e):n}};var ConditionUtil=function(){function e(e,n){var t,r=n,o=e.index;if(null==r&&(e.skipWhitespace(),o=e.index,n=r=e.template.charCodeAt(e.index)),34===r||39===r)return e.index++,t=e.sliceToChar(39===r?"'":'"'),e.index++,t;do r=e.template.charCodeAt(++e.index);while(e.index<e.length&&32!==r&&33!==r&&60!==r&&61!==r&&62!==r&&40!==r&&41!==r&&38!==r&&124!==r);return t=e.template.substring(o,e.index),r=n,45===r||r>47&&58>r?t-0:116===r&&"true"===t?!0:102===r&&"false"===t?!1:{value:t}}function n(t,r){var o,i={assertions:null,join:null,left:null,right:null};null==r&&(r=[]),"string"==typeof t&&(t=new Template(t));e:for(;;){if(t.skipWhitespace(),t.index>=t.length)break;switch(o=t.template.charCodeAt(t.index)){case 61:case 60:case 62:case 33:var l=t.index;do o=t.template.charCodeAt(++t.index);while(t.index<t.length&&(60===o||61===o||62===o));i.sign=t.template.substring(l,t.index);continue;case 38:case 124:t.template.charCodeAt(++t.index)!==o&&console.error("Unary operation not valid"),i.join=38===o?"&&":"||",r.push(i),i={assertions:null,join:null,left:null,right:null},++t.index;continue;case 40:t.index++,n(t,i.assertions=[]);break;case 41:t.index++;break e;default:i[null==i.left?"left":"right"]=e(t,o);continue}}return(i.left||i.assertions)&&r.push(i),r}function t(t){if(null!=o[t])return o[t];var r=t.length,i={assertions:null,case1:null,case2:null},l=t.indexOf("?"),s=new Template(t);return-1!==l&&(s.length=l),i.assertions=n(s),-1!==l&&(s.length=r,s.index=l+1,i.case1=e(s),s.skipWhitespace(),58===s.template.charCodeAt(s.index)&&(s.index++,i.case2=e(s))),o[t]=i}function r(e,n){"string"==typeof e&&(e=t(e).assertions),null!=e.assertions&&(e=e.assertions);var o,i,l,s,u,a=!1;for(s=0,u=e.length;u>s;s++){if(o=e[s],o.assertions)a=r(o.assertions,n);else if(i="object"==typeof o.left?util_getProperty(n,o.left.value):o.left,null==o.right)a=i,"!"===o.sign&&(a=!a);else switch(l="object"==typeof o.right?util_getProperty(n,o.right.value):o.right,o.sign){case"<":a=l>i;break;case"<=":a=l>=i;break;case">":a=i>l;break;case">=":a=i>=l;break;case"!=":a=i!==l;break;case"==":a=i===l}if(a){if("&&"===o.join)continue;break}if("||"!==o.join&&"&&"===o.join)for(++s;u>s&&"||"!==e[s].join;s++);}return a}var o=[];return{condition:function(e,n){var o=t(e),i=r(o.assertions,n);return null!=o.case1&&(i=i?o.case1:o.case2),null==i?"":"object"==typeof i&&i.value?util_getProperty(n,i.value):i},isCondition:r,parse:t,out:{isCondition:r,parse:t}}}(),ExpressionUtil=function(){function e(e){this.parent=e,this.type=G,this.body=[],this.join=null}function n(e){this.parent=e}function t(e){this.type=Z,this.body=e,this.join=null}function r(e,n){this.parent=e,this.type=q,this.body=n,this.arguments=[],this.next=null}function o(e,n){this.parent=e,this.type=X,this.body=n,this.next=null}function i(e,n){this.parent=e,this.prefix=n}function l(n){this.body=n,this.case1=new e(this),this.case2=new e(this)}function s(e,n){null==e&&console.error("Undefined",e,n);var t=e.type;return G===t?(e.body.push(n),n):Q===t||z===t?e.body=n:X===t||q===t?e.next=n:(console.error("Unsupported - append:",e,n),n)}function u(){if(0===arguments.length)return null;var n=new e(arguments[0].parent);return n.join=arguments[arguments.length-1].join,n.body=Array.prototype.slice.call(arguments),n}function a(e){if(e.type!==G)return null!=e.body&&"object"==typeof e.body&&a(e.body),void 0;for(var n,t,r,o=e.body,i=0,l=o.length;l>i;i++)a(o[i]);for(i=1;l>i&&(n=o[i],t=o[i-1],!(nn[t.join]>nn[n.join]));i++);if(i!==l){for(r=[o[0]],i=1;l>i;i++)n=o[i],t=o[i-1],nn[t.join]>nn[n.join]&&l-1>i&&(n=u(o[i],o[++i])),r.push(n);e.body=r}}function c(e,n){console.error("Expression parser:",e,n,y.substring(C))}function f(e,n,t,r){var o,i,l=e,s=e.body;if(null==i&&null!=n&&(o=n,i=n[s]),null==i&&null!=t&&(o=t,i=t[s]),null==i&&null!=r)do o=r,i=r[s];while(null==i&&null!=(r=r.parent));if(null!=i)for(;;){if(l.type===q){for(var u,a=[],f=0,d=l.arguments.length;d>f;f++)u=l.arguments[f],a[f]=v(u,n,t,r);i=i.apply(o,a)}if(null==i||null==l.next)break;if(l=l.next,s=l.body,o=i,i=i[s],null==i)break}return null==i&&(null==l||null!=l.next)&&c("Mask - Accessor error - ",s),i}function d(e){for(var n,t,r=!1,o=39===e?"'":'"',i=C;(n=y.indexOf(o,C))>-1&&(C=n,92===y.charCodeAt(n-1));)r=!0,C++;return t=y.substring(i,C),r===!0&&(t=t.replace(regexpEscapedChar[o],o)),t}function h(){for(var e,n,t=C;;){if(e=y.charCodeAt(C),46===e){if(n===!0)return c("Unexpected punc"),null;n=!0}if(!((e>=48&&57>=e||46===e)&&x>C))break;C++}return+y.substring(t,C)}function p(){var e,n=C,t=y.charCodeAt(C);if(34===t||39===t)return C++,e=d(t),C++,e;for(;;){t=y.charCodeAt(C);{if(!(t>47&&58!==t&&60!==t&&61!==t&&62!==t&&63!==t&&124!==t&&x>C))break;C++}}return y.substring(n,C)}function g(e){return null==e&&C===x?null:40===e?I:41===e?U:44===e?$:46===e?H:43===e?A:45===e?w:42===e?O:47===e?N:61===e?y.charCodeAt(++C)!==e?(c("Not supported (Apply directive)"),null):j:33===e?61===y.charCodeAt(C+1)?(C++,S):E:62===e?61===y.charCodeAt(C+1)?(C++,R):D:60===e?61===y.charCodeAt(C+1)?(C++,L):P:38===e?y.charCodeAt(++C)!==e?(c("Single Binary Operator AND"),null):T:124===e?y.charCodeAt(++C)!==e?(c("Single Binary Operator OR"),null):_:e>=65&&90>=e||e>=97&&122>=e||95===e||36===e?W:e>=48&&57>=e?V:34===e||39===e?K:63===e?F:58===e?B:(c("Unexpected / Unsupported directive"),null)}function m(u){y=u,C=0,x=u.length,b=new e;for(var f,m,v=b,k=Y;;)if(x>C&&33>(f=y.charCodeAt(C)))C++;else{if(C>=x)break;if(m=g(f),null==m&&x>C)break;if(I!==m)if(U!==m)if($!==m)if(F!==m)if(B!==m)if(H===m&&(f=y.charCodeAt(C+1),f>=48&&57>=f?m=V:(m=W,C++)),v.type===G&&(v=s(v,new n(v))),w!==m&&E!==m||null!=v.body)if(w!==m&&A!==m&&O!==m&&N!==m&&T!==m&&_!==m&&j!==m&&S!==m&&D!==m&&R!==m&&P!==m&&L!==m){if((K===m||V===m)&&null!=v.body&&null==v.join){c("Directive Expected");break}if(K!==m)if(V!==m){if(W===m){for(var M=p();x>C;){f=y.charCodeAt(C);{if(!(33>f))break;C++}}if(40===f){k=en,C++;var X=s(v,new r(v,M));v=X.newArgument();continue}110===f&&"null"===M&&(M=null),102===f&&"false"===M&&(M=!1),116===f&&"true"===M&&(M=!0),v=s(v,"string"==typeof M?new o(v,M):new t(M))}}else s(v,new t(h(f)));else C++,s(v,new t(d(f))),C++}else{for(;v&&v.type!==Q;)v=v.parent;if(null==v.body){c("Unexpected operator",v);break}v.join=m;do v=v.parent;while(null!=v&&v.type!==G);null==v&&console.error("Unexpected parent",v),C++}else v=s(v,new i(v,m)),C++;else v=b.case2,C++;else b=new l(b),v=b.case1,C++;else{if(k!==en){c("Unexpected punctuation, comma");break}do v=v.parent;while(null!=v&&v.type!==q);if(null==v){c("OutOfAst Exception - next argument");break}v=v.newArgument(),C++}else{var Z=G;k===en&&(k=Y,Z=q);do v=v.parent;while(null!=v&&v.type!==Z);if(Z===G&&(v=v.parent),null==v){c("OutOfAst Exception - body closed");break}C++}else v=s(v,new n(v)),v=s(v,new e(v)),C++}return null==v.body&&v.type===Q&&c("Unexpected end of expression"),a(b),b}function v(e,n,t,r){var o,i;if(null==e)return null;i="string"==typeof e?k.hasOwnProperty(e)===!0?k[e]:k[e]=m(e):e;var l,s,u,a=i.type;if(G===a){var c,d;e:for(l=0,u=i.body.length;u>l;l++)if(s=i.body[l],c=v(s,n,t,r),null!=d){if(d.join===T)if(o)o=c;else for(;u>l&&i.body[l].join!==_;l++);if(d.join===_){if(o)break e;if(c){o=c;break e}}switch(d.join){case w:o-=c;break;case A:o+=c;break;case N:o/=c;break;case O:o*=c;break;case S:o=o!=c;break;case j:o=o==c;break;case D:o=o>c;break;case R:o=o>=c;break;case P:o=c>o;break;case L:o=c>=o}d=s}else d=s,o=c}if(Q===a)return v(i.body,n,t,r);if(Z===a)return i.body;if(X===a||q===a)return f(i,n,t,r);if(z===a)switch(o=v(i.body,n,t,r),i.prefix){case w:o=-o;break;case E:o=!o}return J===a&&(o=v(i.body,n,t,r),o=v(o?i.case1:i.case2,n,t,r)),o}var y,b,C=0,x=0,k={},w="-",A="+",N="/",O="*",_="||",T="&&",E="!",j="==",S="!=",D=">",R=">=",P="<",L="<=",M=".",I=20,U=21,$=22,H=23,F=24,B=25,W=30,K=31,V=32,G=1,Q=2,X=3,q=4,Z=6,z=9,J=10,Y=1,en=2,nn={};nn[M]=1,nn[N]=2,nn[O]=2,nn[w]=3,nn[A]=3,nn[D]=4,nn[R]=4,nn[P]=4,nn[L]=4,nn[j]=5,nn[S]=5,nn[T]=6,nn[_]=6,n.prototype={constructor:n,type:Q,join:null,body:null},r.prototype={constructor:r,newArgument:function(){var n=new e(this);return this.arguments.push(n),n}},i.prototype={constructor:i,type:z,body:null},l.prototype={constructor:l,type:J,case1:null,case2:null};var tn=function(){function e(e,n){return null==e?n:null==n?e:("string"==typeof e&&(e=[e]),"string"==typeof n?(e.push(n),e):e.concat(n))}return function n(t){if(null==t)return null;"string"==typeof t&&(t=m(t));var r,o;if(G===t.type)for(var i=0,l=t.body.length;l>i;i++)o=n(t.body[i]),r=e(r,o);if(X===t.type){for(var s=t.body,u=t.next;null!=u;){if(q===u.type)return r=n(u),null;if(X!==u.type)return console.error("Ast Exception: next should be a symbol/function ref"),null;s+="."+u.body,u=u.next}return s}if((Q===t.type||z===t.type||J===t.type)&&(o=n(t.body),r=e(r,o)),J===t.type&&(o=n(b.case1),r=e(r,o),o=n(b.case2),r=e(r,o)),q===t.type)for(var i=0,l=t.arguments.length;l>i;i++)o=n(t.arguments[i]),r=e(r,o);return r}}();return{parse:m,eval:v,varRefs:tn}}(),ModelUtils={condition:ConditionUtil.condition,expression:function(e,n,t,r,o){return ExpressionUtil.eval(e,n,t,o)}},CustomAttributes={"class":null,id:null,style:null,name:null,type:null},CustomTags={div:null,span:null,input:null,button:null,textarea:null,select:null,option:null,h1:null,h2:null,h3:null,h4:null,h5:null,h6:null,a:null,p:null,img:null,table:null,td:null,tr:null,pre:null,ul:null,li:null,ol:null,i:null,b:null,strong:null,form:null},Dom={NODE:1,TEXTNODE:2,FRAGMENT:3,COMPONENT:4,CONTROLLER:9,SET:10,Node:Node,TextNode:TextNode,Fragment:Fragment,Component:Component};Node.prototype={constructor:Node,type:Dom.NODE,tagName:null,parent:null,attr:null,nodes:null,__single:null},TextNode.prototype={type:Dom.TEXTNODE,content:null,parent:null},Fragment.prototype={constructor:Fragment,type:Dom.FRAGMENT,nodes:null},Component.prototype={constructor:Component,type:Dom.COMPONENT,parent:null,attr:null,controller:null,nodes:null,components:null};var Parser=function(e,n,t,r){function o(e){for(var n=-1;-1!==(n=e.indexOf(l,n))&&e.charCodeAt(n+1)!==a;)n++;if(-1===n)return e;for(var t,r=[],o=0,i=0;;){if(t=e.indexOf(s,n+2),-1===t)break;for(r[i++]=o===n?"":e.substring(o,n),r[i++]=e.substring(n+2,t),o=n=t+1;-1!==(n=e.indexOf(l,n))&&e.charCodeAt(n+1)!==a;)n++;if(-1===n)break}return e.length>o&&(r[i]=e.substring(o)),e=null,function(e,n,t,o,i,l){if(null==e){for(var s,u="",a=0,c=r.length;c>a;a++)s=r[a],u+=1===a%2?"~["+s+"]":s;return u}return util_interpolate(r,e,n,t,o,i,l)}}function i(e,n,t,r){var o={2:"tag",3:"tag",5:"attribute key",6:"attribute value",8:"literal"}[t],i=e.substring(0,n).split("\n"),l=i.length,s=i[l-1].length,u=["Mask - Unexpected:",r,"at(",l,":",s,") [ in",o,"]"];console.error(u.join(" "),{stopped:e.substring(n),template:e})}var l="~",s="]",u=126,a=91,c=93;return{parse:function(l){for(var s,f,d,h,p,g,m,v=new t,y=v,b=2,C=3,x=0,k=l.length,w=2,A=3,N=5,O=6,_=7,T=8,E=9;;)if(k>x&&33>(g=l.charCodeAt(x)))x++;else if(47!==g||47!==l.charCodeAt(x+1)){if(C===N&&(null!=s&&(v.attr["class"]=o(s),s=null),null!=d&&(v.attr[d]=d,d=null,f=null)),null!=f){if(b===N)null==d?d=f:h=f,null!=d&&null!=h&&("class"!==d?v.attr[d]=h:s=null==s?h:s+" "+h,d=null,h=null);else if(C===A)p=null!=CustomTags[f]?new r(f,v,CustomTags[f]):new e(f,v),null==v.nodes?v.nodes=[p]:v.nodes.push(p),v=p,b=N;else if(C===T){if(p=new n(f,v),null==v.nodes?v.nodes=[p]:v.nodes.push(p),v.__single===!0)do v=v.parent;while(null!=v&&null!=v.__single);b=w}f=null}if(x>=k){b===N&&(null!=s&&(v.attr["class"]=o(s)),null!=d&&(v.attr[d]=d));break}if(b===E){for(v=v.parent;null!=v&&null!=v.__single;)v=v.parent;b=w}switch(g){case 123:C=b,b=w,x++;continue;case 62:C=b,b=w,x++,v.__single=!0;continue;case 59:if(null!=v.nodes){x++;continue}case 125:x++,C=b,b=E;continue;case 39:case 34:b===O?b=N:C=b=T,x++;var j,S=!1,D=!1,R=39===g?"'":'"';for(m=x;(j=l.indexOf(R,x))>-1&&(x=j,92===l.charCodeAt(j-1));)S=!0,x++;m===x&&124===l.charCodeAt(x+1)&&(D=!0,m=x+2,x=j=l.indexOf("|"+R+R,m),-1===x&&(x=k)),f=l.substring(m,x),S===!0&&(f=f.replace(regexpEscapedChar[R],R)),f=o(f),x+=D?3:1;continue}if(b===w){if(C=A,b=A,46===g||35===g){f="div";continue}}else if(b===N)if(46===g)x++,d="class",b=_;else if(35===g)x++,d="id",b=_;else{if(61===g){x++,b=O;continue}if(null!=d){f=d;continue}}(b===O||b===_)&&(C=b,b=N);var P=null;for(m=x;k>x;){if(g=l.charCodeAt(x),g===u&&l.charCodeAt(x+1)===a){P=!0,++x;do g=l.charCodeAt(++x);while(g!==c&&k>x)}if(39===g||34===g||47===g||60===g||44===g){i(l,x,b,String.fromCharCode(g));break}if(C!==O&&(46===g||35===g))break;if(61===g||62===g||123===g||33>g||59===g)break;x++}if(f=l.substring(m,x),!f){i(l,x,b,"*EMPTY*");break}if(P===!0&&b===A){i(l,x,b,"Tag Names cannt be interpolated (in dev)");break}P===!0&&(b===N&&"class"===d)==!1&&(f=o(f))}else for(x++;10!==g&&13!==g&&k>x;)g=l.charCodeAt(++x);return null!=v.parent&&v.parent!==y&&v.parent.__single!==!0&&null!=v.nodes&&console.warn("Mask - ",v.parent.tagName,JSON.stringify(v.parent.attr),"was not proper closed."),1===y.nodes.length?y.nodes[0]:y},cleanObject:function(e){if(e instanceof Array){for(var n=0;e.length>n;n++)this.cleanObject(e[n]);return e}return delete e.parent,delete e.__single,null!=e.nodes&&this.cleanObject(e.nodes),e},setInterpolationQuotes:function(e,n){return e&&2===e.length?n&&1===n.length?(u=e.charCodeAt(0),a=e.charCodeAt(1),c=n.charCodeAt(0),s=n,l=e.charAt(0),void 0):(console.error("Interpolation End must be of 1 Character"),void 0):(console.error("Interpolation Start must contain 2 Characters"),void 0)}}}(Node,TextNode,Fragment,Component),_controllerID=0,cache={},Mask={render:function(e,n,t,r,o){return null!=r&&"function"!=typeof r.appendChild&&(console.error(".render(template[, model, cntx, container, controller]","Container should implement .appendChild method"),console.warn("Args:",arguments)),"string"==typeof e&&(e=hasOwnProp.call(cache,e)?cache[e]:cache[e]=Parser.parse(e)),builder_build(e,n,t,r,o)},compile:Parser.parse,parse:Parser.parse,build:builder_build,registerHandler:function(e,n){CustomTags[e]=n},getHandler:function(e){return null!=e?CustomTags[e]:CustomTags},registerAttrHandler:function(e,n){CustomAttributes[e]=n},registerUtility:function(e,n){ModelUtils[e]=n},clearCache:function(e){"string"==typeof e?delete cache[e]:cache={}},ValueUtils:{condition:ConditionUtil.condition,out:ConditionUtil},Utils:{Condition:ConditionUtil,Expression:ExpressionUtil,getProperty:util_getProperty},Dom:Dom,plugin:function(source){eval(source)},on:function(e,n){null==listeners&&(listeners={}),(listeners[e]||(listeners[e]=[])).push(n)},delegateReload:function(){},setInterpolationQuotes:Parser.setInterpolationQuotes};Mask.renderDom=Mask.render,function(e){var n=function(){function n(e){for(var n="";e--;)n+=" ";return n}function t(e,t,o){var i,l;null==t&&(t=0),null==o&&(i=!0,o=[]);var s=o.length;if(e.type===f.FRAGMENT&&(e=e.nodes),e instanceof Array)for(l=0;e.length>l;l++)r(e[l],t,o);else r(e,t,o);var u=n(t);for(l=s;o.length>l;l++)o[l]=u+o[l];return i?o.join(0===c?"":"\n"):void 0}function r(e,n,r){return"string"==typeof e.content?(r.push(u(e.content)),void 0):"function"==typeof e.content?(r.push(u(e.content())),void 0):i(e)?(r.push(o(e)+";"),void 0):l(e)?(r.push(o(e)+" > "),t(s(e),c,r),void 0):(r.push(o(e)+"{"),t(e.nodes,c,r),r.push("}"),void 0)}function o(e){var n=e.tagName,t=e.attr.id||"",r=e.attr["class"]||"";"function"==typeof t&&(t=t()),"function"==typeof r&&(r=r()),t&&(t=-1!==t.indexOf(" ")?"":"#"+t),r&&(r="."+r.split(" ").join("."));var o="";for(var i in e.attr)if("id"!==i&&"class"!==i){var l=e.attr[i];"function"==typeof l&&(l=l()),(a===!1||/\s/.test(l))&&(l=u(l)),o+=" "+i+"="+l}return"div"===n&&(t||r)&&(n=""),n+t+r+o}function i(e){return null==e.nodes||e.nodes instanceof Array&&0===e.nodes.length}function l(e){return e.nodes&&(e.nodes instanceof Array==!1||1===e.nodes.length)}function s(e){return e.nodes instanceof Array?e.nodes[0]:e.nodes}function u(e){return-1===e.indexOf('"')?'"'+e.trim()+'"':-1===e.indexOf("'")?"'"+e.trim()+"'":'"'+e.replace(/"/g,'\\"').trim()+'"'}var a,c,f=e.Dom;return function(n,r){return"string"==typeof n&&(n=e.parse(n)),"number"==typeof r?(c=r,a=0===c):(c=r&&r.indent||4,a=0===c||r&&r.minimizeAttributes),t(n)}}();e.stringify=n}(Mask),function(e){function n(){this.attr={"debugger":null,use:null,repeat:null,"if":null,"else":null,each:null,log:null}}function t(e,n,t,r){null==e.nodes&&Compo!==void 0&&Compo.ensureTemplate(e);var l=util_getProperty(n,e.attr.foreach||e.attr.each),s=e.nodes;if(e.nodes=[],e.template=s,e.container=r,l instanceof Array!=!1){for(var u=0,a=l.length;a>u;u++)e.nodes[u]=o(s,l[u],r,e);for(var c in i)e[c]=i[c]}}function r(e,n,t,r){var i,l=e.attr.repeat.split(".."),s=+l[0],u=+l[1],a=e.nodes;(isNaN(s)||isNaN(u))&&console.error("Repeat attribute(from..to) invalid",e.attr.repeat),e.nodes=[];for(var c=0;u>s;s++)i=o(a,n,r,e),i._repeatIndex=s,e.nodes[c++]=i}function o(e,n,t,r){var o=new Component;return o.nodes=e,o.model=n,o.container=t,o.parent=r,o}e.registerHandler("%",n),n.prototype={constructor:n,renderStart:function(e,n,o){var i=this.attr;if(null!=i.use)return this.model=util_getProperty(e,i.use),void 0;if(null==i["debugger"]){if(null!=i.log){var l=i.log,s=util_getProperty(e,l);return console.log("Key: %s, Value: %s",l,s),void 0}if(null!=i.repeat&&r(this,e,n,o),this.model=e,null!=i["if"]){var u=i["if"];return this.state=ConditionUtil.isCondition(u,e),this.state||(this.nodes=null),void 0}if(null!=i["else"]){var a=this.parent.components,c=a&&a[a.length-1];return null!=c&&"%"===c.compoName&&null!=c.attr["if"]?(c.state&&(this.nodes=null),void 0):(console.error("Previous Node should be \"% if='condition'\"",c,this.parent),void 0)}(null!=i.each||null!=i.foreach)&&t(this,e,n,o)}},render:null};var i={append:function(n){var t;t=new Component,t.nodes=this.template,t.model=n,e.render(t,n,null,this.container,this)}}}(Mask),function(e){function n(){}function t(){}function r(){}var o={};e.templates=o,e.registerHandler(":template",n),n.prototype.render=function(){return null==this.attr.id?(console.warn("Template Should be defined with ID attribute for future lookup"),void 0):(o[this.attr.id]=this.nodes,void 0)},e.registerHandler(":import",t),t.prototype={constructor:t,attr:null,template:null,renderStart:function(){if(this.attr.id){if(this.nodes=this.template,null==this.nodes&&(this.nodes=o[this.attr.id]),null==this.nodes){for(var e,n=this,t=":template[id="+this.attr.id+"]";null==e&&null!=(n=n.parent);)null!=n.nodes&&(e=jmask(n.nodes).filter(t).get(0));null!=e&&(this.nodes=e.nodes)}null==this.nodes&&console.warn("Template could be not imported",this.attr.id)}}},e.registerHandler(":html",r),r.prototype.render=function(e,n,t){var r=jmask(this.nodes).text(e,n,this);return r?(t.insertAdjacentHTML("beforeend",r),void 0):(console.warn("No HTML for node",this),void 0)}}(Mask),function(e){function n(e,n){for(var t=0,r=n.length-1;r>t;t++){var o=n[t];null==e[o]&&(e[o]={}),e=e[o]}return e}function t(e,n){for(var t=n.split("."),r=t.length,o=0;r>o;o++){if(null==e)return null;e=e[t[o]]}return e}function r(e,n,t){for(var r=n.split("."),o=r.length,i=0,l=null;o-1>i;i++)l=r[i],null==e[l]&&(e[l]={}),e=e[l];e[r[i]]=t}function o(e,r,o){null==e.__observers&&Object.defineProperty(e,"__observers",{value:{__dirty:null},enumerable:!1});var i=e.__observers;if(null!=i[r]){i[r].push(o);var l=t(e,r);return l instanceof Array&&u(l,o),void 0}var s=i[r]=[o],a=r.split("."),c=a.length,f=c>1?n(e,a):e,d=a[c-1],h=f[d];return f instanceof Array?(u(f,o),void 0):(Object.defineProperty(f,d,{get:function(){return h},set:function(e){if(e!==h){if(h=e,e instanceof Array&&u(e,o),null!=i.__dirties)return i.__dirties[r]=1,void 0;for(var n=0,t=s.length;t>n;n++)s[n](e)}}}),h instanceof Array&&u(h,o),void 0)}function i(e,n,o){if(null!=e.__observers&&null!=e.__observers[n]){var i=t(e,n);if(2===arguments.length)return r(e,n,i),delete e.__observers[n],void 0;s(e.__observers[n],o),i instanceof Array&&a(i,o)}}function l(e,n){if(null==n)return e;null==e&&(e={});for(var t in n)e[t]=n[t];return e}function s(e){if(null==e)return!1;for(var n,t=0,r=e.length,o=1,i=arguments.length,l=0;r>t;t++)for(n=e[t],o=1;i>o;o++)if(arguments[o]===n){e.splice(t,1),t--,r--,l++;break}return l+1===i}function u(e,n){null==e.__observers&&Object.defineProperty(e,"__observers",{value:{length:0},enumerable:!1});for(var t,r=0,o=["push","unshift","splice","pop","shift","reverse","sort"],i=o.length;i>r;r++)t=o[r],e[t]=c(e,e[t],t);var l=e.__observers;l[l.length++]=n}function a(e,n){var t=e.__observers;if(null!=t)for(var r=0,o=e.length;o>r;r++)if(e[r]===n){o--,e.length--,e[r]=null;for(var i=r;o>i;i++)e[i]=e[i+1]}}function c(e,n,t){return function(){f(e,n,t,j.call(arguments))}}function f(e,n,t,r){var o=e.__observers,i=n.apply(e,r);if(null==o||0===o.length)return i;if(null!=o.__dirty)return o.__dirty=!0,i;for(var l,s=0,u=o.length;u>s;s++)l=o[s],"function"==typeof l&&l(e,t,r);return i}function d(e){return e.parentNode.removeChild(e)}function h(e){if(null!=e)for(var n=0,t=e.length;t>n;n++)d(e[n])}function p(e,n){return n.parentNode.insertBefore(e,n.nextSibling)}function g(e,n){return n.parentNode.insertBefore(e,n)}function m(e,n,t){return null!=e.addEventListener?(e.addEventListener(n,t,!1),void 0):(e.attachEvent&&e.attachEvent("on"+n,t),void 0)}function v(e,n,t){if(null==e.components)return p(t,e.placeholder);for(var r,o=e.components,i=null,l=!0,s=o.length,u=n;s>u;u++)if(r=o[u].elements,r&&r.length){i=r[0];break}if(null==i)for(l=!1,u=s>n?n:s;--u>-1;)if(r=o[u].elements,r&&r.length){i=r[r.length-1];break}return null==i&&(i=e.placeholder),l?g(t,i):p(t,i)}function y(n,t,r,o,i){return e.render(t,r,o,i,n)}function b(e,n){if(null==e)return!1;h(e.elements),e.elements=null,Compo!==void 0&&Compo.dispose(e);var t=n&&n.components||e.parent&&e.parent.components;return null==t?(console.error("Parent Components Collection is undefined"),!1):s(t,e)}function C(e){Compo!==void 0&&Compo.signal.emitIn(e,"domInsert")}function x(e,n){if("function"==typeof e.dispose){var t=e.dispose;return e.dispose=function(){n.call(this),t.call(this)},void 0}e.dispose=n}function k(e,n,t,r,i){var l=P(e),s=L(l);if(null!=s){if("string"==typeof s)return o(n,s,i),void 0;for(var u=0,a=s.length;a>u;u++)o(n,s[u],i)}}function w(e,n,t){var r=P(e),o=L(r);if(null!=o){if("string"==typeof o)return i(n,o,t),void 0;for(var l=0,s=o.length;s>l;l++)i(n,o[l],t)}}function A(e,n,t,r,o){var i=0;return function(){return i++>10?(console.warn("Concurent binder detected",e),void 0):(o(R(e,n,t,r)),i--,void 0)}}function N(){}function O(){}function _(){}function T(e,n){if(null==n&&(n=[]),null==e.components)return n;for(var t,r=e.components,o=0,i=r.length;i>o;o++)t=r[o],"validate"!==t.compoName?T(t):n.push(t);return n}var E=window.jQuery||window.Zepto||window.$,j=Array.prototype.slice,S=e.Utils.Expression,D=S.eval,R=function(e,n,t,r){var o=D(e,n,t,r);return null==o?"":o},P=S.parse,L=S.varRefs,M=function(){function n(e,n,t,r){null==r&&(r=":bind"===t.compoName?"single":"dual");var o=t.attr;if(this.node=t,this.controller=t,this.model=e,this.element=n,this.value=o.value,this.property=o.property,this.setter=t.attr.setter,this.getter=t.attr.getter,this.dismiss=0,this.bindingType=r,this.log=!1,this.signal_domChanged=null,this.signal_objectChanged=null,this.locked=!1,null==this.property)switch(n.tagName){case"INPUT":var i=n.getAttribute("type");if("checkbox"===i){this.property="element.checked";break}this.property="element.value";break;case"TEXTAREA":this.property="element.value";break;default:this.property="element.innerHTML"}if(o.log&&(this.log=!0,"log"!==o.log&&(this.logExpression=o.log)),o["x-signal"])for(var i,l,s,u=o["x-signal"].split(";"),a=0,c=u.length;c>a;a++)switch(s=u[a].split(":"),s.length){case 1:this.signal_domChanged=s[0];break;case 2:i=s[0].trim(),l=s[1].trim(),"dom"===i&&(this.signal_domChanged=l),"object"===i&&(this.signal_domChanged=l)}if(o.expression){if(this.expression=o.expression,null==this.value&&"single"!==r){var f=L(this.expression);"string"==typeof f?this.value=f:console.warn("Please set value attribute in DualBind Control.")}}else this.expression=this.value}function s(e){var n=e.expression,t=e.model,r=e.objectChanged=e.objectChanged.bind(e);if(e.binder=A(n,t,e.cntx,e.node,r),k(n,t,e.cntx,e.node,e.binder),"dual"===e.bindingType){var o=e.element,i=e.node.attr.changeEvent||"change",l=e.domChanged.bind(e);m(o,i,l)}return e.objectChanged(),e}function u(e,n,t){var r=e.slots;(null==r||"function"!=typeof r[n]||r[n].apply(e,t)!==!1)&&null!=e.parent&&u(e.parent,n,t)}e.registerBinding=function(e,n){a[e]=n},e.BindingProvider=n;var a={};return n.create=function(e,t,r,o){var i,u=r.attr.bindingProvider,c=null==u?null:a[u];return"function"==typeof c?new c(e,t,r,o):(i=new n(e,t,r,o),null!=c&&l(i,c),s(i))},n.prototype={constructor:n,dispose:function(){w(this.expression,this.model,this.binder)},objectChanged:function(e){if(!(this.dismiss-->0)){if(this.locked===!0)return console.warn("Concurance change detected",this),void 0;this.locked=!0,null==e&&(e=this.objectWay.get(this,this.expression)),this.domWay.set(this,e),this.log&&console.log("[BindingProvider] objectChanged -",e),this.signal_objectChanged&&u(this.node,this.signal_objectChanged,[e]),this.locked=!1}},domChanged:function(){if(this.locked===!0)return console.warn("Concurance change detected",this),void 0;this.locked=!0;var e=this.domWay.get(this),n=!0;if(this.node.validations)for(var t,r=0,o=this.node.validations.length;o>r;r++)if(t=this.node.validations[r],t.validate(e,this.element,this.objectChanged.bind(this))===!1){n=!1;break}n&&(this.dismiss=1,this.objectWay.set(this.model,this.value,e),this.dismiss=0,this.log&&console.log("[BindingProvider] domChanged -",e),this.signal_domChanged&&u(this.node,this.signal_domChanged,[e])),this.locked=!1},objectWay:{get:function(e,n){return R(n,e.model,e.cntx,e)},set:function(e,n,t){r(e,n,t)}},domWay:{get:function(e){if(e.getter){var n=e.node.parent;return null==n||"function"!=typeof n[e.getter]?(console.error("Mask.bindings: Getter should be a function",e.getter,e),null):n[e.getter]()}return t(e,e.property)},set:function(e,n){if(e.setter){var t=e.node.parent;if(null==t||"function"!=typeof t[e.setter])return console.error("Mask.bindings: Getter should be a function",e.getter,e),void 0;t[e.setter](n)}else r(e,e.property,n)}}},l(n,{addObserver:o,removeObserver:i}),n}();e.registerHandler(":visible",N),N.prototype={constructor:N,refresh:function(n,t){t.style.display=e.Utils.Condition.isCondition(this.attr.check,n)?"":"none"},renderStart:function(e,n,t){this.refresh(e,t),this.attr.bind&&o(e,this.attr.bind,this.refresh.bind(this,e,t))}},function(){function n(){}e.registerHandler(":bind",n),n.prototype={constructor:n,renderStart:function(e,n,t){this.provider=M.create(e,t,this,"single")},dispose:function(){this.provider&&"function"==typeof this.provider.dispose&&this.provider.dispose()}}}(),e.registerHandler(":dualbind",O),O.prototype={constructor:O,renderEnd:function(e,n,t,r){if(this.components)for(var o,i=0,l=this.components.length;l>i;i++)o=this.components[i],":validate"===o.compoName&&(this.validations||(this.validations=[])).push(o);this.provider=M.create(n,r,this)},dispose:function(){this.provider&&"function"==typeof this.provider.dispose&&this.provider.dispose()}},function(){function n(){}function r(e,n,t){console.warn("Validate Notification:",e,n);var r=E(e).next(".-validate-invalid");0===r.length&&(r=E("<div>").addClass("-validate-invalid").html("<span></span><button>cancel</button>").insertAfter(e)),r.children("button").off().on("click",function(){r.hide(),t&&t()}).end().children("span").text(n).end().show()}function o(e){E(e).next(".-validate-invalid").hide()}e.registerValidator=function(e,n){i[e]=n},e.registerHandler(":validate",n),n.prototype={constructor:n,renderStart:function(e,n,t){this.element=t,this.model=e
},validate:function(e,n,i){null==n&&(n=this.element),this.attr.getter&&(e=t({node:this,element:n},this.attr.getter)),null==this.validators&&this.initValidators();for(var l,s=0,u=this.validators.length;u>s;s++)if(l=this.validators[s],l.validate(this,e)===!1)return r(n,this.message,i),!1;return o(n),!0},initValidators:function(){this.validators=[],this.message=this.attr.message,delete this.attr.message;for(var e in this.attr)if(e in i!=!1){var n=i[e];"function"==typeof n&&(n=new n(this)),this.validators.push(n)}else console.error("Unknown Validator:",e,this)}};var i={match:{validate:function(e,n){return RegExp(e.attr.match).test(n)}},unmatch:{validate:function(e,n){return!RegExp(e.attr.unmatch).test(n)}},minLength:{validate:function(e,n){return n.length>=parseInt(e.attr.minLength,10)}},maxLength:{validate:function(e,n){return n.length<=parseInt(e.attr.maxLength,10)}},check:{validate:function(e,n){return R(e.attr.check,e.model,{x:n},e)}}}}(),e.registerHandler(":validate:group",_),_.prototype={constructor:_,validate:function(){for(var e,n=T(this),t=0,r=n.length;r>t;t++)if(e=n[t],!e.validate())return!1;return!0}},function(){function n(e,n,t,r,o){return function(n){switch(e){case"node":t.textContent=n;break;case"attr":var i,l,s=typeof t[o];if("boolean"===s)return r=t[o]=!!n,void 0;if("string"===s)return r=t[o]=t[o].replace(r,n),void 0;i=t.getAttribute(o),l=i?i.replace(r,n):n,t.setAttribute(o,l),r=n}}}e.registerUtility("bind",function(e,t,r,o,i,l,s){var u=R(e,t,r,i);"node"===s&&(o=document.createTextNode(u));var a=n(s,e,o,u,l),c=A(e,t,r,i,a);return k(e,t,r,i,c),x(i,function(){w(e,t,c)}),"node"===s?o:"attr"===s?u:(console.error("Unknown binding type",arguments),"Unknown")})}(),function(e){function n(){}e.registerHandler("%%",n);var t=function(){var e={refresh:function(e){this.model=e,this.elements&&(h(this.elements),this.elements=[]),Compo!==void 0&&Compo.dispose(this),g(y(this,this.nodes,this.model,this.cntx),this.placeholder)},dispose:function(){w(this.expr,this.originalModel,this.binder)}};return function(n,t,r,o){var i=n.attr.use;l(n,{expr:i,placeholder:document.createComment(""),binder:A(i,t,r,n,e.refresh.bind(n)),originalModel:t,model:R(i,t,r,n),dispose:e.dispose}),k(i,t,r,n,n.binder),o.appendChild(n.placeholder)}}(),r=function(){return function(e,n,t){function r(e){console.log("Logger > Key: %s, Value: %s",o,e)}var o=e.attr.log,i=A(o,n,t,e,r),l=R(o,n,t,e);k(o,n,t,e,i),x(e,function(){w(o,n,i)}),r(l)}}(),o=function(){var e={refresh:function(e){(null!=this.elements||e)&&(null==this.elements?(g(y(this,this.template,this.model,this.cntx),this.placeholder),this.$=E(this.elements)):(null==this.$&&(this.$=E(this.elements)),this.$[e?"show":"hide"]()),this.onchange&&this.onchange(e))},dispose:function(){w(this.expr,this.model,this.binder),this.onchange=null,this.elements=null}};return function(n,t,r,o){var i=n.attr["if"];l(n,{expr:i,template:n.nodes,placeholder:document.createComment(""),binder:A(i,t,r,n,e.refresh.bind(n)),state:!!R(i,t,r,n)}),n.state||(n.nodes=null),k(i,t,r,n,n.binder),o.appendChild(n.placeholder)}}(),i=function(){var e={refresh:function(e){if(null!=this.elements||!e){if(null==this.elements)return g(y(this,this.template,this.model,this.cntx)),this.$=E(this.elements),void 0;null==this.$&&(this.$=E(this.elements)),this.$[e?"hide":"show"]()}}};return function(n,t,r,o){var i=n.parent.components,l=i&&i[i.length-1];return n.template=n.nodes,n.placeholder=document.createComment(""),null==l||"%%"!==l.compoName||null==l.attr["if"]?(console.error('Mask.Binding: Binded ELSE should be after binded IF - %% if="expression" { ...'),void 0):(l.onchange=e.refresh.bind(n),l.state&&(n.nodes=null),o.appendChild(n.placeholder),void 0)}}(),s=function(){function n(e,n){var t=[];if(n instanceof Array==!1)return t;for(var r,o=0,l=n.length;l>o;o++){switch(r=n[o],typeof r){case"string":case"number":case"boolean":r=n[o]=Object(r)}t[o]=new i(e.template,r,e)}return t}function t(e,n){for(var t=e.components,r=0,o=t.length,i=0,l=null,s=null,u=null,a=document.createDocumentFragment(),c=[];o>r;r++)if(u=t[r],null!=u.elements&&0!==u.elements.length)for(i=0,l=u.elements.length;l>i;i++)s=u.elements[i],s.parentNode.removeChild(s);e:for(i=0,l=n.length;l>i;i++){for(r=0;o>r;r++)if(n[i]===t[r].model){c[i]=t[r];continue e}console.warn("No Model Found for",n[i])}for(r=0,o=c.length;o>r;r++)if(u=c[r],null!=u.elements&&0!==u.elements.length)for(i=0,l=u.elements.length;l>i;i++)s=u.elements[i],a.appendChild(s);e.components=c,g(a,e.placeholder)}function r(e,t,r,i,l){if(null!=t&&null!=r){var s=t,u=t+r;for(u>e.components.length&&(u=e.components.length);u>s;s++)b(e.components[s],e)&&(s--,u--)}if(null!=i&&l&&l.length){var a=new o,c=n(e,l),f=y(a,c),d=a.components;v(e,i,f),C(a),null==e.components&&(e.components=[]),e.components.splice.apply(e.components,[i,0].concat(d))}}var o=e.Dom.Component,i=function(){function e(e,n,t){this.nodes=e,this.model=n,this.parent=t}var n=o.prototype;e.prototype={constructor:s,renderEnd:function(e){this.elements=e}};for(var t in n)e.prototype[t]=n[t];return e}(),s={append:function(n){var t=new i(this.template,n,this);e.render(t,n,null,this.container,this)}},u={refresh:function(e,o,i){var l,s,u=0;if(null==o){if(null!=this.components)for(u=0,s=this.components.length;s>u;u++)l=this.components[u],b(l,this)&&(u--,s--);return this.components=[],this.nodes=n(this,e),g(y(this,this.nodes),this.placeholder),void 0}for(s=e.length;s>u;u++)switch(l=e[u],typeof l){case"string":case"number":case"boolean":e[u]=Object(l)}switch(o){case"push":r(this,null,null,e.length,e.slice(e.length-1));break;case"pop":r(this,e.length,1);break;case"unshift":r(this,null,null,0,e.slice(0,1));break;case"shift":r(this,0,1);break;case"splice":var a=i[0],c=1===i.length?this.components.length:i[1],f=i.length>2?e.slice(i[0],i.length-2+i[0]):null;r(this,a,c,a,f);break;case"sort":case"reverse":t(this,e)}},dispose:function(){w(this.expr,this.model,this.refresh)}};return function(e,t,r,o){null==e.nodes&&Compo!==void 0&&Compo.ensureTemplate(e);var i=e.attr.each||e.attr.foreach,a=R(i,t,r,e);l(e,{expr:i,binder:A(i,t,r,e,u.refresh.bind(e)),template:e.nodes,container:o,placeholder:document.createComment(""),dispose:u.dispose}),o.appendChild(e.placeholder),k(e.expr,t,r,e,e.binder);for(var c in s)e[c]=s[c];e.nodes=n(e,a)}}(),u=function(){var e={refresh:function(){if(this.refreshing!==!0){this.refreshing=!0;for(var e,n=R(this.attr.visible,this.model,this.cntx,this),t=0,r=this.elements.length;r>t;t++)e=this.elements[t],e.style.display=n?"":"none";this.refreshing=!1}},dispose:function(){w(this.expr,this.model,this.binder)}};return function(n,t,r){var o=n.attr.visible;l(n,{expr:o,binder:A(o,t,r,n,e.refresh.bind(n)),dispose:e.dispose}),k(o,t,r,n,n.binder),e.refresh.call(n)}}();n.prototype={constructor:n,elements:null,renderStart:function(e,n,l){var u=this.attr;if(null==u["debugger"])return null!=u.use?(t(this,e,n,l),void 0):null!=u.log?(r(this,e,n,l),void 0):(this.model=e,null!=u["if"]?(o(this,e,n,l),void 0):null!=u["else"]?(i(this,e,n,l),void 0):((null!=u.each||null!=u.foreach)&&s(this,e,n,l),void 0))},render:null,renderEnd:function(e){this.elements=e,null!=this.attr.visible&&u(this,this.model,this.cntx)}}}(e)}(Mask);var Compo=exports.Compo=function(e){function n(e,n){if(null==e&&(e={}),null==n)return e;for(var t in n)e[t]=n[t];return e}function t(e){var n={};for(var t in e)n[t]=e[t];return n}function r(e,n,t){if(null==e&&console.warn("selector is null for type",n),"object"==typeof e)return e;var r,o,i;if(null==r)switch(e[0]){case"#":r="id",e=e.substring(1),o="attr";break;case".":r="class",e=RegExp("\\b"+e.substring(1)+"\\b"),o="attr";break;default:r=n===c.SET?"tagName":"compoName"}return i="up"===t?"parent":n===c.SET?"nodes":"components",{key:r,prop:o,selector:e,nextKey:i}}function o(e,n,t){"string"==typeof n&&(null==t&&(t=c[e.compoName?"CONTROLLER":"SET"]),n=r(n,t));var o=n.prop?e[n.prop]:e;if(null==o)return!1;if(null!=n.selector.test){if(n.selector.test(o[n.key]))return!0}else if(o[n.key]==n.selector)return!0;return!1}function i(e,n){if(e instanceof Array){for(var t,r=0,l=e.length;l>r;r++){t=e[r];var s=i(t,n);if(null!=s)return s}return null}return o(e,n)===!0?e:(e=e[n.nextKey])&&i(e,n)}function l(e,n,t){return null!=e.addEventListener?(e.addEventListener(n,t,!1),void 0):(e.attachEvent&&e.attachEvent("on"+n,t),void 0)}function s(e,n){return e.filter(n).add(e.find(n))}function u(e,n,t,r){return null==t?e.on(n,r):(e.on(n,t,r),e.filter(t).on(n,r),e)}var a=global.jQuery||global.Zepto||global.$,c=e.Dom,f=Array.prototype.slice;a||console.warn("jQuery / Zepto etc. was not loaded before compo.js, please use Compo.config.setDOMLibrary to define dom engine");var d={select:function(e,n){for(var t in n){var r=n[t],o=null,i=null;if(r instanceof Array&&(i=r[0],o=r.splice(1)),"string"==typeof r&&(i=r),null==r||null==i)return console.error("Unknown component child",t,n[t]),console.warn("Is this object shared within multiple compo classes? Define it in constructor!"),void 0;var l=i.indexOf(":"),s=i.substring(0,l);s=y.config.selectors[s],null==s?e.compos[t]=e.$[0].querySelector(i):(i=i.substring(++l).trim(),e.compos[t]=s(e,i));var u=e.compos[t];null!=o&&(u instanceof y&&(u=u.$),h.on(e,o,u))}}},h={on:function(e,n,t){null==t&&(t=e.$);for(var r,o=n instanceof Array,i=o?n.length:1,l=0;o?i>l:1>l;l++)if(r=o?n[l]:n,r instanceof Array)null!=p&&(r[0]=p(r[0])),t.on.apply(t,r);else for(var s in r){var a,c,f="string"==typeof r[s]?e[r[s]]:r[s],d=s.indexOf(":");-1!==d?(a=s.substring(0,d),c=s.substring(d+1).trim()):a=s,null!=p&&(a=p(a)),u(t,a,c,f.bind(e))}}},p=null,g=function(){var e=function(){if(null==document)return!1;if("createTouch"in document)return!0;try{return!!document.createEvent("TouchEvent").initTouchEvent}catch(e){return!1}}();return{touch:function(n){return e===!1?n:"click"===n?"touchend":"mousedown"===n?"touchstart":"mouseup"===n?"touchend":"mousemove"===n?"touchmove":n}}}(),m=function(){function n(e,n){return function(){new s(e).emit(n)}}function t(e,n){return null==n.pipes[e]?(console.error("Controller has no pipes to be added to collection",e,n),void 0):(null==u[e]&&(u[e]=[]),u[e].push(n),void 0)}function r(e,n){for(var t=u[e],r=t.length;--r;)t[r]===n&&(t.splice(r,1),r++)}function o(){var e=this,n=e.pipes;for(var t in n)r(t,e)}function i(e){var n=e.pipes;if(null==n)return console.error("Controller has no pipes",e),void 0;for(var r in n)t(r,e);y.attachDisposer(e,o.bind(e))}function s(e){return this instanceof s==!1?new s(e):(this.pipeName=e,this)}e.registerAttrHandler("x-pipe-signal",function(e,t,r,o,i){for(var s,u=t.split(";"),a=0,c=u.length;c>a;a++)if(s=u[a].trim(),""!==s){var f,d,h=s.substring(0,s.indexOf(":")),g=s.substring(s.indexOf(":")+1).trim(),m=g.indexOf(".");if(-1===m)return console.error('define pipeName "click: pipeName.pipeSignal"'),void 0;f=g.substring(0,m),d=g.substring(++m);var v=n(f,d);!h&&console.error("Signal: event type is not set",t),null!=p&&(h=p(h)),l(i,h,v)}});var u={};return s.prototype={constructor:s,emit:function(e,n){var t=u[this.pipeName],r=this.pipeName;if(null==t)return console.warn("Pipe.emit: No signals were bound to a Pipe",r),void 0;for(var o,i,l,s,a=t.length;-1!==--a;)o=t[a],i=o.pipes[r],null!=i&&(l=i[e],"function"==typeof l&&(l.apply(o,n),s=!0));s!==!0&&console.warn("No piped slot found for a signal",e,r)}},s.addController=i,s.removeController=o,{addController:i,removeController:o,emit:function(e,n,t){s(e).emit(n,t)},pipe:s}}(),v=function(){var e={};return{create:function(n){return null==n.ID?(console.warn("Component should have an ID"),void 0):(e[n.ID]=n,void 0)},resolveCompo:function(n){if(null==n)return null;var t,r,o;do{if(r=n.getAttribute("x-compo-id"),r&&(null==t&&(t=r),o=e[r],null!=o&&(o=y.find(o,{key:"ID",selector:t,nextKey:"components"}),null!=o)))return o;n=n.parentNode}while(n&&1===n.nodeType);return t&&console.warn("No controller for ID",t),null},removeCompo:function(n){null!=n.ID&&delete e[n.ID]}}}(),y=function(){function o(e){if(this instanceof o)return null;var n;null==e&&(e={}),e.hasOwnProperty("constructor")&&(n=e.constructor),n=C(n,e),null==n&&(n=function(){});for(var t in x)null==e[t]&&(e[t]=x[t]),e["base_"+t]=x[t];return n.prototype=e,e=null,n}function l(e){null!=e.dispose&&e.dispose(),v.removeCompo(e);var n=0,t=e.components,r=t&&t.length;if(r)for(;r>n;n++)l(t[n])}function u(n){if(null==n.nodes){if(n.template)return n.nodes=e.parse(n.template),void 0;var t=n.attr.template;if("string"==typeof t){if("#"===t[0]){var r=document.getElementById(t.substring(1));if(null==r)return console.error("Template holder not found by id:",t),void 0;t=r.innerHTML}t=e.parse(t)}t!==void 0&&(n.nodes=t,delete n.attr.template)}}function y(){var e=[];return e.appendChild=function(e){this.push(e)},e}function b(e,n){if("function"==typeof e.dispose){var t=e.dispose;return e.dispose=function(){n(),t()},void 0}e.dispose=n}function C(e,n){var r=n.compos,o=n.pipes;return null==r&&null==o?e:function(){null!=r&&(this.compos=t(r)),null!=o&&m.addController(this),"function"==typeof e&&e.call(this)}}n(o,{create:function(e){var n;null==e&&(e={}),e.hasOwnProperty("constructor")&&(n=e.constructor),null==n&&(n=function(){});for(var t in x)null==e[t]&&(e[t]=x[t]),e["base_"+t]=x[t];return n.prototype=e,n},render:function(n,t,r,o){u(n);var i=[];return e.render(null==n.tagName?n.nodes:n,t,r,o,n,i),n.$=a(i),null!=n.events&&h.on(n,n.events),null!=n.compos&&d.select(n,n.compos),n},initialize:function(n,t,r,i,l){null==i&&(r&&null!=r.nodeType?(i=r,r=null):t&&null!=t.nodeType&&(i=t,t=null)),"string"==typeof n&&(n=e.getHandler(n),n||console.error("Compo not found:",n));var s={controller:n,type:c.COMPONENT};null==l&&null!=i&&(l=v.resolveCompo(i)),null==l&&(l=new c.Component);var u=e.render(s,t,r,null,l),a=l.components[l.components.length-1];return null!=i&&(i.appendChild(u),o.signal.emitIn(a,"domInsert")),a},dispose:function(e){"function"==typeof e.dispose&&e.dispose();var n=0,t=e.components,r=t&&t.length;if(r)for(;r>n;n++)o.dispose(t[n])},find:function(e,n){return i(e,r(n,c.CONTROLLER,"down"))},closest:function(e,n){return i(e,r(n,c.CONTROLLER,"up"))},ensureTemplate:u,attachDisposer:b,config:{selectors:{$:function(e,n){var t=s(e.$,n);return 0===t.length&&console.error("Compo Selector - element not found -",n,e),t},compo:function(e,n){var t=o.find(e,n);return null==t&&console.error("Compo Selector - component not found -",n,e),t}},setDOMLibrary:function(e){a=e},eventDecorator:function(e){return"function"==typeof e?(p=e,void 0):"string"==typeof e?(p=g[e],void 0):"boolean"==typeof e&&e===!1?(p=null,void 0):void 0}},pipe:m.pipe});var x={type:c.CONTROLLER,tagName:null,compoName:null,nodes:null,attr:null,slots:null,pipes:null,onRenderStart:null,onRenderEnd:null,render:null,renderStart:function(e,n,t){1===arguments.length&&null!=e&&e instanceof Array==!1&&null!=e[0]&&(e=arguments[0][0],n=arguments[0][1],t=arguments[0][2]),"function"==typeof this.onRenderStart&&this.onRenderStart(e,n,t),null==this.model&&(this.model=e),null==this.nodes&&u(this)},renderEnd:function(e,n,t,r){1===arguments.length&&e instanceof Array==!1&&(e=arguments[0][0],n=arguments[0][1],t=arguments[0][2],r=arguments[0][3]),v.create(this,e),this.$=a(e),null!=this.events&&h.on(this,this.events),null!=this.compos&&d.select(this,this.compos),"function"==typeof this.onRenderEnd&&this.onRenderEnd(e,n,t,r)},appendTo:function(e){var n;if(n="string"==typeof e?document.querySelector(e):e,null==n)return console.warn("Compo.appendTo: parent is undefined. Args:",arguments),this;for(var t=0;this.$.length>t;t++)n.appendChild(this.$[t]);return this.emitIn("domInsert"),this},append:function(n,t,o){var l;if(null==this.$){var s="string"==typeof n?e.compile(n):n;return l=o?i(this,r(o,c.CONTROLLER,"down")):this,null==l.nodes?(this.nodes=s,this):(l.nodes=[this.nodes,s],this)}var u=e.render(n,t,null,y(),this);l=o?this.$.find(o):this.$;for(var a=0;u.length>a;a++)l.append(u[a]);return this.emitIn("domInsert"),this},find:function(e){return i(this,r(e,c.CONTROLLER,"down"))},closest:function(e){return i(this,r(e,c.CONTROLLER,"up"))},on:function(){var e=Array.prototype.slice.call(arguments);return 3>arguments.length?(console.error("Invalid Arguments Exception @use .on(type,selector,fn)"),this):(null!=this.$&&h.on(this,[e]),null==this.events?this.events=[e]:this.events instanceof Array?this.events.push(e):this.events=[e,this.events],this)},remove:function(){null!=this.$&&(this.$.remove(),this.$=null),l(this);var e=this.parent&&this.parent.components;if(null!=e){var n=e.indexOf(this);if(-1===n)return console.warn("Compo::remove - parent doesnt contains me",this),this;e.splice(n,1)}return this},slotState:function(e,n){o.slot.toggle(this,e,n)},signalState:function(e,n){o.signal.toggle(this,e,n)},emitOut:function(e){o.signal.emitOut(this,e,this,arguments.length>1?f.call(arguments,1):null)},emitIn:function(e){o.signal.emitIn(this,e,this,arguments.length>1?f.call(arguments,1):null)}};return o.prototype=x,o}();return function(){function t(e,n,r,o,i){if(null!=e){if(null!=e.slots&&"function"==typeof e.slots[n]){var l=e.slots[n],s=null!=e.slots.__disabled&&e.slots.__disabled[n];if(s!==!0){var u=null==o?l.call(e,r):l.apply(e,[r].concat(o));if(u===!1)return}}if(-1===i&&null!=e.parent&&t(e.parent,n,r,o,i),1===i&&null!=e.components)for(var a=0,c=e.components.length;c>a;a++)t(e.components[a],n,r,o,i)}}function r(e,n,t,o){if(null==e)return!1;var i=e.slots;if(null!=i&&null!=i[n]&&("string"==typeof i[n]&&(i[n]=e[i[n]]),"function"==typeof i[n])){if(o!==!0)return!0;if(null==i.__disabled||i.__disabled[n]!==!0)return!0}if(-1===t&&null!=e.parent)return r(e.parent,n,t);if(1===t&&null!=e.components)for(var l=0,s=e.components.length;s>l;l++)if(r(e.components[l],n,t))return!0;return!1}function o(e,n){return r(e,n,-1)===!1?null:function(r){t(e,n,r,null,-1)}}function i(e,n,t){var r=e.slots;null!=r&&r.hasOwnProperty(n)!==!1&&(null==r.__disabled&&(r.__disabled={}),r.__disabled[n]=t===!1)}function s(e,n,t){if(i(e,n,t),null!=e.components)for(var r=0,o=e.components.length;o>r;r++)s(e.components[r],n,t)}function u(e,n,t){return null==e.$?(console.warn("Controller has no elements to toggle state"),void 0):(a().add(e.$.filter("[data-signals]")).add(e.$.find("[data-signals]")).each(function(e,r){var o=r.getAttribute("data-signals");null!=o&&-1!==o.indexOf(n)&&r[t===!0?"removeAttribute":"setAttribute"]("disabled","disabled")}),void 0)}function c(e,n,t){for(var r=e,o=e;null!=(r=r.parent);)i(r,n,t),null!=r.$&&0!==r.$.length&&(o=r);s(e,n,t),u(o,n,t)}function f(e,n,t){i(e,n,t),(t||!r(e,n,-1,!0)&&!r(e,n,1,!0))&&u(e,n,t)}e.registerAttrHandler("x-signal",function(e,n,t,r,i,s){for(var u,a=n.split(";"),c="",f=0,d=a.length;d>f;f++)if(u=a[f].trim(),""!==u){var h=u.substring(0,u.indexOf(":")),g=u.substring(u.indexOf(":")+1).trim(),m=o(s,g);!h&&console.error("Signal: event type is not set",n),m&&(null!=p&&(h=p(h)),c+=","+g+",",l(i,h,m)),!m&&console.warn("No slot found for signal",g,s)}""!==c&&i.setAttribute("data-signals",c)}),n(y,{signal:{toggle:c,emitOut:function(e,n,r,o){t(e,n,r,o,-1)},emitIn:function(e,n,r,o){t(e,n,r,o,1)},enable:function(e,n){c(e,n,!0)},disable:function(e,n){c(e,n,!1)}},slot:{toggle:f,enable:function(e,n){f(e,n,!0)},disable:function(e,n){f(e,n,!1)},invoke:function(e,n,t,r){var o=e.slots;return null==o||"function"!=typeof o[n]?(console.error("Slot not found",n,e),null):null==r?o[n].call(e,t):o[n].apply(e,[t].concat(r))}}})}(),function(){null!=a&&null!=a.fn&&(a.fn.compo=function(e){if(0===this.length)return null;var n=v.resolveCompo(this[0]);return null==e?n:i(n,r(e,c.CONTROLLER,"up"))},a.fn.model=function(e){var n=this.compo(e);if(null==n)return null;for(var t=n.model;null==t&&n.parent;)n=n.parent,t=n.model;return t})}(),y}(Mask),jmask=exports.jmask=function(e){function n(e,n){if(null==e&&(e={}),null==n)return e;for(var t in n)e[t]=n[t];return e}function t(e,n){for(var t=0,r=e.length;r>t;t++)n(e[t],t)}function r(e,n){if(null==e)return console.error("Can not remove myself from parent",n),void 0;var t=e.indexOf(n);return-1===t?(console.error("Can not remove myself from parent",n,t),void 0):(e.splice(t,1),void 0)}function o(e,n,t){if(null==e&&console.warn("selector is null for type",n),"object"==typeof e)return e;var r,o,l,s,u,a,c,f,d,p=0,g=e.length;for(r="up"===t?"parent":n===h.SET?"nodes":"components";g>p;)u=e.charCodeAt(p),33>u||(a=i(e,p+1,g),46===u?(o="class",l="attr",s=RegExp("\\b"+e.substring(p+1,a)+"\\b")):35===u?(o="id",l="attr",s=e.substring(p+1,a)):91===u?(f=e.indexOf("=",p),-1===f&&console.error('Attribute Selector: should contain "="'),l="attr",o=e.substring(p+1,f),u=e.charCodeAt(f+1),d=34===u||39===u?2:1,s=e.substring(f+d,a-d+1),a++):(l=null,o=n===h.SET?"tagName":"compoName",s=e.substring(p,a)),p=a,null!=c?(null==c.filters&&(c.filters=[]),c.filters.push({key:o,selector:s,prop:l})):c={key:o,prop:l,selector:s,nextKey:r,filters:null});return c}function i(e,n,t){for(var r,o=!1,i=!1;t>n&&(r=e.charCodeAt(n),(34===r||39===r)&&(o=!o),92===r&&(i=!i),!(46===r||35===r||91===r||93===r||33>r)||o===!0&&i===!0);)n++;return n}function l(e,n,t){"string"==typeof n&&(null==t&&(t=h[e.compoName?"CONTROLLER":"SET"]),n=o(n,t));var r=n.prop?e[n.prop]:e,i=!1;if(null==r)return!1;if(null!=n.selector.test?n.selector.test(r[n.key])&&(i=!0):r[n.key]===n.selector&&(i=!0),i===!0&&null!=n.filters)for(var s,u=0,a=n.filters.length;a>u;u++)if(s=n.filters[u],l(e,s,t)===!1)return!1;return i}function s(e,n){if(null==n)return e;for(var t,r=[],o=0,i=e.length;i>o;o++)t=e[o],l(t,n)&&r.push(t);return r}function u(e,n,t){if(null==e)return t;if(null==t&&(t=[]),e instanceof Array){for(var r=0,o=e.length;o>r;r++)u(e[r],n,t);return t}l(e,n)&&t.push(e);var i=e[n.nextKey];return null!=i&&u(i,n,t),t}function a(e,t){var r={type:1,tagName:1,compoName:1,controller:1},o={parent:t};for(var i in e)1===r[i]&&(o[i]=e[i]);e.attr&&(o.attr=n({},e.attr));var l=e.nodes;if(null!=l&&l.length>0){o.nodes=[];for(var s=l instanceof Array,u=s===!0?l.length:1,c=0;u>c;c++)o.nodes[c]=a(s===!0?l[c]:l,o)}return o}function c(e){for(var n,t=e;null!=t;)n=t,t=t.nodes&&t.nodes[0];return n}function f(e,n,t,r){if(h.TEXTNODE===e.type)return"function"==typeof e.content?e.content("node",n,t,null,r):e.content;var o="";if(null!=e.nodes)for(var i,l=0,s=e.nodes.length;s>l;l++)i=e.nodes[l],o+=f(i,n,t,r);return o}function d(e){return this instanceof d==!1?new d(e):null==e?this:e.type===h.SET?e:this.add(e)}var h=e.Dom,p=e.render,g=e.parse,m=(global.Compo||e.Compo||Compo).signal.emitIn,v=function(){function e(e,t){return e===t?(n=!0,0):1}var n=!1;return function(t){var r,o,i,l;if(n=!1,t.sort(e),n===!1)return t;for(r=[],o=0,i=0,l=t.length-1;l>o;)t[o++]===t[o]&&(r[i++]=o);for(;i--;)t.splice(r[i],1);return t}}();return d.prototype={constructor:d,type:h.SET,length:0,components:null,add:function(e){var n,t;if("string"==typeof e&&(e=g(e)),e instanceof Array){for(n=0,t=e.length;t>n;n++)this.add(e[n]);return this}"function"==typeof e&&null!=e.prototype.type&&(e={controller:e,type:h.COMPONENT});var r=e.type;if(!r)return console.error("Only Mask Node/Component/NodeText/Fragment can be added to jmask set",e),this;if(r===h.FRAGMENT){var o=e.nodes;for(n=0,t=o.length;t>n;)this[this.length++]=o[n++];return this}if(r===h.CONTROLLER){if(null!=e.nodes&&e.nodes.length)for(n=e.nodes.length;0!==n;)e.nodes[--n].parent=e;null!=e.$&&(this.type=h.CONTROLLER)}return this[this.length++]=e,this},toArray:function(){return Array.prototype.slice.call(this)},render:function(e,n,t,r){if(this.components=[],1===this.length)return p(this[0],e,n,t,r||this);null==t&&(t=document.createDocumentFragment());for(var o=0,i=this.length;i>o;o++)p(this[o],e,n,t,r||this);return t},prevObject:null,end:function(){return this.prevObject||this},pushStack:function(e){var n;return n=d(e),n.prevObject=this,n},controllers:function(){return null==this.components&&console.warn("Set was not rendered"),this.pushStack(this.components||[])},mask:function(n){if(null!=n)return this.empty().append(n);if(arguments.length)return this;var t;if(0===this.length)t=new h.Node;else if(1===this.length)t=this[0];else{t=new h.Fragment;for(var r=0,o=this.length;o>r;r++)t.nodes[r]=this[r]}return e.stringify(t)},text:function(e,n,t){if("string"==typeof e){for(var r,o=[new h.TextNode(e)],i=0,l=this.length;l>i;i++)r=this[i],r.nodes=o;return this}for(var r,s="",i=0,l=this.length;l>i;i++)r=this[i],s+=f(r,e,n,t);return s}},t(["append","prepend"],function(e){d.prototype[e]=function(n){for(var t,r,o=d(n),i=0,l=this.length;l>i;i++){r=this[i],t=o.toArray();for(var s=0,u=t.length;u>s;s++)t[s].parent=r;r.nodes=null!=r.nodes?"append"===e?r.nodes.concat(t):t.concat(r.nodes):t}return this}}),t(["appendTo"],function(e){d.prototype[e]=function(e,n,t,r){return null==r&&(r=this),null!=e.nodeType&&"function"==typeof e.appendChild?(e.appendChild(this.render(n,t,null,r)),m(r,"domInsert"),this):(d(e).append(this),this)}}),function(){function e(e){for(var n,t,r=e.split(";"),o={},i=0,l=r.length;l>i;i++)t=r[i],n=t.indexOf(":"),o[t.substring(0,n).trim()]=t.substring(n+1).trim();return o}function r(e){var n=[],t=0;for(var r in e)n[t++]=r+":"+e[r];return n.join(";")}t(["add","remove","toggle","has"],function(e){d.prototype[e+"Class"]=function(n){var t,r,o,i,l,s=this.length,u=0;if("string"!=typeof n){if("remove"===e)for(;s>u;u++)this[0].attr["class"]=null;return this}for(;s>u;u++)if(i=this[u],null!=i.attr){if(l=i.attr["class"],null==l)l=n;else{for(l=" "+l+" ",null==t&&(t=n.split(" "),o=t.length),r=0;o>r;r++)if(t[r]){var a=l.indexOf(" "+t[r]+" ")>-1;if("has"!==e)a!==!1||"add"!==e&&"toggle"!==e?a!==!0||"remove"!==e&&"toggle"!==e||(l=l.replace(" "+t[r]+" "," ")):l+=t[r]+" ";else if(a)return!0}l=l.trim()}"has"!==e&&(i.attr["class"]=l)}return"has"===e?!1:this}}),t(["attr","removeAttr","prop","removeProp"],function(e){d.prototype[e]=function(n,t){if(!n)return this;for(var r,o=this.length,i=0,l=arguments.length;o>i;i++)switch(r=this[i],e){case"attr":case"prop":if(1===l){if("string"==typeof n)return r.attr[n];for(var s in n)r.attr[s]=n[s]}else 2===l&&(r.attr[n]=t);break;case"removeAttr":case"removeProp":r.attr[n]=null}return this}}),n(d.prototype,{tag:function(e){if("string"==typeof e){for(var n=0,t=this.length;t>n;n++)this[n].tagName=e;return this}return this[0]&&this[0].tagName},css:function(n,t){var o,i,l,s=arguments.length,u=this.length,a=0;if(1===s&&"string"==typeof n)return 0===u?null:"string"==typeof this[0].attr.style?e(this[0].attr.style)[n]:null;for(;u>a;a++)if(l=this[a].attr.style,"function"!=typeof l){if(1===s&&"object"==typeof n){if(null==l){this[a].attr.style=r(n);continue}o=e(l);for(i in n)o[i]=n[i];this[a].attr.style=r(o)}if(2===s){if(null==l){this[a].attr.style=n+":"+t;continue}o=e(l),o[n]=t,this[a].attr.style=r(o)}}return this}})}(),n(d.prototype,{clone:function(){for(var e=[],n=0,t=this.length;t>n;n++)e[n]=a(this[0]);return d(e)},wrap:function(e){var n,t=d(e),r=[];if(0===t.length)return console.log("Not valid wrapper",e),this;for(var o=0,i=this.length;i>o;o++)n=i>0?t.clone():t,c(n[0]).nodes=[this[o]],r[o]=n[0],null!=this[o].parent&&(this[o].parent.nodes=r[o]);return d(r)},wrapAll:function(e){var n=d(e);return 0===n.length?(console.error("Not valid wrapper",e),this):(this.parent().mask(n),c(n[0]).nodes=this.toArray(),this.pushStack(n))}}),t(["empty","remove"],function(e){d.prototype[e]=function(){for(var n,t=0,o=this.length;o>t;t++)n=this[t],"empty"!==e?"remove"!==e||null!=n.parent&&r(n.parent.nodes,n):n.nodes=null;return this}}),n(d.prototype,{each:function(e){for(var n=0,t=this.length;t>n;n++)e(this[n],n);return this},eq:function(e){return-1===e?this.slice(e):this.slice(e,e+1)},get:function(e){return 0>e?this[this.length-e]:this[e]},slice:function(){return this.pushStack(Array.prototype.slice.apply(this,arguments))}}),t(["filter","children","closest","parent","find","first","last"],function(e){d.prototype[e]=function(n){var t,r,i,a=[],c=null==n?null:o(n,this.type,"closest"===e?"up":"down");switch(e){case"filter":return d(s(this,c));case"children":for(t=0,i=this.length;i>t;t++)r=this[t],null!=r.nodes&&(a=a.concat(null==c?r.nodes:s(r.nodes,c)));break;case"parent":for(t=0,i=this.length;i>t;t++)r=this[t].parent,!r||r.type===h.FRAGMENT||c&&l(r,c)||a.push(r);v(a);break;case"closest":case"find":if(null==c)break;for(t=0,i=this.length;i>t;t++)u(this[t][c.nextKey],c,a);break;case"first":case"last":var f;for(t=0,i=this.length;i>t;t++)if(f="first"===e?t:i-t-1,r=this[f],null==c||l(r,c)){a[0]=r;break}}return this.pushStack(a)}}),d}(Mask);return Mask});